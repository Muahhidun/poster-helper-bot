# Fix bot error handling and invoice OCR support

## üìã Summary
This PR fixes critical issues preventing the bot from responding to messages and implements reliable invoice OCR using GPT-4 Vision instead of Google Cloud Document AI.

## üîß Problem Solved
1. **Bot –Ω–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è** - –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
2. **Bot –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è** - ImportError –≤ shipment_templates.py
3. **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –ø–∞–¥–∞–ª–æ** - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ C++ (libstdc++6)

## ‚úÖ Changes

### 1. Add global error handler (cb74ec0)
**bot.py:**
- –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π `error_handler()` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `authorized_only` —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –Ω–∞ None
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –±–æ–ª—å—à–µ –Ω–µ –º–æ–ª—á–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö ‚úÖ

### 2. Fix import error in shipment_templates (8658b6b)
**shipment_templates.py:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `create_poster_client` ‚Üí `get_poster_client`
- –£—Å—Ç—Ä–∞–Ω–µ–Ω ImportError –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ ‚úÖ

### 3. Switch to GPT-4 Vision for invoice OCR (eafcea7)
**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `invoice_ocr_gpt4_only.py` - –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –±–µ–∑ Document AI
- `RAILWAY_GRPC_FIX.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ troubleshooting

**bot.py:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `invoice_ocr_gpt4_only` –≤–º–µ—Å—Ç–æ `invoice_ocr`
- –£–±—Ä–∞–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç grpc –∏ Document AI

**nixpacks.toml:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã apt –ø–∞–∫–µ—Ç—ã (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≤–µ—Ä–Ω–µ–º—Å—è –∫ Document AI)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –ù–∞–¥–µ–∂–Ω—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ Railway/Heroku
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

### 4. Add documentation (da78579, 86bfb32)
**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `TESTING_GUIDE.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- `RAILWAY_GRPC_FIX.md` - —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å gRPC

## üß™ Testing

–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ Railway:
- ‚úÖ Bot starts without errors
- ‚úÖ Bot responds to text messages
- ‚úÖ Bot responds to photo messages
- ‚úÖ Error handler shows errors to users
- ‚úÖ Invoice OCR works with GPT-4 Vision
- ‚úÖ Text-based supply creation works

## üìä Technical Details

### Before (Document AI + GPT-4):
```python
# Two-step process
1. Document AI OCR —á–∏—Ç–∞–µ—Ç —Ç–µ–∫—Å—Ç (—Ç—Ä–µ–±—É–µ—Ç grpc + libstdc++6) ‚ùå
2. GPT-4 –ø–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –≤ JSON
```

### After (GPT-4 Vision only):
```python
# One-step process
1. GPT-4 Vision —á–∏—Ç–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ ‚úÖ
   - No system dependencies
   - Works everywhere
```

## üí∞ Trade-offs

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üéØ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ C++
- üöÄ –ü—Ä–æ—â–µ deployment
- üì¶ –ú–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- üåç –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ

**–ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã:**
- üíµ –ù–µ–º–Ω–æ–≥–æ –¥–æ—Ä–æ–∂–µ (GPT-4 Vision –≤–º–µ—Å—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ OCR)
- üìä –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º –¥–ª—è –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö
- ü§ñ –û–¥–Ω–∞ –º–æ–¥–µ–ª—å –¥–µ–ª–∞–µ—Ç OCR –∏ –ø–∞—Ä—Å–∏–Ω–≥

## üöÄ Deployment

–ü–æ—Å–ª–µ merge Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º —Å grpc
2. –ó–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç –±–µ–∑ ImportError
3. –û–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–æ—Ç–æ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —á–µ—Ä–µ–∑ GPT-4 Vision

### 4. Fix beverage matching logic (7222a66)
**bot.py (lines 1707-1739):**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∞–ø–∏—Ç–∫–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–∫–æ–ª–∞, —Å–ø—Ä–∞–π—Ç, —Ñ–∞–Ω—Ç–∞, –∫–≤–∞—Å, —Å–æ–∫, –∏ —Ç.–¥.)
- –î–ª—è –Ω–∞–ø–∏—Ç–∫–æ–≤: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è —Ç–æ–≤–∞—Ä–∞–º (products) –ø—Ä–∏ —Ä–∞–≤–Ω—ã—Ö/–±–ª–∏–∑–∫–∏—Ö –æ—Ü–µ–Ω–∫–∞—Ö
- –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º)

**–ü—Ä–∏–º–µ—Ä:**
- ‚ùå –ë—ã–ª–æ: "–ö–æ–ª–∞ –ü–≠–¢ 1–ª" ‚Üí "–ö—Ä—ã—à–∫–∞ –∫–æ–ª–∞ —Å—Ç–∞–∫–∞–Ω" (–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç)
- ‚úÖ –°—Ç–∞–ª–æ: "–ö–æ–ª–∞ –ü–≠–¢ 1–ª" ‚Üí "–ö–æ–ª–∞ –ü–≠–¢ 1–ª—Ö12" (—Ç–æ–≤–∞—Ä)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç –Ω–∞–ø–∏—Ç–∫–æ–≤ (Coca-Cola) —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç —Ç–æ–≤–∞—Ä—ã ‚úÖ

## üìù Commits

```
7222a66 Fix beverage matching to prioritize products over ingredients
eafcea7 Switch to GPT-4 Vision only for invoice OCR
e136b11 Use apt packages for C++ libraries instead of nix
86bfb32 Update testing guide with gRPC library fix
f6f1278 Add system libraries for gRPC/Google Cloud Document AI
da78579 Add testing guide for bot deployment
8658b6b Fix import error in shipment_templates.py
cb74ec0 Add global error handler and improve bot error handling
```

## ‚úîÔ∏è Checklist

- [x] –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ Railway
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—Å Python –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–æ
- [x] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

**Ready to merge!** üéâ
