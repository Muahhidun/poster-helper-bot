# PLAN.md — Закрытие дня: Wizard на сайте

> Этот файл описывает план реализации единого flow "Закрытие дня" на сайте.
> Подробное описание текущего бизнес-флоу — см. **CLAUDE.md** → "Бизнес-флоу: Закрытие дня"

## Цель

Перенести весь процесс закрытия дня на сайт (Mini App), минимизировать ручные действия. Сайт знает все данные из бланков и может автоматически создавать переводы и корректировки.

---

## Архитектура: Wizard с 5 шагами

### Шаг 1: Закрытие Кафе

**UI:** Форма, похожая на текущий ShiftClosing, но для Кафе (без Halyk)

**Поля ввода:**
| Поле | Описание | Автозаполнение |
|------|----------|---------------|
| `cafe_kaspi` | Kaspi от Кафе | Вводится вручную (из банковского приложения) |
| `cafe_kaspi_couriers` | Kaspi курьеров Кафе | Вводит админ |
| `cafe_wolt` | Wolt Кафе | Из Poster API (dash.getTransactions для аккаунта Cafe) |
| `cafe_cash_bills` | Наличка бумажными | Вводит админ |
| `cafe_cash_coins` | Мелочь | Вводит админ |
| `cafe_shift_start` | Начало смены | Из Poster API (getCashShifts) |
| `cafe_expenses` | Расходы с кассы | Вводит админ |
| `cafe_cash_to_leave` | Оставить на смену | По умолчанию 15,000₸ |

**Зарплаты Кафе (в том же шаге):**
| Сотрудник | Расчёт | Ввод |
|-----------|--------|------|
| Сушист | Зависит от объёма | Вручную (сообщает админ) |
| Кассир | Зависит от объёма | Вручную (сообщает админ) |
| Повар | Всегда 10,000₸ | Предзаполнено, редактируемо |

**Расчёты:** Те же формулы что и в основном отделе, но без Halyk.

**Данные, которые передаются в Шаг 2:**
- `cafe_kaspi` → подставляется как `kaspi_cafe` в калькулятор основного отдела
- `cafe_kaspi_couriers` → для информации

**Кнопка:** "Кафе закрыто → Далее"

---

### Шаг 2: Закрытие основного отдела

**UI:** Текущий калькулятор ShiftClosing с доработками

**Изменения от текущей версии:**
- `kaspi_cafe` — **автоподставлено** из Шага 1 (readonly, но редактируемо)
- Все остальные поля — как сейчас
- Добавить информационный блок с данными Кафе (свёрнутый)

**Расчёты:** Без изменений (текущие формулы).

**Дополнительные данные для переводов (отображаются, но не вводятся):**
- Wolt основного — из ввода `wolt`
- Halyk основного — из ввода `halyk`
- Инкассация — рассчитывается

**Кнопка:** "Основной отдел закрыт → Далее"

---

### Шаг 3: Зарплаты основного отдела

**UI:** Перенос salary flow из Telegram-бота на сайт

**Блок "Кассиры":**
- Кнопки: **2 кассира** / **3 кассира**
- Имена: текстовые поля с автоподстановкой вчерашних имён (из таблицы `employees`)
- Рядом с каждым именем — рассчитанная зарплата (readonly)
- Поле "Аванс" рядом с каждым кассиром (по умолчанию 0) — итого = зарплата - аванс
- **Основной кассир (первый):** дополнительная строка "Надбавка за доставку"
  - Автоподсчёт: количество заказов на доставку × 100₸
  - Количество заказов — из Poster API
  - Редактируемое поле (если автоматический подсчёт неточен)

**Блок "Донерщик":**
- Время помощника: кнопки **10:00** / **12:00** / **14:00**
- Имена: донерщик и помощник (автоподстановка вчерашних)
- Рассчитанные зарплаты (readonly) с полем "Аванс"

**Блок "Итого зарплаты":**
- Таблица: Имя | Должность | Зарплата | Аванс | К выплате
- Итого к выплате

**Расчёт зарплат:**
- Используются существующие `cashier_salary.py` и `doner_salary.py`
- Новый endpoint: `GET /api/shift-closing/salaries/calculate` — принимает cashier_count, assistant_time, возвращает зарплаты
- Подсчёт доставок: `GET /api/shift-closing/delivery-orders-count` — возвращает количество заказов на доставку из Poster

**Кнопка:** "Создать транзакции зарплат → Далее"
- Вызывает `POST /api/shift-closing/salaries/create` с именами, суммами, авансами
- Создаёт транзакции в Poster через существующий код

---

### Шаг 4: Переводы (авто-генерация)

**UI:** Список переводов с чекбоксами и редактируемыми суммами

**Авто-генерируемые переводы:**

**Кафе:**
| Перевод | Со счёта | На счёт | Сумма | Источник данных |
|---------|----------|---------|-------|----------------|
| Инкассация Кафе | Инкассация (?) | Оставил в кассе (4) | `cafe_collection` | Рассчитано в Шаге 1 |
| Wolt Кафе | Каспий Пей (1) | Вольт (?) | `cafe_wolt` | Торговля Wolt Кафе из Poster |

**Основной отдел:**
| Перевод | Со счёта | На счёт | Сумма | Источник данных |
|---------|----------|---------|-------|----------------|
| Инкассация | Инкассация (?) | Оставил в кассе (4) | `collection` | Рассчитано в Шаге 2 |
| Kaspi → Wolt | Каспий Пей (1) | Вольт (?) | `wolt` | Введено в Шаге 2 |
| Kaspi → Halyk | Каспий Пей (1) | Halyk (2) | `halyk` | Введено в Шаге 2 |

**Дополнительно (если day_result != 0):**
| Ситуация | Действие | Тип |
|----------|----------|-----|
| Недостача (day_result < 0) | Создать расход на сумму недостачи | `type=0` (expense) |
| Излишек (day_result > 0) | Создать внесение на сумму излишка | `type=1` (income) |

**UI элементы:**
- Каждый перевод — строка с чекбоксом (включено/выключено)
- Сумма редактируемая (на случай корректировок)
- Предпросмотр: "Будет создано X переводов на сумму Y₸"

**Кнопка:** "Подтверждаю, создать переводы"
- Вызывает `POST /api/shift-closing/transfers` с массивом переводов
- Каждый перевод → `finance.createTransaction` с `type=2` (transfer)
- Недостача/излишек → `finance.createTransaction` с `type=0`/`type=1`

> **ВАЖНО:** Нужно уточнить ID счетов "Инкассация" и "Вольт" в Poster (их нет в текущем коде). Получить через `finance.getAccounts` API.

---

### Шаг 5: Сверка (опционально)

**UI:** Три блока (Наличные, Kaspi, Halyk) с индикаторами

**Для каждого источника:**
| Поле | Описание |
|------|----------|
| Сумма по счетам Poster | Автоматически: сумма балансов двух отделов |
| Фактический баланс | Ввод вручную (посчитанные деньги) |
| Разница | Авто-расчёт, цветовая индикация |

**Цветовая индикация:**
- Зелёный: разница < 500₸ (допустимая погрешность)
- Жёлтый: разница 500-2000₸ (стоит проверить)
- Красный: разница > 2000₸ (точно пропущена транзакция)

**Кнопка "Перейти к расходам"** — если красная разница, открывает страницу расходов с фильтром за сегодня

**Получение балансов:**
- Новый endpoint: `GET /api/shift-closing/account-balances`
- Использует `finance.getAccounts` или рассчитывает из транзакций за день

---

## Помощник по разнице безнала

**Отдельный функционал** (не часть wizard, но полезный):

- Блок на странице закрытия: "Разница безнала: +3,500₸"
- Кнопка "Показать чеки за сегодня"
- Список чеков из Poster API (`dash.getTransactions`) с суммами
- Подсветка чеков, сумма которых близка к разнице (±20%)
- Помогает быстрее найти чек, у которого нужно сменить метод оплаты
- Реализация: `GET /api/shift-closing/receipts?date=...` → список чеков с суммой и методом оплаты

---

## Новые API Endpoints (Backend)

| Endpoint | Метод | Назначение |
|----------|-------|-----------|
| `/api/shift-closing/cafe` | POST | Сохранение данных закрытия Кафе |
| `/api/shift-closing/cafe` | GET | Получение сохранённых данных Кафе за дату |
| `/api/shift-closing/salaries/calculate` | POST | Расчёт зарплат (cashier_count, assistant_time → суммы) |
| `/api/shift-closing/salaries/create` | POST | Создание транзакций зарплат в Poster |
| `/api/shift-closing/delivery-orders-count` | GET | Количество заказов на доставку за день |
| `/api/shift-closing/transfers` | POST | Создание переводов (инкассация, Kaspi→Wolt и т.д.) |
| `/api/shift-closing/account-balances` | GET | Текущие балансы финансовых счетов |
| `/api/shift-closing/receipts` | GET | Список чеков за день (для поиска разницы безнала) |

---

## Новые Frontend компоненты

```
mini_app/src/pages/
├── ShiftClosing.tsx          # Контейнер wizard с шагами
├── shift-closing/
│   ├── CafeClosingStep.tsx   # Шаг 1: Кафе
│   ├── MainClosingStep.tsx   # Шаг 2: Основной отдел (рефакторинг текущего)
│   ├── SalaryStep.tsx        # Шаг 3: Зарплаты
│   ├── TransfersStep.tsx     # Шаг 4: Переводы
│   ├── ReconciliationStep.tsx# Шаг 5: Сверка
│   └── ReceiptHelper.tsx     # Помощник по разнице безнала
```

---

## Новые таблицы БД

### `shift_closing_cafe`
Хранение данных закрытия Кафе (аналог `shift_closings` но для Кафе).

### `shift_salaries`
Хранение рассчитанных зарплат за дату:
- `date`, `telegram_user_id`
- `employee_name`, `role` (cashier/doner/assistant/sushi/cook)
- `calculated_salary`, `advance`, `final_amount`
- `poster_transaction_id`

### `shift_transfers`
Хранение переводов за дату:
- `date`, `telegram_user_id`
- `transfer_type` (collection/kaspi_wolt/kaspi_halyk/shortage/surplus)
- `department` (main/cafe)
- `amount`, `account_from_id`, `account_to_id`
- `poster_transaction_id`, `status` (pending/completed)

---

## Порядок реализации (по приоритету)

### Фаза 1: Авто-переводы (самая большая экономия времени)
1. Endpoint `POST /api/shift-closing/transfers` — создание переводов через Poster API
2. `TransfersStep.tsx` — UI со списком переводов и чекбоксами
3. Интеграция в текущий ShiftClosing после калькулятора
4. **Результат:** Вместо ручного создания 4-6 переводов — одна кнопка

### Фаза 2: Зарплаты на сайте
1. Endpoints для расчёта и создания зарплат
2. `SalaryStep.tsx` — UI с выбором кассиров, именами, авансами
3. Подсчёт доставок (надбавка основного кассира)
4. **Результат:** Зарплаты через сайт вместо Telegram-диалога, с бонусом за доставку и авансами

### Фаза 3: Кафе как отдельный шаг
1. `CafeClosingStep.tsx` — форма закрытия Кафе
2. Связь Кафе → основной (автоподстановка kaspi_cafe)
3. Зарплаты Кафе в том же шаге
4. **Результат:** Два отдела в одном интерфейсе, данные перетекают между шагами

### Фаза 4: Помощник по безналу
1. Endpoint для получения чеков за день
2. `ReceiptHelper.tsx` — список чеков с подсветкой
3. **Результат:** Быстрый поиск чека для коррекции метода оплаты

### Фаза 5: Авто-сверка
1. Endpoint для получения балансов счетов
2. `ReconciliationStep.tsx` — сравнение факт vs Poster
3. **Результат:** Мгновенная проверка, не забыта ли транзакция

---

## Открытые вопросы (нужно уточнить)

1. **ID счетов:** Какие ID у счетов "Инкассация" и "Вольт" в Poster? Нужно получить через `finance.getAccounts`
2. **Доставка:** Как отличить заказы на доставку в Poster API? Есть ли категория или тег?
3. **Кафе Poster данные:** Доступны ли данные Кафе через тот же аккаунт или нужен отдельный API-вызов?
4. **Зарплаты Кафе:** Есть ли таблица зарплат для сушиста/кассира Кафе (как для основного отдела), или всегда вводится вручную?
5. **Бланк:** Нужно ли генерировать печатный бланк закрытия смены (PDF) или достаточно копируемого текста для WhatsApp?
