# –°—Ç—Ä–∞–Ω–∏—Ü–∞ –†–∞—Å—Ö–æ–¥—ã ‚Äî –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è backend

> –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–≤—Å—é** backend-–ª–æ–≥–∏–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã "–†–∞—Å—Ö–æ–¥—ã" (`/expenses`).
> –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –≤–æ—Å—Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å –Ω—É–ª—è (aiohttp + PostgreSQL).
> –û–ø–∏—Å–∞–Ω–∏–µ UI/–¥–∏–∑–∞–π–Ω–∞ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤).

---

## 1. –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–†–∞—Å—Ö–æ–¥—ã" ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏. –û–Ω–∞:

1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ Poster POS-—Å–∏—Å—Ç–µ–º—ã –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î (—á–µ—Ä–Ω–æ–≤–∏–∫–∏)
2. **–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç** —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É –æ–ø–ª–∞—Ç—ã (Cash / Kaspi / Halyk)
3. **–ü–æ–∑–≤–æ–ª—è–µ—Ç** —Å–æ–∑–¥–∞–≤–∞—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, —É–¥–∞–ª—è—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –≤—Ä—É—á–Ω—É—é
4. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç** –Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ Poster
5. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç** —Å–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞ (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π vs Poster) –ø–æ –∫–∞–∂–¥–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É

### –û—Å–Ω–æ–≤–Ω–æ–π flow

```
Poster POS  ‚îÄ‚îÄsync‚îÄ‚îÄ‚ñ∫  expense_drafts (–ë–î)  ‚îÄ‚îÄdisplay‚îÄ‚îÄ‚ñ∫  UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                              ‚ñ≤                              ‚îÇ
                              ‚îÇ                              ‚ñº
                    —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ              —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / —É–¥–∞–ª–µ–Ω–∏–µ
                              ‚îÇ                              ‚îÇ
                              ‚îÇ         process              ‚îÇ
Poster POS  ‚óÑ‚îÄ‚îÄcreate_txn‚îÄ‚îÄ  expense_drafts  ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. –¢–∞–±–ª–∏—Ü–∞ –ë–î: `expense_drafts`

```sql
CREATE TABLE expense_drafts (
    id                    SERIAL PRIMARY KEY,
    telegram_user_id      BIGINT NOT NULL,
    amount                DECIMAL(12,2) NOT NULL,     -- –°—É–º–º–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
    poster_amount         REAL,                       -- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏–∑ Poster (readonly)
    description           TEXT NOT NULL,               -- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
    expense_type          TEXT NOT NULL DEFAULT 'transaction', -- 'transaction' | 'supply'
    category              TEXT,                        -- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞
    source                TEXT NOT NULL DEFAULT 'cash', -- 'cash' | 'kaspi' | 'halyk'
    account_id            INTEGER,                     -- ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å—á—ë—Ç–∞ –≤ Poster
    poster_account_id     INTEGER,                     -- –ö –∫–∞–∫–æ–º—É –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç—É Poster –æ—Ç–Ω–æ—Å–∏—Ç—Å—è
    poster_transaction_id TEXT,                        -- ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Poster (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
    is_income             INTEGER DEFAULT 0,           -- 1 = –¥–æ—Ö–æ–¥, 0 = —Ä–∞—Å—Ö–æ–¥
    completion_status     TEXT DEFAULT 'pending',      -- 'pending' | 'partial' | 'completed'
    status                TEXT NOT NULL DEFAULT 'pending', -- 'pending' | 'processed'
    created_at            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    processed_at          TIMESTAMP,
    FOREIGN KEY (telegram_user_id) REFERENCES users(telegram_user_id) ON DELETE CASCADE
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_expense_drafts_user_status ON expense_drafts(telegram_user_id, status);
CREATE INDEX idx_expense_drafts_poster_txn ON expense_drafts(poster_transaction_id);
```

### –î–≤–∞ –ø–æ–ª—è —Å—Ç–∞—Ç—É—Å–∞ (–í–ê–ñ–ù–û!)

| –ü–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏—è | –í–ª–∏—è–µ—Ç –Ω–∞ |
|------|-----------|----------|-----------|
| `status` | –í–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ | `pending` (–≤–∏–¥–∏–º), `processed` (—Å–∫—Ä—ã—Ç) | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è `get_expense_drafts()` |
| `completion_status` | –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Poster | `pending`, `partial`, `completed` | –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ UI |

**–ß–µ—Ä–Ω–æ–≤–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å `status=pending` (–≤–∏–¥–∏–º) –∏ `completion_status=completed` (—É–∂–µ –≤ Poster).** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –∑–Ω–∞—á–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ Poster –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è —Å–≤–µ—Ä–∫–∏.

### –î–≤–∞ –ø–æ–ª—è —Å—É–º–º—ã (–í–ê–ñ–ù–û!)

| –ü–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `amount` | –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å—É–º–º–∞ |
| `poster_amount` | –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏–∑ Poster (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è) |

–ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é –º–µ–Ω—è–ª `amount` (—Ç.–µ. `amount ‚â† poster_amount`), —Ç–æ `amount` **–ù–ï** –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `poster_amount`. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ–Ω—è–ª —Å—É–º–º—É ‚Äî –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –æ–±–∞ –ø–æ–ª—è.

### –§–æ—Ä–º–∞—Ç `poster_transaction_id`

–°–æ—Å—Ç–∞–≤–Ω–æ–π ID: `"{poster_account_id}_{poster_txn_id}"`, –Ω–∞–ø—Ä–∏–º–µ—Ä `"1_45678"`.
- `poster_account_id` ‚Äî ID –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞ (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã `poster_accounts`)
- `poster_txn_id` ‚Äî ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Poster API

–î–ª—è –ø–æ—Å—Ç–∞–≤–æ–∫ (supply): `"supply_{supply_number}"`, –Ω–∞–ø—Ä–∏–º–µ—Ä `"supply_12685"`.

---

## 3. API Endpoints

### 3.1 `GET /api/expenses` ‚Äî –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –¥–∞—Ç—É

**Query params:** `?date=YYYY-MM-DD` (default: —Å–µ–≥–æ–¥–Ω—è –ø–æ Asia/Almaty)

**–õ–æ–≥–∏–∫–∞:**

1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç **–≤—Å–µ** —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –∏–∑ –ë–î (`status="all"`)
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –¥–∞—Ç–µ: `str(draft.created_at)[:10] == selected_date`
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Poster API **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** –¥–ª—è –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–æ–≤:
   - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (`finance.getCategories`) ‚Äî **–∫—ç—à–∏—Ä—É—é—Ç—Å—è 5 –º–∏–Ω—É—Ç**
   - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ (`finance.getAccounts`) ‚Äî **–∫—ç—à–∏—Ä—É—é—Ç—Å—è 5 –º–∏–Ω—É—Ç**
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –¥–∞—Ç—É (`finance.getTransactions`) ‚Äî **–≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ**
4. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç `account_totals` ‚Äî –±–∞–ª–∞–Ω—Å –ø–æ —Ç–∏–ø–∞–º –∏–∑ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
5. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä–∫–∏ –∏–∑ `shift_reconciliation`

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
cache_key = f"cats_accs_{user_id}"
# –•—Ä–∞–Ω–∏—Ç: {'categories': [...], 'accounts': [...]}
# TTL: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)
# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è
```

**–†–∞—Å—á—ë—Ç `account_totals`:**
```python
account_totals = {'kaspi': 0, 'halyk': 0, 'cash': 0}
for acc in all_finance_accounts_from_all_poster_accounts:
    name = acc['name'].lower()  # –∏–ª–∏ acc['account_name']
    balance = float(acc['balance'] or 0) / 100  # —Ç–∏–π–∏–Ω—ã ‚Üí —Ç–µ–Ω–≥–µ

    if 'kaspi' in name:
        account_totals['kaspi'] += balance
    elif '—Ö–∞–ª—ã–∫' in name or 'halyk' in name:
        account_totals['halyk'] += balance
    elif '–æ—Å—Ç–∞–≤–∏–ª' in name:
        account_totals['cash'] += balance
```

> –°—É–º–º–∏—Ä—É–µ—Ç –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–æ–≤ **–∏–∑ –≤—Å–µ—Ö** –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–æ–≤ (Pizzburg + Pizzburg-cafe). –ë–∞–ª–∞–Ω—Å Poster –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ **—Ç–∏–π–∏–Ω–∞—Ö** (1/100 —Ç–µ–Ω–≥–µ).

**Response:**
```json
{
  "drafts": [
    {
      "id": 42,
      "amount": 1500.0,
      "poster_amount": 1500.0,
      "description": "–ú—ã–ª–æ",
      "expense_type": "transaction",
      "category": "–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
      "source": "cash",
      "account_id": 4,
      "poster_account_id": 1,
      "poster_transaction_id": "1_45678",
      "is_income": 0,
      "completion_status": "completed",
      "status": "pending",
      "created_at": "2026-02-27 12:30:00"
    }
  ],
  "categories": [
    {"category_id": "17", "category_name": "–ü–æ–≤–∞—Ä–∞", "type": "1", "poster_account_id": 1, "poster_account_name": "Pizzburg"}
  ],
  "accounts": [
    {"account_id": "4", "account_name": "–û—Å—Ç–∞–≤–∏–ª –≤ –∫–∞—Å—Å–µ", "balance": "2500000", "poster_account_id": 1, "poster_account_name": "Pizzburg"}
  ],
  "poster_accounts": [
    {"id": 1, "name": "Pizzburg", "is_primary": true},
    {"id": 2, "name": "Pizzburg-cafe", "is_primary": false}
  ],
  "poster_transactions": [
    {"transaction_id": "45678", "amount_from": "150000", "category_name": "–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã", "comment": "–ú—ã–ª–æ", "type": "0", "account_from_id": "4", "poster_account_id": 1}
  ],
  "account_totals": {"kaspi": 150000.0, "halyk": 50000.0, "cash": 25000.0}
}
```

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π:** –¢–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å `type == '1'` (—Ä–∞—Å—Ö–æ–¥–Ω—ã–µ). –¢–∏–ø `'0'` ‚Äî —ç—Ç–æ –ø–µ—Ä–µ–≤–æ–¥—ã, –∏—Ö –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.

---

### 3.2 `POST /api/expenses/sync-from-poster` ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ Poster

–ì–ª–∞–≤–Ω–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ ‚Äî –∏–º–ø–æ—Ä—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–∑ Poster –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** –Ω–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏).

**–õ–æ–≥–∏–∫–∞ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):**

#### –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: `finance.getTransactions(dateFrom, dateTo)` (—Ñ–æ—Ä–º–∞—Ç `YYYYMMDD`)
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞: `finance.getAccounts()`
- –ü–æ—Å—Ç—Ä–æ–∏—Ç—å `account_map = {str(acc.account_id): acc for acc in finance_accounts}`
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –∏–∑ –ë–î

#### –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```
–î–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ Poster:
‚îÇ
‚îú‚îÄ –ü–†–û–ü–£–°–¢–ò–¢–¨ –µ—Å–ª–∏ type == '2' (–ø–µ—Ä–µ–≤–æ–¥)
‚îú‚îÄ –ü–†–û–ü–£–°–¢–ò–¢–¨ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç: '–ø–µ—Ä–µ–≤–æ–¥', '–∫–∞—Å—Å–æ–≤—ã–µ —Å–º–µ–Ω—ã', '–∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü'
‚îÇ
‚îú‚îÄ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å composite ID: "{account_db_id}_{poster_txn_id}"
‚îÇ
‚îú‚îÄ –ò–∑–≤–ª–µ—á—å —Å—É–º–º—É: abs(float(amount_from –∏–ª–∏ amount)) / 100  (—Ç–∏–π–∏–Ω—ã ‚Üí —Ç–µ–Ω–≥–µ)
‚îú‚îÄ –û–ø–∏—Å–∞–Ω–∏–µ: comment (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ category_name
‚îÇ
‚îú‚îÄ –ù–ê–ô–¢–ò —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ poster_transaction_id
‚îÇ   (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞: composite "{acc_id}_{txn_id}" –∏ –ø—Ä–æ—Å—Ç–æ–π "{txn_id}")
‚îÇ
‚îú‚îÄ –ï—Å–ª–∏ –ù–ê–ô–î–ï–ù ‚Üí –û–ë–ù–û–í–ò–¢–¨:
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ –ï—Å–ª–∏ poster_amount –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (—Ä–∞–∑–Ω–∏—Ü–∞ >= 0.01):
‚îÇ   ‚îÇ   ‚îú‚îÄ –û–±–Ω–æ–≤–∏—Ç—å poster_amount = –Ω–æ–≤–∞—è —Å—É–º–º–∞ –∏–∑ Poster
‚îÇ   ‚îÇ   ‚îî‚îÄ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –º–µ–Ω—è–ª amount (amount ‚âà old_poster_amount):
‚îÇ   ‚îÇ       ‚îî‚îÄ –û–±–Ω–æ–≤–∏—Ç—å amount = –Ω–æ–≤–∞—è —Å—É–º–º–∞ —Ç–æ–∂–µ
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å description
‚îÇ   ‚îî‚îÄ ‚Üí updated_count++
‚îÇ
‚îú‚îÄ –ï—Å–ª–∏ —ç—Ç–æ –ü–û–°–¢–ê–í–ö–ê (regex: "–ü–æ—Å—Ç–∞–≤–∫–∞\s*[N#]\s*(\d+)"):
‚îÇ   ‚îú‚îÄ –ù–∞–π—Ç–∏ —á–µ—Ä–Ω–æ–≤–∏–∫ —Å poster_transaction_id = "supply_{–Ω–æ–º–µ—Ä}"
‚îÇ   ‚îú‚îÄ –ò–ª–∏ –Ω–∞–π—Ç–∏ –Ω–µ–∑–∞–ª–∏–Ω–∫–æ–≤–∞–Ω–Ω—ã–π supply draft —Å –ø–æ—Ö–æ–∂–µ–π —Å—É–º–º–æ–π (¬±1‚Ç∏)
‚îÇ   ‚îî‚îÄ ‚Üí –ü–†–û–ü–£–°–¢–ò–¢–¨ (–ø–æ—Å—Ç–∞–≤–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ü–æ—Å—Ç–∞–≤–æ–∫)
‚îÇ
‚îî‚îÄ –ï—Å–ª–∏ –ù–ï –ù–ê–ô–î–ï–ù ‚Üí –°–û–ó–î–ê–¢–¨ –Ω–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫:
    ‚îú‚îÄ completion_status = 'completed' (—É–∂–µ –≤ Poster)
    ‚îú‚îÄ expense_type = 'transaction'
    ‚îú‚îÄ source = –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å—á—ë—Ç–∞ (—Å–º. –Ω–∏–∂–µ)
    ‚îú‚îÄ is_income = –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ —Ç–∏–ø—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å–º. –Ω–∏–∂–µ)
    ‚îú‚îÄ poster_amount = amount
    ‚îî‚îÄ ‚Üí synced_count++
```

#### –®–∞–≥ 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `source` (cash/kaspi/halyk)

```python
# –ò–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ—Ä—ë–º account_from_id
account_from_id = txn['account_from_id'] or txn['account_from']

# –ò—â–µ–º –≤ –∫–∞—Ä—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤
finance_acc = account_map[str(account_from_id)]
name = finance_acc['account_name'].lower()  # –∏–ª–∏ finance_acc['name']

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º source –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ –≤ –∏–º–µ–Ω–∏ —Å—á—ë—Ç–∞:
if 'kaspi' in name:
    source = 'kaspi'
elif '—Ö–∞–ª—ã–∫' in name or 'halyk' in name:
    source = 'halyk'
else:
    source = 'cash'  # default
```

#### –®–∞–≥ 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `is_income`

```python
is_income = (
    txn['type'] == '1'  # Poster —Ç–∏–ø = income
    or '–ø—Ä–∏—Ö–æ–¥' in category_name.lower()
    or '–ø–æ—Å—Ç—É–ø–ª–µ–Ω' in category_name.lower()
)
```

#### –®–∞–≥ 5: –û—á–∏—Å—Ç–∫–∞

1. **–£–¥–∞–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:** –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç `'–ø–µ—Ä–µ–≤–æ–¥'`, `'–∫–∞—Å—Å–æ–≤—ã–µ —Å–º–µ–Ω—ã'` –∏–ª–∏ `'–∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü'` ‚Üí —É–¥–∞–ª–∏—Ç—å.

2. **–£–¥–∞–ª–µ–Ω–∏–µ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤:** –ï—Å–ª–∏ `poster_transaction_id` —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Poster ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –≤ Poster ‚Üí —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫.
   - –¢–æ–ª—å–∫–æ –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Å `status='pending'`
   - –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞—Ç–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ = —Å–µ–≥–æ–¥–Ω—è
   - –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —á–µ—Ä–Ω–æ–≤–∏–∫, –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω (–Ω–µ —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π)
   - –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Å `poster_transaction_id` –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è –Ω–∞ `supply_`

**Response:**
```json
{
  "success": true,
  "synced": 5,
  "updated": 2,
  "deleted": 1,
  "skipped": 10,
  "errors": [],
  "message": "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –Ω–æ–≤—ã—Ö: 5, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: 2, —É–¥–∞–ª–µ–Ω–æ: 1, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: 10"
}
```

---

### 3.3 `POST /api/expenses` ‚Äî –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –≤—Ä—É—á–Ω—É—é

**Body:**
```json
{
  "amount": 1500,
  "description": "–ú—ã–ª–æ",
  "expense_type": "transaction",
  "category": "–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
  "source": "cash",
  "account_id": 4,
  "poster_account_id": 1
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ `poster_account_id` –Ω–µ —É–∫–∞–∑–∞–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å primary –∞–∫–∫–∞—É–Ω—Ç
2. –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –≤ –ë–î —Å `completion_status='pending'`
3. –í–µ—Ä–Ω—É—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç

**Response:**
```json
{"success": true, "id": 42}
```

---

### 3.4 `PUT /api/expenses/<draft_id>` ‚Äî –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫

**Body (–≤—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã):**
```json
{
  "amount": 2000,
  "description": "–ú—ã–ª–æ –∂–∏–¥–∫–æ–µ",
  "category": "–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
  "source": "kaspi",
  "account_id": 1,
  "poster_account_id": 1,
  "completion_status": "completed"
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- `amount`: 0 ‚Äî 100,000,000
- `description`: max 200 —Å–∏–º–≤–æ–ª–æ–≤
- `category`: max 50 —Å–∏–º–≤–æ–ª–æ–≤
- `source`: –æ–¥–Ω–æ –∏–∑ `cash`, `kaspi`, `halyk`
- `completion_status`: –æ–¥–Ω–æ –∏–∑ `pending`, `partial`, `completed`

**–õ–æ–≥–∏–∫–∞:** –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ (telegram_user_id).

---

### 3.5 `DELETE /api/expenses/<draft_id>` ‚Äî –£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫

–£–¥–∞–ª—è–µ—Ç –æ–¥–∏–Ω —á–µ—Ä–Ω–æ–≤–∏–∫. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞.

---

### 3.6 `POST /api/expenses/<draft_id>/toggle-type` ‚Äî –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–∏–ø

**Body:**
```json
{"expense_type": "supply"}
```

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ `supply`:
  - –°–æ–∑–¥–∞—ë—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–π `supply_draft` —Å `linked_expense_draft_id = draft_id`
  - –ö–æ–ø–∏—Ä—É–µ—Ç `supplier_name` = description, `total_sum` = amount, `source` = source
- –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ `transaction`:
  - –ù–∞—Ö–æ–¥–∏—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–π `supply_draft`

**Response:**
```json
{"success": true, "supply_draft_id": 15}
```

---

### 3.7 `POST /api/expenses/<draft_id>/completion-status` ‚Äî –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å

**Body:**
```json
{"completion_status": "completed"}
```

---

### 3.8 `POST /api/expenses/process` ‚Äî –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Poster

**Body:**
```json
{"draft_ids": [1, 2, 3]}
```

**–õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:**

1. –ù–∞–π—Ç–∏ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç –ø–æ `poster_account_id`
2. –°–æ–∑–¥–∞—Ç—å `PosterClient` –¥–ª—è —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
3. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
4. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á—ë—Ç** –ø–æ `source`:

```python
# –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å—á—ë—Ç –ø–æ –∏–º–µ–Ω–∏:
if source == 'kaspi':
    # —Å—á—ë—Ç —Å 'kaspi' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
elif source == 'halyk':
    # —Å—á—ë—Ç —Å '—Ö–∞–ª—ã–∫' –∏–ª–∏ 'halyk' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
else:  # cash
    # —Å—á—ë—Ç —Å '–∑–∞–∫—É–ø' –∏–ª–∏ '–æ—Å—Ç–∞–≤–∏–ª' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
# Fallback: –ø–µ—Ä–≤—ã–π —Å—á—ë—Ç –≤ —Å–ø–∏—Å–∫–µ
```

5. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
```python
txn_type = 1 if is_income else 0  # 0=expense, 1=income
```

6. **–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ Poster:**
```python
poster_client.create_transaction(
    transaction_type=txn_type,
    category_id=category_id,
    account_from_id=account_id,  # –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤—ã—à–µ –∏–∑ source
    amount=int(draft['amount']),  # –≤ —Ç–µ–Ω–≥–µ (–ù–ï –≤ —Ç–∏–π–∏–Ω–∞—Ö!)
    comment=draft['description']
)
```

7. –û–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫: `completion_status='completed'`, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `poster_transaction_id`

**Response:**
```json
{
  "success": true,
  "created": 3,
  "errors": [],
  "message": "–°–æ–∑–¥–∞–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 3"
}
```

---

### 3.9 `GET /api/poster-transactions` ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ Poster (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)

–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–µ–∂–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ Poster **–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ë–î** ‚Äî –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI —Ä—è–¥–æ–º —Å —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º–∏.

**–õ–æ–≥–∏–∫–∞:**
1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ): —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ + —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞
2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å `type != '0' and type != '1'`, –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å "–ø–µ—Ä–µ–≤–æ–¥"
3. –§–æ—Ä–º–∞—Ç ID: `"{account_db_id}_{txn_id}"`
4. –°—É–º–º–∞: `abs(float(amount_from)) / 100` (—Ç–∏–π–∏–Ω—ã ‚Üí —Ç–µ–Ω–≥–µ)

**Response:**
```json
{
  "success": true,
  "transactions": [
    {
      "id": "1_45678",
      "poster_account_id": 1,
      "poster_account_name": "Pizzburg",
      "transaction_id": 45678,
      "amount": 1500.0,
      "description": "–ú—ã–ª–æ",
      "category": "–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
      "account_id": 4,
      "account_name": "–û—Å—Ç–∞–≤–∏–ª –≤ –∫–∞—Å—Å–µ",
      "type": "0",
      "is_income": false
    }
  ],
  "date": "20260227",
  "count": 15
}
```

---

### 3.10 `GET /api/shift-reconciliation` ‚Äî –î–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä–∫–∏

**Query params:** `?date=YYYY-MM-DD`

**Response:**
```json
{
  "date": "2026-02-27",
  "reconciliation": {
    "cash": {"fact_balance": 25000, "total_difference": -500, "notes": ""},
    "kaspi": {"fact_balance": 150000, "total_difference": 0, "notes": null},
    "halyk": {"fact_balance": null, "total_difference": null, "notes": null}
  }
}
```

---

### 3.11 `POST /api/shift-reconciliation` ‚Äî –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–µ—Ä–∫—É

**Body:**
```json
{
  "source": "cash",
  "fact_balance": 25000,
  "total_difference": -500,
  "notes": "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç 500‚Ç∏",
  "date": "2026-02-27"
}
```

**–õ–æ–≥–∏–∫–∞:** UPSERT –ø–æ –∫–ª—é—á—É `(telegram_user_id, date, source)`. –ü–æ–ª–µ `fact_balance` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ `opening_balance` —Ç–∞–±–ª–∏—Ü—ã `shift_reconciliation`.

---

### 3.12 `GET /api/expense-report` ‚Äî –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç—á—ë—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–≤ —Å—Ç–∏–ª–µ Telegram-—Å–æ–æ–±—â–µ–Ω–∏—è).

**Response:**
```json
{
  "success": true,
  "report": "–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã 27.02\n\n–ö–∞—Å–ø–∏–π\n- [x] 1500 –ú—ã–ª–æ\n- [x] 4100 –†–µ–∫–ª–∞–º–∞\n–ò—Ç–æ–≥–æ -5600\n\n–ù–∞–ª–∏—á–Ω—ã–µ\n- [x] 700 –§–∞—Ä—à\n–†–∞—Å—Ö–æ–¥: -700, –ü—Ä–∏—Ö–æ–¥: +0\n–ò—Ç–æ–≥–æ -700\n\n–•–∞–ª—ã–∫\n–ü—É—Å—Ç–æ\n\n–í—Å–µ–≥–æ: -6300‚Ç∏",
  "date": "2026-02-27",
  "counts": {"cash": 3, "kaspi": 2, "halyk": 0}
}
```

**–§–æ—Ä–º–∞—Ç –æ—Ç—á—ë—Ç–∞:**
```
–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã DD.MM

–ö–∞—Å–ø–∏–π
- [x] {amount} {description}
- [x] +{amount} {description}    ‚Üê –¥–ª—è –¥–æ—Ö–æ–¥–æ–≤ —Å–æ –∑–Ω–∞–∫–æ–º +
–ò—Ç–æ–≥–æ -{total}

–ù–∞–ª–∏—á–Ω—ã–µ
- [x] {amount} {description}
–†–∞—Å—Ö–æ–¥: -{expense_total}, –ü—Ä–∏—Ö–æ–¥: +{income_total}
–ò—Ç–æ–≥–æ {net}

–•–∞–ª—ã–∫
- [x] ...
–ò—Ç–æ–≥–æ ...

–í—Å–µ–≥–æ: {grand_total}‚Ç∏
```

---

## 4. Poster API ‚Äî –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 4.1 `finance.getTransactions`

```
GET https://{account}.joinposter.com/api/finance.getTransactions?token={token}&dateFrom=YYYYMMDD&dateTo=YYYYMMDD
```

**Response (–º–∞—Å—Å–∏–≤):**
```json
[
  {
    "transaction_id": "45678",
    "type": "0",                    // 0=expense, 1=income, 2=transfer
    "category": "17",               // ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    "category_name": "–ü–æ–≤–∞—Ä–∞",
    "account_from_id": "4",         // ID —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å—á—ë—Ç–∞
    "account_from": "4",            // –¥—É–±–ª—å (–±—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –∏–∑ –¥–≤—É—Ö)
    "amount_from": "150000",        // –≤ –¢–ò–ô–ò–ù–ê–• (√∑100 = —Ç–µ–Ω–≥–µ)
    "amount": "150000",             // –¥—É–±–ª—å
    "date": "2026-02-27 12:00:00",
    "comment": "–ó–∞–≥–æ—Ç–æ–≤–∫–∞"
  }
]
```

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
- `type == '2'` ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–ø–µ—Ä–µ–≤–æ–¥)
- `category_name` —Å–æ–¥–µ—Ä–∂–∏—Ç `'–ø–µ—Ä–µ–≤–æ–¥'`, `'–∫–∞—Å—Å–æ–≤—ã–µ —Å–º–µ–Ω—ã'`, `'–∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü'` ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å

### 4.2 `finance.getAccounts`

```
GET .../finance.getAccounts?token={token}
```

**Response:**
```json
[
  {
    "account_id": "4",
    "account_name": "–û—Å—Ç–∞–≤–∏–ª –≤ –∫–∞—Å—Å–µ (–Ω–∞ –∑–∞–∫—É–ø—ã)",
    "type": "cash",
    "balance": "2500000",  // –≤ –¢–ò–ô–ò–ù–ê–•
    "currency_id": "1"
  },
  {
    "account_id": "1",
    "account_name": "Kaspi Pay",
    "type": "bank",
    "balance": "15000000"
  }
]
```

### 4.3 `finance.getCategories`

```
GET .../finance.getCategories?token={token}
```

**Response:**
```json
[
  {
    "category_id": "17",
    "category_name": "–ü–æ–≤–∞—Ä–∞",
    "type": "1"           // 1=—Ä–∞—Å—Ö–æ–¥–Ω–∞—è, 0=–ø–µ—Ä–µ–≤–æ–¥—ã
  }
]
```

**–§–∏–ª—å—Ç—Ä:** –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ `type == '1'` (—Ä–∞—Å—Ö–æ–¥–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏).

### 4.4 `finance.createTransactions`

```
POST .../finance.createTransactions?token={token}
Content-Type: application/json

{
  "type": 0,                    // 0=expense, 1=income, 2=transfer
  "category": 17,               // ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ù–ï –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤)
  "account_from": 4,            // ID —Å—á—ë—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
  "amount_from": 1500,          // –≤ –¢–ï–ù–ì–ï (–ù–ï –≤ —Ç–∏–π–∏–Ω–∞—Ö!)
  "user_id": "22",              // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Poster
  "date": "2026-02-27 12:00:00",
  "comment": "–ó–∞–≥–æ—Ç–æ–≤–∫–∞",
  "account_to": 5,              // —Ç–æ–ª—å–∫–æ –¥–ª—è type=2 (–ø–µ—Ä–µ–≤–æ–¥)
  "amount_to": 1500             // —Ç–æ–ª—å–∫–æ –¥–ª—è type=2
}
```

**Response:**
```json
{"response": 45679}   // ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

> **–í–ê–ñ–ù–û: –†–∞–∑–Ω–∏—Ü–∞ –µ–¥–∏–Ω–∏—Ü!**
> - `getTransactions` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—ã –≤ **—Ç–∏–π–∏–Ω–∞—Ö** (√∑100 = —Ç–µ–Ω–≥–µ)
> - `createTransactions` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—É–º–º—ã –≤ **—Ç–µ–Ω–≥–µ** (–ù–ï —É–º–Ω–æ–∂–∞—Ç—å –Ω–∞ 100!)

---

## 5. Poster Client ‚Äî –ú—É–ª—å—Ç–∏-–∞–∫–∫–∞—É–Ω—Ç

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞ (Pizzburg, Pizzburg-cafe) —Å–æ–∑–¥–∞—ë—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω—ã–π** `PosterClient` —Å –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ credentials:

```python
client = PosterClient(
    poster_token=account['poster_token'],
    poster_user_id=account['poster_user_id'],
    poster_base_url=account['poster_base_url']
)
```

Base URL —Ñ–æ—Ä–º–∞—Ç: `https://{account_name}.joinposter.com/api`

–ü—Ä–∏–º–µ—Ä—ã:
- Pizzburg: `https://pizz-burg.joinposter.com/api`
- Pizzburg-cafe: `https://pizzburg-cafe.joinposter.com/api`

**–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º:** –ó–∞–ø—Ä–æ—Å—ã –∫–æ –≤—Å–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞–º –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `asyncio.gather()`.

---

## 6. –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç —á–µ—Ä–µ–∑ APScheduler (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫).

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Poster-–∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ `POST /api/expenses/sync-from-poster`
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## 7. –¢–∞–±–ª–∏—Ü–∞ –ë–î: `shift_reconciliation`

```sql
CREATE TABLE shift_reconciliation (
    id                SERIAL PRIMARY KEY,
    telegram_user_id  BIGINT NOT NULL,
    date              DATE NOT NULL,
    source            TEXT NOT NULL,          -- 'cash', 'kaspi', 'halyk'
    opening_balance   REAL,                   -- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å (–≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    closing_balance   REAL,
    total_difference  REAL,                   -- –†–∞–∑–Ω–∏—Ü–∞ —Å Poster
    notes             TEXT,
    created_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at        TIMESTAMP,
    UNIQUE(telegram_user_id, date, source)
);
```

–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî **UPSERT** –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∫–ª—é—á—É `(telegram_user_id, date, source)`.

---

## 8. DB-–æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)

### 8.1 `create_expense_draft()`
```
–°–æ–∑–¥–∞—Ç—å –æ–¥–∏–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏.
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: telegram_user_id, amount, description, expense_type, category, source,
           account_id, poster_account_id, poster_transaction_id, is_income,
           completion_status, poster_amount
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: id —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
```

### 8.2 `get_expense_drafts(telegram_user_id, status="pending")`
```
–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
status="all" ‚Üí –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ status
status="pending" ‚Üí —Ç–æ–ª—å–∫–æ pending
ORDER BY created_at DESC
```

### 8.3 `get_expense_draft(draft_id)`
```
–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–¥–∏–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ ID (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞).
```

### 8.4 `update_expense_draft(draft_id, telegram_user_id=None, **kwargs)`
```
–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –ø–æ–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞.
–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏—Ç SET clause –∏–∑ kwargs.
telegram_user_id –≤ WHERE –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞).
```

### 8.5 `delete_expense_draft(draft_id, telegram_user_id=None)`
```
–£–¥–∞–ª–∏—Ç—å –æ–¥–∏–Ω —á–µ—Ä–Ω–æ–≤–∏–∫.
```

### 8.6 `delete_expense_drafts_bulk(draft_ids, telegram_user_id=None)`
```
–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ. DELETE WHERE id IN (...).
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö.
```

### 8.7 `get_expense_draft_by_poster_transaction_id(poster_transaction_id)`
```
–ü–æ–∏—Å–∫ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ø–æ poster_transaction_id (–¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏).
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"id": X} –∏–ª–∏ None.
```

### 8.8 `mark_drafts_in_poster(draft_ids)`
```
–ú–∞—Å—Å–æ–≤–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å completion_status='completed'.
–ù–ï –º–µ–Ω—è–µ—Ç status ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏.
```

### 8.9 `mark_drafts_processed(draft_ids)`
```
–ú–∞—Å—Å–æ–≤–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å status='processed', processed_at=now.
–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–≤–∏–¥–∏–º—ã–º–∏ –≤ default-—Ñ–∏–ª—å—Ç—Ä–µ.
```

---

## 9. –ë–∏–∑–Ω–µ—Å-–¥–µ–Ω—å –∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å

**–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:** Asia/Almaty (UTC+5)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "—Å–µ–≥–æ–¥–Ω—è":**
```python
import time

def kz_now():
    """–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ (UTC+5)"""
    t = time.time() + 5 * 3600
    return time.gmtime(t)
    # –ò–ª–∏ —á–µ—Ä–µ–∑ datetime: datetime.utcnow() + timedelta(hours=5)
```

**–ë–∏–∑–Ω–µ—Å-–¥–µ–Ω—å:** –î–æ 6:00 –ø–æ Asia/Almaty —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—á–µ—Ä–∞—à–Ω–∏–º –¥–Ω—ë–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã, –Ω–æ –ù–ï –≤ —Ä–∞—Å—Ö–æ–¥–∞—Ö ‚Äî —Ä–∞—Å—Ö–æ–¥—ã –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é –¥–∞—Ç—É).

**–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è Poster API:** `YYYYMMDD` (–±–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π)

---

## 10. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ UI (—ç–ª–µ–º–µ–Ω—Ç—ã)

> –¢–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –±–µ–∑ —Å—Ç–∏–ª–µ–π. –î–∏–∑–∞–π–Ω –¥–µ–ª–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.

### –®–∞–ø–∫–∞
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–†–∞—Å—Ö–æ–¥—ã" (–∏–ª–∏ "–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤")
- **–î–∞—Ç–∞-–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä:** —Å—Ç—Ä–µ–ª–∫–∞ ‚Üê (–ø—Ä–µ–¥. –¥–µ–Ω—å), –ø–æ–ª–µ –¥–∞—Ç—ã (input date), —Å—Ç—Ä–µ–ª–∫–∞ ‚Üí (—Å–ª–µ–¥. –¥–µ–Ω—å), –∫–Ω–æ–ø–∫–∞ "–°–µ–≥–æ–¥–Ω—è"
- –ü—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã ‚Üí –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

### –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π
- –ö–Ω–æ–ø–∫–∞ **"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å"** ‚Üí `POST /api/expenses/sync-from-poster`
- –ö–Ω–æ–ø–∫–∞ **"–°–æ–∑–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"** ‚Üí `POST /api/expenses/process` —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ `draft_ids`
- –ö–Ω–æ–ø–∫–∞ **"–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"** ‚Üí mass delete
- –ö–Ω–æ–ø–∫–∞ **"–ß–µ–∫–ª–∏—Å—Ç"** ‚Üí –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–≤–µ—Ä–∫–∏
- –°—á—ë—Ç—á–∏–∫: "–í—ã–±—Ä–∞–Ω–æ: X"

### –¢—Ä–∏ —Å–µ–∫—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º

–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ `source`: **Cash**, **Kaspi**, **Halyk**.

–ö–∞–∂–¥–∞—è —Å–µ–∫—Ü–∏—è:

**–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏:**
- –ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ + –∏–∫–æ–Ω–∫–∞
- –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞: Cash=–∑–µ–ª—ë–Ω—ã–π, Kaspi=–æ—Ä–∞–Ω–∂–µ–≤—ã–π, Halyk=—Å–∏–Ω–∏–π

**–°—Ç—Ä–æ–∫–∞ —Å–≤–µ—Ä–∫–∏:**
| –≠–ª–µ–º–µ–Ω—Ç | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| "–§–∞–∫—Ç:" | input (—á–∏—Å–ª–æ) | –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å (–≤–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `shift_reconciliation.opening_balance` |
| "Poster:" | readonly | –ë–∞–ª–∞–Ω—Å –∏–∑ `account_totals[source]` |
| "–†–∞–∑–Ω–∏—Ü–∞:" | readonly, —Ü–≤–µ—Ç | `fact_balance - poster_balance`. –ó–µ–ª—ë–Ω—ã–π –µ—Å–ª–∏ 0, –∫—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ ‚â†0 |

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ "–§–∞–∫—Ç:" ‚Üí `POST /api/shift-reconciliation` —Å `source` –∏ `fact_balance`. –°–µ—Ä–≤–µ—Ä —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç `total_difference` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç.

**–¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–æ–∫ (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏):**

| –≠–ª–µ–º–µ–Ω—Ç | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| –ß–µ–∫–±–æ–∫—Å | checkbox | –î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |
| –°—Ç–∞—Ç—É—Å | –∏–∫–æ–Ω–∫–∞ | ‚ö™ pending, üü° partial, ‚úÖ completed |
| –°—É–º–º–∞ | input (—á–∏—Å–ª–æ) | `amount`. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí `PUT /api/expenses/<id>` |
| –û–ø–∏—Å–∞–Ω–∏–µ | input (—Ç–µ–∫—Å—Ç) | `description`. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí `PUT /api/expenses/<id>` |
| –¢–∏–ø | –∫–Ω–æ–ø–∫–∞-toggle | `transaction` ‚Üî `supply`. –ö–ª–∏–∫ ‚Üí `POST /api/expenses/<id>/toggle-type` |
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | autocomplete | –ò–∑ —Å–ø–∏—Å–∫–∞ `categories`. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ ‚Üí `PUT /api/expenses/<id>` |
| –û—Ç–¥–µ–ª | badge/–∫–Ω–æ–ø–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞ (Pizzburg / Cafe). –ö–ª–∏–∫ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å |
| –£–¥–∞–ª–∏—Ç—å | –∫–Ω–æ–ø–∫–∞ | `DELETE /api/expenses/<id>` |

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤ —Å—Ç—Ä–æ–∫–µ:**
- –ï—Å–ª–∏ `amount ‚â† poster_amount` ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å badge "Poster: {poster_amount}‚Ç∏" (–∂—ë–ª—Ç—ã–π)
- –ï—Å–ª–∏ `is_income = 1` ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å badge "–ü—Ä–∏—Ö–æ–¥" –∏–ª–∏ –∑–Ω–∞–∫ + –ø–µ—Ä–µ–¥ —Å—É–º–º–æ–π
- –ï—Å–ª–∏ `expense_type = 'supply'` ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å badge "–ü–æ—Å—Ç–∞–≤–∫–∞"

**–ò—Ç–æ–≥–æ –ø–æ —Å–µ–∫—Ü–∏–∏:** —Å—É–º–º–∞ –≤—Å–µ—Ö `amount` –≤ —Å–µ–∫—Ü–∏–∏ (–¥–æ—Ö–æ–¥—ã —Å–æ –∑–Ω–∞–∫–æ–º +, —Ä–∞—Å—Ö–æ–¥—ã —Å–æ –∑–Ω–∞–∫–æ–º -)

### –û–±—â–∏–π –∏—Ç–æ–≥

- –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: X
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: X, –ü–æ—Å—Ç–∞–≤–æ–∫: X
- –û–±—â–∞—è —Å—É–º–º–∞: X‚Ç∏

### –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ß–µ–∫–ª–∏—Å—Ç"

–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–π —Å–≤–µ—Ä–∫–∏ –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è.

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- –û–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏ (textarea)
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (Cash/Kaspi/Halyk):
  - –†–∞–∑–Ω–∏—Ü–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É (–∏–∑ `shift_reconciliation`)
  - –ó–∞–º–µ—Ç–∫–∏ (textarea) ‚Üí —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `shift_reconciliation.notes`
  - –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (–¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö)
- 5 –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫):
  - "–í—Å–µ —Å—É–º–º—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
  - "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã"
  - "–ü–æ—Å—Ç–∞–≤–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã"
  - "–ù–∞–ª–∏—á–Ω—ã–µ –ø–æ—Å—á–∏—Ç–∞–Ω—ã"
  - "–ë–µ–∑–Ω–∞–ª —Å–≤–µ—Ä–µ–Ω"
- –ö–Ω–æ–ø–∫–∞ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–ª–∏—Å—Ç" ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∫–æ–ø–∏—Ä—É–µ—Ç –≤ –±—É—Ñ–µ—Ä

---

## 11. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```
–ö—ç—à: in-memory dict
–ö–ª—é—á: "cats_accs_{user_id}"
–ó–Ω–∞—á–µ–Ω–∏–µ: {categories: [...], accounts: [...]}
TTL: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)

–ß—Ç–æ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è:
  ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (finance.getCategories) ‚Äî –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ
  ‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—á–µ—Ç–∞ (finance.getAccounts) ‚Äî –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ

–ß—Ç–æ –ù–ï –∫—ç—à–∏—Ä—É–µ—Ç—Å—è:
  ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (finance.getTransactions) ‚Äî –º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
  ‚ùå –ë–∞–ª–∞–Ω—Å—ã ‚Äî –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Å –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π (–Ω–æ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤–º–µ—Å—Ç–µ —Å–æ —Å—á–µ—Ç–∞–º–∏)
```

> **–ù—é–∞–Ω—Å:** –ë–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞ (`balance`) –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –æ—Ç–≤–µ—Ç–µ `getAccounts`. –ï—Å–ª–∏ –º—ã –∫—ç—à–∏—Ä—É–µ–º —Å—á–µ—Ç–∞ ‚Äî –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–º –¥–æ 5 –º–∏–Ω—É—Ç. –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ, —Ç.–∫. –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

---

## 12. –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏

### –†–∞—Å—Ö–æ–¥—ã ‚Üî –ü–æ—Å—Ç–∞–≤–∫–∏
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∏–ø–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –Ω–∞ `supply` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è `supply_draft` —Å `linked_expense_draft_id`
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ expense_draft ‚Üí `supply_draft.linked_expense_draft_id` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è NULL (ON DELETE SET NULL)
- –ü–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–∂–µ —Å–æ–∑–¥–∞—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Poster ‚Äî –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–Ω–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É "–ü–æ—Å—Ç–∞–≤–∫–∞ N#XXXXX" –∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è

### –†–∞—Å—Ö–æ–¥—ã ‚Üî –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
- `shift_reconciliation` ‚Äî –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–∞—Å—Ö–æ–¥–æ–≤, –∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–º–µ–Ω—ã
- `account_totals` ‚Äî –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤–µ—Ä–∫–∏ –Ω–∞ –æ–±–µ–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

### –†–∞—Å—Ö–æ–¥—ã ‚Üî –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ê–≤—Ç–æ—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (12:00) —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ Poster ‚Üí –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–∞—Å—Ö–æ–¥–æ–≤
- –°—É–º–º—ã-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã (1‚Ç∏) –≤–∏–¥–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã ‚Üí –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ `poster_amount` –æ—Å—Ç–∞—ë—Ç—Å—è 1‚Ç∏, –∞ `amount` = —Ä–µ–∞–ª—å–Ω–∞—è —Å—É–º–º–∞

---

## 13. –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)

1. **–ë–î:** –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã `expense_drafts` –∏ `shift_reconciliation`
2. **Poster Client:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `get_transactions()`, `get_accounts()`, `get_categories()`, `create_transaction()`
3. **CRUD API:** `GET/POST/PUT/DELETE /api/expenses`
4. **Sync:** `POST /api/expenses/sync-from-poster` ‚Äî —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π endpoint
5. **Process:** `POST /api/expenses/process` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ Poster
6. **Reconciliation:** `GET/POST /api/shift-reconciliation`
7. **Report:** `GET /api/expense-report`
8. **Background sync:** –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
9. **UI:** –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫ API
