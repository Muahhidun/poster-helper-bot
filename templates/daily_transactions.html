{% extends "base.html" %}

{% block title %}Ежедневные транзакции{% endblock %}

{% block content %}
<div class="dt-page">
    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
        <h4 style="margin:0; font-weight: 700; color: #1f2937;">Ежедневные транзакции</h4>
        <button class="btn btn-success btn-sm" onclick="openAddModal()">+ Добавить</button>
    </div>
    <p class="text-muted" style="font-size:13px; margin-bottom:16px;">
        Транзакции создаются автоматически каждый день в 12:00. Здесь можно редактировать, отключать или добавлять новые.
    </p>

    <div class="table-responsive">
        <table class="table table-hover" style="font-size:14px;" id="configTable">
            <thead>
                <tr style="background:#f8f9fa;">
                    <th style="width:5%">#</th>
                    <th style="width:18%">Категория</th>
                    <th style="width:15%">Счёт</th>
                    <th style="width:12%">Сумма</th>
                    <th style="width:20%">Комментарий</th>
                    <th style="width:10%">Тип</th>
                    <th style="width:8%">Вкл</th>
                    <th style="width:12%">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for c in configs %}
                <tr id="row-{{ c.id }}" class="{% if not c.is_enabled %}table-secondary{% endif %}">
                    <td class="text-muted">{{ loop.index }}</td>
                    <td>
                        <span class="fw-medium">{{ c.category_name or '—' }}</span>
                    </td>
                    <td>
                        <span class="text-muted" style="font-size:12px;">{{ c.account_from_name or ('ID ' + c.account_from_id|string) }}</span>
                        {% if c.transaction_type == 2 and c.account_to_name %}
                        <br><span style="font-size:11px;">→ {{ c.account_to_name }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="fw-bold {% if c.amount > 1 %}text-danger{% endif %}">
                            {{ '{:,}'.format(c.amount).replace(',', ' ') }}₸
                        </span>
                    </td>
                    <td>{{ c.comment or '—' }}</td>
                    <td>
                        {% if c.transaction_type == 2 %}
                        <span class="badge bg-info">Перевод</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Расход</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox"
                                   id="toggle-{{ c.id }}"
                                   {% if c.is_enabled %}checked{% endif %}
                                   onchange="toggleConfig({{ c.id }}, this.checked)">
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm me-1" onclick="openEditModal({{ c.id }})" title="Редактировать">
                            &#9998;
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteConfig({{ c.id }})" title="Удалить">
                            &times;
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% if not configs %}
                <tr><td colspan="8" class="text-center text-muted py-4">Нет настроенных транзакций</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="txModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Добавить транзакцию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId" value="">

                <div class="mb-3">
                    <label class="form-label fw-medium">Тип</label>
                    <select id="fTransactionType" class="form-select" onchange="onTypeChange()">
                        <option value="0">Расход</option>
                        <option value="2">Перевод</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-medium">Категория</label>
                    <select id="fCategoryId" class="form-select">
                        <option value="0">— выберите —</option>
                    </select>
                </div>
                <div class="mb-3" id="catNameRow" style="display:none;">
                    <label class="form-label fw-medium">Название категории (вручную)</label>
                    <input type="text" id="fCategoryName" class="form-control" placeholder="Например: Повара">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-medium">Счёт (откуда)</label>
                    <select id="fAccountFromId" class="form-select">
                        <option value="4">Оставил в кассе (ID 4)</option>
                        <option value="1">Каспи Пей (ID 1)</option>
                    </select>
                </div>

                <div class="mb-3" id="accountToRow" style="display:none;">
                    <label class="form-label fw-medium">Счёт (куда)</label>
                    <select id="fAccountToId" class="form-select">
                        <option value="">— нет —</option>
                        <option value="5">Деньги дома (ID 5)</option>
                        <option value="4">Оставил в кассе (ID 4)</option>
                        <option value="1">Каспи Пей (ID 1)</option>
                    </select>
                </div>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label fw-medium">Сумма (₸)</label>
                        <input type="number" id="fAmount" class="form-control" min="1" value="1">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label fw-medium">Порядок</label>
                        <input type="number" id="fSortOrder" class="form-control" min="0" value="0">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-medium">Комментарий</label>
                    <input type="text" id="fComment" class="form-control" placeholder="Например: Заготовка">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-medium">Заведение</label>
                    <select id="fAccountName" class="form-select">
                        <option value="Pizzburg">Pizzburg</option>
                        <option value="Pizzburg-cafe">Pizzburg-cafe</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="saveConfig()">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var posterCategories = [];
var posterAccounts = [];
var modal = null;
var configsData = {{ configs | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    modal = new bootstrap.Modal(document.getElementById('txModal'));
    loadPosterData();
});

function loadPosterData() {
    fetch('/api/daily-transactions/poster-data')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            posterCategories = data.categories || [];
            posterAccounts = data.finance_accounts || [];
            populateCategoryDropdown();
            populateAccountDropdowns();
        })
        .catch(function(err) {
            console.error('Failed to load Poster data:', err);
        });
}

function populateCategoryDropdown() {
    var sel = document.getElementById('fCategoryId');
    sel.innerHTML = '<option value="0">— выберите (или введите вручную ниже) —</option>';
    posterCategories.forEach(function(cat) {
        var opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name + ' (ID ' + cat.id + ')';
        sel.appendChild(opt);
    });
}

function populateAccountDropdowns() {
    var fromSel = document.getElementById('fAccountFromId');
    var toSel = document.getElementById('fAccountToId');

    fromSel.innerHTML = '';
    toSel.innerHTML = '<option value="">— нет —</option>';

    posterAccounts.forEach(function(acc) {
        var opt1 = document.createElement('option');
        opt1.value = acc.id;
        opt1.textContent = acc.name + ' (ID ' + acc.id + ')';
        fromSel.appendChild(opt1);

        var opt2 = document.createElement('option');
        opt2.value = acc.id;
        opt2.textContent = acc.name + ' (ID ' + acc.id + ')';
        toSel.appendChild(opt2);
    });
}

function onTypeChange() {
    var type = document.getElementById('fTransactionType').value;
    document.getElementById('accountToRow').style.display = (type === '2') ? 'block' : 'none';
    // Hide category for transfers
    document.getElementById('fCategoryId').closest('.mb-3').style.display = (type === '2') ? 'none' : 'block';
}

function openAddModal() {
    document.getElementById('editId').value = '';
    document.getElementById('modalTitle').textContent = 'Добавить транзакцию';
    document.getElementById('fTransactionType').value = '0';
    document.getElementById('fCategoryId').value = '0';
    document.getElementById('fCategoryName').value = '';
    document.getElementById('fAccountFromId').value = '4';
    document.getElementById('fAccountToId').value = '';
    document.getElementById('fAmount').value = '1';
    document.getElementById('fComment').value = '';
    document.getElementById('fSortOrder').value = '0';
    document.getElementById('fAccountName').value = 'Pizzburg';
    document.getElementById('catNameRow').style.display = 'none';
    onTypeChange();
    modal.show();
}

function openEditModal(id) {
    var cfg = configsData.find(function(c) { return c.id === id; });
    if (!cfg) return;

    document.getElementById('editId').value = id;
    document.getElementById('modalTitle').textContent = 'Редактировать транзакцию';
    document.getElementById('fTransactionType').value = String(cfg.transaction_type);
    document.getElementById('fAmount').value = cfg.amount;
    document.getElementById('fComment').value = cfg.comment || '';
    document.getElementById('fSortOrder').value = cfg.sort_order || 0;
    document.getElementById('fAccountName').value = cfg.account_name || 'Pizzburg';

    // Set category
    var catSel = document.getElementById('fCategoryId');
    var catFound = false;
    for (var i = 0; i < catSel.options.length; i++) {
        if (parseInt(catSel.options[i].value) === cfg.category_id) {
            catSel.value = cfg.category_id;
            catFound = true;
            break;
        }
    }
    if (!catFound && cfg.category_id > 0) {
        catSel.value = '0';
    }
    // Show manual name field if category_id is 0 (auto-detected) or not in list
    if (cfg.category_id === 0 || !catFound) {
        document.getElementById('catNameRow').style.display = 'block';
        document.getElementById('fCategoryName').value = cfg.category_name || '';
    } else {
        document.getElementById('catNameRow').style.display = 'none';
    }

    // Set accounts
    document.getElementById('fAccountFromId').value = cfg.account_from_id;
    if (cfg.account_to_id) {
        document.getElementById('fAccountToId').value = cfg.account_to_id;
    } else {
        document.getElementById('fAccountToId').value = '';
    }

    onTypeChange();
    modal.show();
}

// Show/hide manual category name when category dropdown changes
document.getElementById('fCategoryId').addEventListener('change', function() {
    var catNameRow = document.getElementById('catNameRow');
    if (this.value === '0') {
        catNameRow.style.display = 'block';
    } else {
        catNameRow.style.display = 'none';
        // Auto-fill name from dropdown
        var selected = this.options[this.selectedIndex];
        if (selected) {
            document.getElementById('fCategoryName').value = selected.textContent.replace(/ \(ID \d+\)$/, '');
        }
    }
});

function saveConfig() {
    var editId = document.getElementById('editId').value;
    var txType = parseInt(document.getElementById('fTransactionType').value);
    var catId = parseInt(document.getElementById('fCategoryId').value);
    var catName = '';
    var catSel = document.getElementById('fCategoryId');
    if (catId > 0 && catSel.selectedIndex > 0) {
        catName = catSel.options[catSel.selectedIndex].textContent.replace(/ \(ID \d+\)$/, '');
    } else {
        catName = document.getElementById('fCategoryName').value.trim();
    }

    var accFromId = parseInt(document.getElementById('fAccountFromId').value);
    var accFromName = '';
    var fromSel = document.getElementById('fAccountFromId');
    if (fromSel.selectedIndex >= 0) {
        accFromName = fromSel.options[fromSel.selectedIndex].textContent.replace(/ \(ID \d+\)$/, '');
    }

    var accToId = document.getElementById('fAccountToId').value ? parseInt(document.getElementById('fAccountToId').value) : null;
    var accToName = '';
    if (accToId) {
        var toSel = document.getElementById('fAccountToId');
        if (toSel.selectedIndex >= 0) {
            accToName = toSel.options[toSel.selectedIndex].textContent.replace(/ \(ID \d+\)$/, '');
        }
    }

    var data = {
        transaction_type: txType,
        category_id: txType === 2 ? 0 : catId,
        category_name: txType === 2 ? 'Перевод' : catName,
        account_from_id: accFromId,
        account_from_name: accFromName,
        account_to_id: accToId,
        account_to_name: accToName || '',
        amount: parseInt(document.getElementById('fAmount').value) || 1,
        comment: document.getElementById('fComment').value.trim(),
        sort_order: parseInt(document.getElementById('fSortOrder').value) || 0,
        account_name: document.getElementById('fAccountName').value
    };

    var url = '/api/daily-transactions';
    var method = 'POST';
    if (editId) {
        url = '/api/daily-transactions/' + editId;
        method = 'PUT';
    }

    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            showToast(editId ? 'Транзакция обновлена' : 'Транзакция добавлена', 'success');
            modal.hide();
            setTimeout(function() { location.reload(); }, 500);
        } else {
            showToast(result.error || 'Ошибка', 'error');
        }
    })
    .catch(function(err) {
        showToast('Ошибка: ' + err.message, 'error');
    });
}

function toggleConfig(id, enabled) {
    fetch('/api/daily-transactions/' + id + '/toggle', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_enabled: enabled })
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            var row = document.getElementById('row-' + id);
            if (row) {
                row.className = enabled ? '' : 'table-secondary';
            }
            showToast(enabled ? 'Включено' : 'Отключено', 'success', 2000);
        } else {
            showToast(result.error || 'Ошибка', 'error');
        }
    })
    .catch(function(err) {
        showToast('Ошибка: ' + err.message, 'error');
    });
}

function deleteConfig(id) {
    if (!confirm('Удалить эту транзакцию?')) return;

    fetch('/api/daily-transactions/' + id, {
        method: 'DELETE'
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        if (result.success) {
            showToast('Удалено', 'success', 2000);
            var row = document.getElementById('row-' + id);
            if (row) row.remove();
        } else {
            showToast(result.error || 'Ошибка', 'error');
        }
    })
    .catch(function(err) {
        showToast('Ошибка: ' + err.message, 'error');
    });
}
</script>
{% endblock %}
