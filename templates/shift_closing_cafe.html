<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ account_name }} ‚Äî –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã</title>
    <style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#f2f2f7;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',system-ui,sans-serif;-webkit-text-size-adjust:100%}

.sc{max-width:480px;margin:0 auto;padding:8px 10px 24px}
.sc-title{text-align:center;font-size:15px;font-weight:700;color:#1c1c1e;padding:10px 0 4px}
.sc-title-sub{text-align:center;font-size:12px;color:#8e8e93;margin-bottom:6px}

.sc-dates{display:flex;gap:6px;overflow-x:auto;padding:6px 0 10px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.sc-dates::-webkit-scrollbar{display:none}
.sc-date-btn{flex-shrink:0;padding:6px 12px;border-radius:8px;border:1.5px solid #d1d1d6;background:#fff;cursor:pointer;text-align:center;min-width:70px;transition:all .15s}
.sc-date-btn.active{background:#007aff;border-color:#007aff;color:#fff}
.sc-date-btn.active .sc-date-btn-sub{color:rgba(255,255,255,.7)}
.sc-date-btn-date{display:block;font-size:13px;font-weight:600}
.sc-date-btn-sub{display:block;font-size:10px;color:#8e8e93;margin-top:1px}
.sc-date-btn.has-data::after{content:'';display:block;width:5px;height:5px;border-radius:50%;background:#34c759;margin:2px auto 0}
.sc-date-btn.active.has-data::after{background:rgba(255,255,255,.7)}

.sc-header{display:flex;justify-content:space-between;align-items:center;padding:6px 0;margin-bottom:4px}
.sc-date{font-size:17px;font-weight:700;color:#1c1c1e}
.sc-orders{font-size:13px;color:#8e8e93}

.sc-banner{background:#007aff20;color:#007aff;padding:8px 12px;border-radius:8px;text-align:center;font-size:13px;font-weight:500;margin-bottom:10px}
.sc-banner.hidden,.hidden{display:none !important}
.sc-banner.error{background:#ff3b3020;color:#ff3b30}
.sc-banner-readonly{background:#ff950020;color:#ff9500;display:flex;align-items:center;justify-content:center}
.sc-save-status{text-align:center;font-size:12px;color:#30d158;padding:4px;margin-bottom:6px;transition:opacity .3s}

.sc-card{background:#fff;border-radius:12px;padding:12px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.sc-card-title{font-size:13px;font-weight:600;color:#8e8e93;text-transform:uppercase;letter-spacing:.3px;margin-bottom:10px}
.sc-field{margin-bottom:8px}
.sc-field:last-child{margin-bottom:0}
.sc-field label{display:block;font-size:13px;color:#6c6c70;margin-bottom:3px;font-weight:500}
.sc-field input{width:100%;padding:10px 12px;border:1.5px solid #d1d1d6;border-radius:10px;font-size:17px;text-align:right;font-variant-numeric:tabular-nums;font-weight:600;color:#1c1c1e;background:#fff;-webkit-appearance:none;appearance:none;transition:border-color .15s}
.sc-field input:focus{outline:none;border-color:#007aff;box-shadow:0 0 0 3px rgba(0,122,255,.12)}
.sc-field input::placeholder{color:#c7c7cc}
.sc-field input[readonly]{background:#f2f2f7;color:#8e8e93}

.sc-plus label{color:#34c759}
.sc-plus input{border-color:#a8e6b4;color:#34c759}
.sc-plus input:focus{border-color:#34c759;box-shadow:0 0 0 3px rgba(52,199,89,.12)}

.sc-row-pair{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.sc-row-pair .sc-field{margin-bottom:0}

.sc-subtotal{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;background:#f2f2f7;margin-bottom:8px;font-size:15px;font-weight:600;color:#3a3a3c}
.sc-subtotal.accent{background:#007aff12}
.sc-subtotal.accent .sc-subtotal-num{color:#007aff}
.sc-subtotal.inside{margin:8px -4px -4px;border-radius:8px}
.sc-subtotal-num{font-variant-numeric:tabular-nums;font-size:17px;font-weight:700}

.sc-card-poster{background:#f9f9fb}
.sc-info-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:14px;color:#6c6c70}
.sc-info-val{font-variant-numeric:tabular-nums;font-weight:600;color:#1c1c1e;font-size:15px}
.sc-info-val.sc-red{color:#ff3b30}
.sc-info-sep{height:1px;background:#e5e5ea;margin:6px 0}
.sc-diff{border-radius:6px;padding:6px 8px}
.sc-diff.positive{background:#34c75920}
.sc-diff.positive .sc-info-val{color:#30d158}
.sc-diff.negative{background:#ff3b3015}
.sc-diff.negative .sc-info-val{color:#ff3b30}

.sc-day-result{text-align:center;padding:20px 12px;border-radius:14px;margin-bottom:8px;background:#f2f2f7;transition:background .2s}
.sc-day-result.positive{background:#34c75920}
.sc-day-result.negative{background:#ff3b3018}
.sc-day-result.zero{background:#007aff15}
.sc-day-label{font-size:11px;color:#8e8e93;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.sc-day-value{font-size:38px;font-weight:700;font-variant-numeric:tabular-nums;color:#3a3a3c;line-height:1.1}
.sc-day-result.positive .sc-day-value{color:#30d158}
.sc-day-result.negative .sc-day-value{color:#ff3b30}
.sc-day-result.zero .sc-day-value{color:#007aff}
.sc-day-status{font-size:14px;margin-top:4px;color:#8e8e93}
.sc-day-result.positive .sc-day-status{color:#30d158}
.sc-day-result.negative .sc-day-status{color:#ff3b30}
.sc-day-result.zero .sc-day-status{color:#007aff}

.sc-collection{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-radius:10px;background:#1c1c1e;margin-top:10px;font-size:16px;font-weight:700;color:#fff}
.sc-collection span:last-child{font-size:20px;font-variant-numeric:tabular-nums}
.sc-hint{text-align:center;font-size:11px;color:#aeaeb2;margin-top:2px}

.sc-actions{display:flex;gap:8px;margin-bottom:10px}
.sc-btn{flex:1;padding:10px 0;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer;background:#007aff;color:#fff;-webkit-appearance:none;transition:opacity .15s}
.sc-btn:active{opacity:.7}
.sc-btn-sec{background:#e5e5ea;color:#1c1c1e}
.sc-btn-sm{padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:#e5e5ea;color:#1c1c1e}
.sc-report{background:#1c1c1e;color:#e5e5ea;padding:12px;border-radius:8px;font-size:12px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;max-height:400px;overflow-y:auto;margin:0;font-family:'SF Mono','Menlo',monospace}
.loading{opacity:.5;pointer-events:none}

.sc-step-indicator{display:flex;justify-content:center;gap:8px;margin-bottom:12px}
.sc-step-dot{width:8px;height:8px;border-radius:50%;background:#d1d1d6;transition:background .2s}
.sc-step-dot.active{background:#007aff}
.sc-step-dot.done{background:#34c759}

.sc-salary-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e5e5ea}
.sc-salary-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.sc-salary-role{font-size:13px;font-weight:600;color:#8e8e93;margin-bottom:6px}
.sc-field input.sc-name-input{text-align:left;font-weight:500}

.sc-salary-total{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-radius:10px;background:#f2f2f7;margin-top:8px;font-size:16px;font-weight:700;color:#1c1c1e}
.sc-salary-total span:last-child{font-size:20px;font-variant-numeric:tabular-nums}

.sc-salary-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #e5e5ea}
.sc-salary-item:last-child{border-bottom:none}
.sc-salary-item-role{font-size:13px;color:#8e8e93}
.sc-salary-item-name{font-size:15px;font-weight:600;color:#1c1c1e}
.sc-salary-item-amount{font-size:17px;font-weight:700;color:#1c1c1e;font-variant-numeric:tabular-nums}

.sc-btn-full{display:block;width:100%;padding:14px 0;border-radius:12px;font-size:16px;font-weight:600;border:none;cursor:pointer;background:#007aff;color:#fff;-webkit-appearance:none;transition:opacity .15s;margin-bottom:8px}
.sc-btn-full:active{opacity:.7}
.sc-btn-full:disabled{opacity:.4;cursor:default}
.sc-btn-full.green{background:#34c759}

.sc-banner-sal{padding:10px 14px;border-radius:10px;text-align:center;font-size:14px;font-weight:500;margin-bottom:10px}
.sc-banner-sal.info{background:#007aff15;color:#007aff}
.sc-banner-sal.success{background:#34c75920;color:#30d158}
.sc-banner-sal.error{background:#ff3b3020;color:#ff3b30}

@media(max-width:374px){.sc{padding:6px 8px 20px}.sc-field input{font-size:16px;padding:9px 10px}.sc-day-value{font-size:32px}.sc-collection span:last-child{font-size:18px}}
    </style>
</head>
<body>
<div class="sc">
    <div class="sc-title">{{ account_name }}</div>
    <div class="sc-title-sub">–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã</div>

    <!-- Step indicator -->
    <div class="sc-step-indicator">
        <div class="sc-step-dot active" id="sdot1"></div>
        <div class="sc-step-dot" id="sdot2"></div>
    </div>

    <!-- ==================== SALARY STEP ==================== -->
    <div id="salary-step">
        <div id="sal-banner" class="sc-banner-sal hidden"></div>

        <div class="sc-card">
            <div class="sc-card-title">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>

            <div class="sc-salary-role">–ö–∞—Å—Å–∏—Ä</div>
            <div class="sc-salary-row">
                <div class="sc-field">
                    <label>–ò–º—è</label>
                    <input type="text" id="sal_cashier_name" class="sc-name-input" placeholder="–ò–º—è" autocomplete="off">
                </div>
                <div class="sc-field">
                    <label>–°—É–º–º–∞</label>
                    <input type="text" id="sal_cashier_amount" inputmode="decimal" placeholder="0" oninput="updateSalaryTotal()">
                </div>
            </div>

            <div class="sc-salary-role">–°—É—à–∏—Å—Ç</div>
            <div class="sc-salary-row">
                <div class="sc-field">
                    <label>–ò–º—è</label>
                    <input type="text" id="sal_sushi_name" class="sc-name-input" placeholder="–ò–º—è" autocomplete="off">
                </div>
                <div class="sc-field">
                    <label>–°—É–º–º–∞</label>
                    <input type="text" id="sal_sushi_amount" inputmode="decimal" placeholder="0" oninput="updateSalaryTotal()">
                </div>
            </div>

            <div class="sc-salary-role">–ü–æ–≤–∞—Ä –°–∞–Ω–¥–µ–π</div>
            <div class="sc-salary-row">
                <div class="sc-field">
                    <label>–ò–º—è</label>
                    <input type="text" id="sal_povar_name" class="sc-name-input" placeholder="–ò–º—è" autocomplete="off">
                </div>
                <div class="sc-field">
                    <label>–°—É–º–º–∞</label>
                    <input type="text" id="sal_povar_amount" inputmode="decimal" placeholder="0" oninput="updateSalaryTotal()">
                </div>
            </div>

            <div class="sc-salary-total">
                <span>–ò—Ç–æ–≥–æ</span>
                <span id="sal_total">0 ‚Ç∏</span>
            </div>
        </div>

        <button class="sc-btn-full" id="btnSalaryNext" onclick="createCafeSalaries()">–î–∞–ª–µ–µ</button>
    </div>

    <!-- ==================== SHIFT CLOSING STEP ==================== -->
    <div id="shift-closing-step" class="hidden">

    <!-- Date selector -->
    <div class="sc-dates" id="dates-bar">
        <button class="sc-date-btn active" id="btn-today">
            <span class="sc-date-btn-date" id="btn-today-label"></span>
            <span class="sc-date-btn-sub">—Å–µ–≥–æ–¥–Ω—è</span>
        </button>
    </div>

    <div class="sc-header">
        <span id="current-date" class="sc-date"></span>
        <span id="orders_info" class="sc-orders"></span>
    </div>

    <div class="sc-banner sc-banner-readonly hidden" id="readonly-banner">
        –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        <button type="button" class="sc-btn-sm" style="margin-left:8px" onclick="enableEdit()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="sc-banner" id="loading-banner">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- –ë–µ–∑–Ω–∞–ª -->
    <div class="sc-card">
        <div class="sc-card-title">–ë–µ–∑–Ω–∞–ª</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>Wolt</label>
                <input type="text" id="wolt" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
            <div class="sc-field">
                <label>Kaspi</label>
                <input type="text" id="kaspi" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
        </div>
        <div class="sc-field sc-plus">
            <label>+ Kaspi Pizzburg (–∫—É—Ä—å–µ—Ä—ã)</label>
            <input type="text" id="kaspi_pizzburg" inputmode="decimal" placeholder="0" oninput="onInput()">
        </div>
    </div>

    <!-- –ù–∞–ª–∏—á–Ω—ã–µ -->
    <div class="sc-card">
        <div class="sc-card-title">–ù–∞–ª–∏—á–Ω—ã–µ</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>–ë—É–º–∞–∂–Ω—ã–µ</label>
                <input type="text" id="cash_bills" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
            <div class="sc-field">
                <label>–ú–µ–ª–æ—á—å</label>
                <input type="text" id="cash_coins" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
        </div>
    </div>

    <div class="sc-subtotal" id="fact_total_row" style="display:none">
        <span>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π</span>
        <span id="fact_total_value" class="sc-subtotal-num">0</span>
    </div>

    <!-- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ -->
    <div class="sc-card">
        <div class="sc-card-title">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>–°–º–µ–Ω–∞ (–Ω–∞—á–∞–ª–æ)</label>
                <input type="text" id="shift_start" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
            <div class="sc-field">
                <label>–†–∞—Å—Ö–æ–¥—ã —Å –∫–∞—Å—Å—ã</label>
                <input type="text" id="expenses" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
        </div>
    </div>

    <div class="sc-subtotal accent" id="fact_adjusted_row" style="display:none">
        <span>–ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á.</span>
        <span id="fact_adjusted_value" class="sc-subtotal-num">0</span>
    </div>

    <!-- Poster -->
    <div class="sc-card sc-card-poster">
        <div class="sc-card-title">Poster</div>
        <div class="sc-info-row">
            <span>–ë–µ–∑–Ω–∞–ª —Ñ–∞–∫—Ç</span>
            <span id="poster_cashless" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row">
            <span>–ë–µ–∑–Ω–∞–ª Poster</span>
            <span id="poster_card_display" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row sc-diff" id="cashless_diff_row" style="display:none">
            <span>–†–∞–∑–Ω–∏—Ü–∞ –±–µ–∑–Ω–∞–ª</span>
            <span id="cashless_diff_value" class="sc-info-val">0</span>
        </div>
        <div class="sc-info-sep"></div>
        <div class="sc-info-row">
            <span>–¢–æ—Ä–≥–æ–≤–ª—è</span>
            <span id="poster_trade_display" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row">
            <span>–ë–æ–Ω—É—Å—ã</span>
            <span id="poster_bonus_display" class="sc-info-val sc-red">--</span>
        </div>
        <div class="sc-subtotal accent inside" id="poster_total_row" style="display:none">
            <span>–ò—Ç–æ–≥–æ Poster</span>
            <span id="poster_total_value" class="sc-subtotal-num">--</span>
        </div>
    </div>

    <!-- –ò–¢–û–ì–û –î–ï–ù–¨ -->
    <div class="sc-day-result" id="day_result_block">
        <div class="sc-day-label">–ò–¢–û–ì–û –î–ï–ù–¨</div>
        <div class="sc-day-value" id="day_result_value">--</div>
        <div class="sc-day-status" id="day_result_status"></div>
    </div>

    <!-- –ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è -->
    <div class="sc-card">
        <div class="sc-card-title">–ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è</div>
        <div class="sc-field">
            <label>–û—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–º–µ–Ω—É</label>
            <input type="text" id="cash_to_leave" inputmode="decimal" placeholder="10000" value="10000" oninput="onInput()">
        </div>
        <div class="sc-info-row" id="shift_left_row" style="display:none">
            <span>–°–º–µ–Ω–∞ –æ—Å—Ç–∞–≤–∏–ª–∏</span>
            <span id="shift_left_value" class="sc-info-val">0</span>
        </div>
        <div class="sc-hint" id="shift_left_hint" style="display:none"></div>
        <div class="sc-collection" id="collection_block" style="display:none">
            <span>–ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è</span>
            <span id="collection_value">0</span>
        </div>
    </div>

    <div class="sc-actions">
        <button type="button" class="sc-btn" onclick="loadPosterData()">–û–±–Ω–æ–≤–∏—Ç—å Poster</button>
        <button type="button" class="sc-btn sc-btn-sec" id="report-btn" onclick="loadShiftReport()">–û—Ç—á—ë—Ç —Å–º–µ–Ω—ã</button>
    </div>

    <div class="sc-save-status hidden" id="save-status">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

    <div id="report-container" style="display:none" class="sc-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="sc-card-title" style="margin:0">–û—Ç—á—ë—Ç –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã</div>
            <button type="button" class="sc-btn sc-btn-sm" id="copy-btn" onclick="copyReportAndTransfer()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <pre id="report-text" class="sc-report"></pre>
        <div id="transfer-status" class="hidden" style="margin-top:8px;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:500;text-align:center"></div>
    </div>

    </div><!-- /shift-closing-step -->
</div>

<script>
const API_BASE = '/api/cafe';
const USER_ROLE = '{{ user_role }}';
const IS_OWNER = USER_ROLE === 'owner';

let posterData = null;
let debounceTimer = null;
let saveTimer = null;
let lastCalc = null;
let currentDate = '';
let isReadonly = false;
let transfersCreated = false;
let salariesCreated = false;
const INPUT_IDS = ['wolt','kaspi','kaspi_pizzburg','cash_bills','cash_coins','shift_start','expenses','cash_to_leave'];
const USER_INPUT_IDS = ['wolt','kaspi','kaspi_pizzburg','cash_bills','cash_coins','expenses','cash_to_leave'];

// ==================== Salary Step ====================

function salPi(id) {
    var el = document.getElementById(id);
    if (!el) return 0;
    return parseFloat(el.value.replace(/\s/g, '').replace(/,/g, '.')) || 0;
}

function updateSalaryTotal() {
    var total = salPi('sal_cashier_amount') + salPi('sal_sushi_amount') + salPi('sal_povar_amount');
    document.getElementById('sal_total').textContent = fmt(total) + ' ‚Ç∏';
}

function showSalBanner(msg, type) {
    var b = document.getElementById('sal-banner');
    b.textContent = msg;
    b.className = 'sc-banner-sal ' + (type || 'info');
}

function hideSalBanner() {
    document.getElementById('sal-banner').className = 'sc-banner-sal hidden';
}

function goToShiftClosing() {
    document.getElementById('salary-step').classList.add('hidden');
    document.getElementById('shift-closing-step').classList.remove('hidden');
    document.getElementById('sdot1').classList.remove('active');
    document.getElementById('sdot1').classList.add('done');
    document.getElementById('sdot2').classList.add('active');
    window.scrollTo(0, 0);
    // Load shift closing data
    loadHistoryDates();
    loadDateData(currentDate);
}

async function loadLastEmployees() {
    try {
        var r = await fetch(API_BASE + '/employees/last');
        var d = await r.json();
        if (d.success && d.salaries) {
            d.salaries.forEach(function(s) {
                if (s.role === '–ö–∞—Å—Å–∏—Ä') {
                    document.getElementById('sal_cashier_name').value = s.name || '';
                    document.getElementById('sal_cashier_amount').value = s.amount || '';
                } else if (s.role === '–°—É—à–∏—Å—Ç') {
                    document.getElementById('sal_sushi_name').value = s.name || '';
                    document.getElementById('sal_sushi_amount').value = s.amount || '';
                } else if (s.role === '–ü–æ–≤–∞—Ä –°–∞–Ω–¥–µ–π') {
                    document.getElementById('sal_povar_name').value = s.name || '';
                    document.getElementById('sal_povar_amount').value = s.amount || '';
                }
            });
            updateSalaryTotal();
        }
    } catch(e) {
        console.error('Load employees error:', e);
    }
}

async function checkSalaryStatus() {
    try {
        var r = await fetch(API_BASE + '/salaries/status');
        var d = await r.json();
        if (d.success && d.salaries_created) {
            salariesCreated = true;
            goToShiftClosing();
        }
    } catch(e) {
        console.error('Salary status check error:', e);
    }
}

async function loadSalaryStatusForOwner() {
    try {
        var r = await fetch(API_BASE + '/salaries/status');
        var d = await r.json();
        if (d.success && d.salaries_created) {
            salariesCreated = true;
            // Show created salaries in the salary card
            if (d.salaries_data) {
                showCreatedSalaries(d.salaries_data);
            }
        }
    } catch(e) {
        console.error('Salary status check error:', e);
    }
}

function showCreatedSalaries(salaries) {
    var btn = document.getElementById('btnSalaryNext');
    btn.textContent = '–ó–∞—Ä–ø–ª–∞—Ç—ã —Å–æ–∑–¥–∞–Ω—ã';
    btn.disabled = true;
    btn.style.background = '#34c759';

    // Fill in the values from saved data
    salaries.forEach(function(s) {
        if (s.role === '–ö–∞—Å—Å–∏—Ä') {
            document.getElementById('sal_cashier_name').value = s.name || '';
            document.getElementById('sal_cashier_amount').value = s.amount || '';
        } else if (s.role === '–°—É—à–∏—Å—Ç') {
            document.getElementById('sal_sushi_name').value = s.name || '';
            document.getElementById('sal_sushi_amount').value = s.amount || '';
        } else if (s.role === '–ü–æ–≤–∞—Ä –°–∞–Ω–¥–µ–π') {
            document.getElementById('sal_povar_name').value = s.name || '';
            document.getElementById('sal_povar_amount').value = s.amount || '';
        }
    });
    updateSalaryTotal();

    // Make inputs readonly for owner view
    ['sal_cashier_name','sal_cashier_amount','sal_sushi_name','sal_sushi_amount','sal_povar_name','sal_povar_amount'].forEach(function(id) {
        document.getElementById(id).setAttribute('readonly', '');
    });
}

function resetSalaryForm() {
    // Reset button state
    var btn = document.getElementById('btnSalaryNext');
    btn.disabled = false;
    btn.style.background = '';
    btn.textContent = IS_OWNER ? '–°–æ–∑–¥–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—ã' : '–î–∞–ª–µ–µ';
    salariesCreated = false;

    // Clear readonly from inputs
    ['sal_cashier_name','sal_cashier_amount','sal_sushi_name','sal_sushi_amount','sal_povar_name','sal_povar_amount'].forEach(function(id) {
        document.getElementById(id).removeAttribute('readonly');
    });

    // Clear amounts, keep names empty for now
    ['sal_cashier_name','sal_cashier_amount','sal_sushi_name','sal_sushi_amount','sal_povar_name','sal_povar_amount'].forEach(function(id) {
        document.getElementById(id).value = '';
    });
    updateSalaryTotal();
}

async function loadSalaryDataForDate(date) {
    resetSalaryForm();

    // 1. Check if salaries already created for this date
    try {
        var r = await fetch(API_BASE + '/salaries/status?date=' + date);
        var d = await r.json();
        if (d.success && d.salaries_created) {
            salariesCreated = true;
            if (d.salaries_data) {
                showCreatedSalaries(d.salaries_data);
            }
            return;
        }
    } catch(e) {
        console.error('Salary status check error:', e);
    }

    // 2. No salaries for this date ‚Äî load last-used names (for convenience) but clear amounts
    try {
        var r2 = await fetch(API_BASE + '/employees/last');
        var d2 = await r2.json();
        if (d2.success && d2.salaries) {
            d2.salaries.forEach(function(s) {
                if (s.role === '–ö–∞—Å—Å–∏—Ä') {
                    document.getElementById('sal_cashier_name').value = s.name || '';
                } else if (s.role === '–°—É—à–∏—Å—Ç') {
                    document.getElementById('sal_sushi_name').value = s.name || '';
                } else if (s.role === '–ü–æ–≤–∞—Ä –°–∞–Ω–¥–µ–π') {
                    document.getElementById('sal_povar_name').value = s.name || '';
                }
            });
        }
    } catch(e) {
        console.error('Load employees error:', e);
    }
}

async function createCafeSalaries() {
    var cashierName = document.getElementById('sal_cashier_name').value.trim();
    var sushiName = document.getElementById('sal_sushi_name').value.trim();
    var povarName = document.getElementById('sal_povar_name').value.trim();
    var cashierAmt = salPi('sal_cashier_amount');
    var sushiAmt = salPi('sal_sushi_amount');
    var povarAmt = salPi('sal_povar_amount');

    if (!cashierName || !sushiName || !povarName) {
        showSalBanner('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –∏–º–µ–Ω–∞', 'error');
        return;
    }
    if (cashierAmt <= 0 && sushiAmt <= 0 && povarAmt <= 0) {
        showSalBanner('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—É–º–º—É', 'error');
        return;
    }

    hideSalBanner();
    var btn = document.getElementById('btnSalaryNext');
    btn.disabled = true;
    btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

    var salaries = [];
    if (cashierAmt > 0) salaries.push({role: '–ö–∞—Å—Å–∏—Ä', name: cashierName, amount: cashierAmt});
    if (sushiAmt > 0) salaries.push({role: '–°—É—à–∏—Å—Ç', name: sushiName, amount: sushiAmt});
    if (povarAmt > 0) salaries.push({role: '–ü–æ–≤–∞—Ä –°–∞–Ω–¥–µ–π', name: povarName, amount: povarAmt});

    try {
        var r = await fetch(API_BASE + '/salaries/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({salaries: salaries})
        });
        var d = await r.json();

        if (!d.success) {
            showSalBanner(d.error || '–û—à–∏–±–∫–∞', 'error');
            btn.disabled = false;
            btn.textContent = '–î–∞–ª–µ–µ';
            return;
        }

        if (d.warning) {
            showSalBanner(d.warning, 'error');
        }

        salariesCreated = true;
        goToShiftClosing();
    } catch(e) {
        showSalBanner('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = '–î–∞–ª–µ–µ';
    }
}

function fmt(n) { return Math.round(n).toLocaleString('ru-RU'); }

function pi(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    return parseFloat(el.value.replace(/\s/g, '').replace(/,/g, '.')) || 0;
}

function getTodayStr() {
    const now = new Date();
    const kz = new Date(now.getTime() + 5 * 3600000); // UTC+5 Asia/Almaty
    if (kz.getUTCHours() < 6) kz.setUTCDate(kz.getUTCDate() - 1);
    return kz.toISOString().slice(0, 10);
}

function fmtDateShort(s) { const p = s.split('-'); return p[2] + '.' + p[1]; }
function fmtDateFull(s) { const p = s.split('-'); return p[2] + '.' + p[1] + '.' + p[0]; }
function toPosterDate(s) { return s.replace(/-/g, ''); }

function lsKey(date) { return 'cafe_sc_' + date; }

function saveToLS() {
    const data = {};
    USER_INPUT_IDS.forEach(id => { data[id] = document.getElementById(id).value; });
    try { localStorage.setItem(lsKey(currentDate), JSON.stringify(data)); } catch(e) {}
}

function loadFromLS(date) {
    try {
        const raw = localStorage.getItem(lsKey(date));
        if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
}

function onInput() {
    if (isReadonly) return;
    saveToLS();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculate, 250);
}

function selectDate(date) {
    if (date === currentDate) return;
    currentDate = date;
    document.getElementById('current-date').textContent = fmtDateFull(date);
    document.querySelectorAll('.sc-date-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.date === date);
    });
    posterData = null;
    lastCalc = null;
    resetDisplay();
    document.getElementById('report-container').style.display = 'none';
    loadDateData(date);
    // Reload salary data for the selected date
    if (IS_OWNER) {
        loadSalaryDataForDate(date);
    }
}

function resetDisplay() {
    ['fact_total_row','fact_adjusted_row','cashless_diff_row','poster_total_row',
     'shift_left_row','shift_left_hint','collection_block'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    document.getElementById('day_result_value').textContent = '--';
    document.getElementById('day_result_status').textContent = '';
    document.getElementById('day_result_block').classList.remove('positive','negative','zero');
    ['poster_cashless','poster_card_display','poster_trade_display'].forEach(id => {
        document.getElementById(id).textContent = '--';
    });
    document.getElementById('poster_bonus_display').textContent = '--';
    document.getElementById('orders_info').textContent = '';
}

async function loadDateData(date) {
    const banner = document.getElementById('loading-banner');
    const readonlyBanner = document.getElementById('readonly-banner');
    banner.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    banner.classList.remove('hidden', 'error');
    readonlyBanner.classList.add('hidden');

    INPUT_IDS.forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('cash_to_leave').value = '10000';
    const isToday = date === getTodayStr();

    // Reset transfer state for new date
    transfersCreated = false;
    document.getElementById('transfer-status').classList.add('hidden');
    document.getElementById('copy-btn').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';

    // 1. Load saved data
    try {
        const r = await fetch(API_BASE + '/history?date=' + date);
        const d = await r.json();
        if (d.success && d.closing) {
            const c = d.closing;
            USER_INPUT_IDS.forEach(id => {
                if (c[id]) document.getElementById(id).value = c[id];
            });
            // Check if transfers were already created
            if (c.transfers_created) {
                transfersCreated = true;
                updateCopyBtn();
            }
            setReadonly(!isToday);
            saveToLS();
        } else {
            const ls = loadFromLS(date);
            if (ls) {
                USER_INPUT_IDS.forEach(id => {
                    if (ls[id]) document.getElementById(id).value = ls[id];
                });
            }
            setReadonly(false);
        }
    } catch(e) {
        const ls = loadFromLS(date);
        if (ls) {
            USER_INPUT_IDS.forEach(id => {
                if (ls[id]) document.getElementById(id).value = ls[id];
            });
        }
        setReadonly(false);
    }

    // 2. Load Poster data
    try {
        document.querySelector('.sc').classList.add('loading');
        const r = await fetch(API_BASE + '/poster-data?date=' + toPosterDate(date));
        const d = await r.json();

        if (d.success) {
            posterData = d;

            if (d.poster_prev_shift_left != null && d.poster_prev_shift_left !== 0) {
                document.getElementById('shift_start').value = String(Math.round(d.poster_prev_shift_left / 100));
            }

            document.getElementById('poster_trade_display').textContent = fmt(d.trade_total / 100);
            document.getElementById('poster_bonus_display').textContent = '-' + fmt(d.bonus / 100);
            document.getElementById('poster_card_display').textContent = fmt(d.poster_card / 100);
            document.getElementById('orders_info').textContent = d.transactions_count + ' –∑–∞–∫–∞–∑–æ–≤';

            // Auto-fill kaspi_pizzburg from main shift closing's kaspi_cafe (if available and field is empty)
            if (d.main_kaspi_cafe && !pi('kaspi_pizzburg')) {
                document.getElementById('kaspi_pizzburg').value = String(Math.round(d.main_kaspi_cafe));
                console.log('[CAFE SHIFT] kaspi_pizzburg auto-filled from main: ' + Math.round(d.main_kaspi_cafe));
            }

            banner.textContent = '–ì–æ—Ç–æ–≤–æ';
            setTimeout(() => banner.classList.add('hidden'), 1200);
            calculate();
        } else {
            banner.textContent = d.error || '–û—à–∏–±–∫–∞ Poster';
            banner.classList.add('error');
        }
    } catch(e) {
        banner.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Poster';
        banner.classList.add('error');
    } finally {
        document.querySelector('.sc').classList.remove('loading');
    }
}

function setReadonly(val) {
    isReadonly = val;
    const banner = document.getElementById('readonly-banner');
    if (val) {
        banner.classList.remove('hidden');
        INPUT_IDS.forEach(id => document.getElementById(id).setAttribute('readonly', ''));
    } else {
        banner.classList.add('hidden');
        INPUT_IDS.forEach(id => document.getElementById(id).removeAttribute('readonly'));
    }
}

function enableEdit() { setReadonly(false); }

async function loadPosterData() {
    const banner = document.getElementById('loading-banner');
    banner.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ Poster...';
    banner.classList.remove('hidden', 'error');
    try {
        document.querySelector('.sc').classList.add('loading');
        const isToday = currentDate === getTodayStr();
        const dateParam = isToday ? '' : '?date=' + toPosterDate(currentDate);
        const r = await fetch(API_BASE + '/poster-data' + dateParam);
        const d = await r.json();
        if (d.success) {
            posterData = d;
            document.getElementById('poster_trade_display').textContent = fmt(d.trade_total / 100);
            document.getElementById('poster_bonus_display').textContent = '-' + fmt(d.bonus / 100);
            document.getElementById('poster_card_display').textContent = fmt(d.poster_card / 100);
            document.getElementById('orders_info').textContent = d.transactions_count + ' –∑–∞–∫–∞–∑–æ–≤';

            // Refresh kaspi_pizzburg from main's kaspi_cafe
            if (d.main_kaspi_cafe !== undefined) {
                const mainVal = Math.round(d.main_kaspi_cafe);
                document.getElementById('kaspi_pizzburg').value = String(mainVal);
                console.log('[CAFE SHIFT] kaspi_pizzburg refreshed from main: ' + mainVal);
            }

            banner.textContent = '–ì–æ—Ç–æ–≤–æ';
            setTimeout(() => banner.classList.add('hidden'), 1200);
            calculate();
        } else {
            banner.textContent = d.error || '–û—à–∏–±–∫–∞';
            banner.classList.add('error');
        }
    } catch(e) {
        banner.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        banner.classList.add('error');
    } finally {
        document.querySelector('.sc').classList.remove('loading');
    }
}

async function calculate() {
    if (!posterData) return;
    try {
        const body = {
            wolt: pi('wolt'), kaspi: pi('kaspi'),
            kaspi_pizzburg: pi('kaspi_pizzburg'),
            cash_bills: pi('cash_bills'), cash_coins: pi('cash_coins'),
            shift_start: pi('shift_start'),
            expenses: pi('expenses'), cash_to_leave: pi('cash_to_leave'),
            poster_trade: posterData.trade_total,
            poster_bonus: posterData.bonus,
            poster_card: posterData.poster_card,
        };
        const r = await fetch(API_BASE + '/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const d = await r.json();
        if (d.success) {
            lastCalc = d.calculations;
            showCalc(d.calculations);
            scheduleSave(d.calculations);
        }
    } catch(e) {}
}

function showCalc(c) {
    document.getElementById('fact_total_row').style.display = 'flex';
    document.getElementById('fact_total_value').textContent = fmt(c.fact_total);
    document.getElementById('fact_adjusted_row').style.display = 'flex';
    document.getElementById('fact_adjusted_value').textContent = fmt(c.fact_adjusted);
    document.getElementById('poster_cashless').textContent = fmt(c.fact_cashless);

    const cdr = document.getElementById('cashless_diff_row');
    if (Math.abs(c.cashless_diff) >= 1) {
        cdr.style.display = 'flex';
        cdr.classList.remove('positive', 'negative');
        cdr.classList.add(c.cashless_diff > 0 ? 'positive' : 'negative');
        document.getElementById('cashless_diff_value').textContent = (c.cashless_diff > 0 ? '+' : '') + fmt(c.cashless_diff);
    } else { cdr.style.display = 'none'; }

    document.getElementById('poster_total_row').style.display = 'flex';
    document.getElementById('poster_total_value').textContent = fmt(c.poster_total);

    const dr = c.day_result;
    const bl = document.getElementById('day_result_block');
    const vl = document.getElementById('day_result_value');
    const st = document.getElementById('day_result_status');
    bl.classList.remove('positive', 'negative', 'zero');
    if (dr > 0) { bl.classList.add('positive'); vl.textContent = '+' + fmt(dr); st.textContent = '–∏–∑–ª–∏—à–µ–∫'; }
    else if (dr < 0) { bl.classList.add('negative'); vl.textContent = fmt(dr); st.textContent = '–Ω–µ–¥–æ—Å—Ç–∞—á–∞'; }
    else { bl.classList.add('zero'); vl.textContent = '0'; st.textContent = '–∏–¥–µ–∞–ª—å–Ω–æ'; }

    document.getElementById('shift_left_row').style.display = 'flex';
    document.getElementById('shift_left_value').textContent = fmt(c.shift_left);
    const h = document.getElementById('shift_left_hint');
    h.style.display = 'block';
    h.textContent = fmt(pi('cash_to_leave')) + ' + ' + fmt(pi('cash_coins')) + ' –º–µ–ª–æ—á—å';

    document.getElementById('collection_block').style.display = 'flex';
    document.getElementById('collection_value').textContent = fmt(c.collection);
}

function scheduleSave(calc) {
    if (isReadonly) return;
    const hasInput = pi('cash_bills') > 0 || pi('wolt') > 0 || pi('kaspi') > 0 || pi('kaspi_pizzburg') > 0;
    if (!hasInput) return;
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => doSave(calc), 1500);
}

async function doSave(calc) {
    const data = {
        date: currentDate,
        wolt: pi('wolt'), kaspi: pi('kaspi'),
        kaspi_pizzburg: pi('kaspi_pizzburg'),
        cash_bills: pi('cash_bills'), cash_coins: pi('cash_coins'),
        expenses: pi('expenses'), cash_to_leave: pi('cash_to_leave'),
        deposits: 0,
        fact_cashless: calc.fact_cashless, fact_total: calc.fact_total,
        fact_adjusted: calc.fact_adjusted, poster_total: calc.poster_total,
        day_result: calc.day_result, shift_left: calc.shift_left,
        collection: calc.collection, cashless_diff: calc.cashless_diff,
        transactions_count: posterData ? posterData.transactions_count : 0,
    };
    try {
        const r = await fetch(API_BASE + '/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        const d = await r.json();
        if (d.success) {
            const ss = document.getElementById('save-status');
            ss.classList.remove('hidden');
            setTimeout(() => ss.classList.add('hidden'), 2000);
            loadHistoryDates();
        }
    } catch(e) {}
}

async function loadHistoryDates() {
    try {
        const r = await fetch(API_BASE + '/dates');
        const d = await r.json();
        if (d.success && d.dates) renderDateButtons(d.dates);
    } catch(e) {}
}

function renderDateButtons(dates) {
    const bar = document.getElementById('dates-bar');
    const today = getTodayStr();
    const allDates = [today];
    for (let i = 1; i <= 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const kz = new Date(d.getTime() + 5 * 3600000); // UTC+5 Asia/Almaty
        const ds = kz.toISOString().slice(0, 10);
        if (allDates.indexOf(ds) === -1) allDates.push(ds);
    }
    dates.forEach(d => { if (allDates.indexOf(d) === -1) allDates.push(d); });
    allDates.sort((a, b) => { if (a === today) return -1; if (b === today) return 1; return b.localeCompare(a); });

    const yd = new Date();
    yd.setDate(yd.getDate() - 1);
    const ykz = new Date(yd.getTime() + 5 * 3600000); // UTC+5 Asia/Almaty
    const yesterday = ykz.toISOString().slice(0, 10);
    const savedSet = new Set(dates);

    bar.innerHTML = '';
    allDates.forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'sc-date-btn' + (d === currentDate ? ' active' : '');
        btn.dataset.date = d;
        btn.onclick = () => selectDate(d);
        const dateSpan = document.createElement('span');
        dateSpan.className = 'sc-date-btn-date';
        dateSpan.textContent = fmtDateShort(d);
        btn.appendChild(dateSpan);
        if (d === today) {
            const sub = document.createElement('span');
            sub.className = 'sc-date-btn-sub';
            sub.textContent = '—Å–µ–≥–æ–¥–Ω—è';
            btn.appendChild(sub);
        } else if (d === yesterday) {
            const sub = document.createElement('span');
            sub.className = 'sc-date-btn-sub';
            sub.textContent = '–≤—á–µ—Ä–∞';
            btn.appendChild(sub);
        }
        if (savedSet.has(d)) btn.classList.add('has-data');
        bar.appendChild(btn);
    });
}

function loadShiftReport() {
    const fmtR = n => Math.round(n).toLocaleString('ru-RU').replace(/\u00A0/g, ' ');
    const dateDisplay = fmtDateFull(currentDate);
    const wolt = pi('wolt'), kaspi = pi('kaspi');
    const kaspi_pizzburg = pi('kaspi_pizzburg');
    const cash_bills = pi('cash_bills'), cash_coins = pi('cash_coins');
    const shift_start = pi('shift_start');
    const expenses = pi('expenses'), cash_to_leave = pi('cash_to_leave');

    const calc = lastCalc || {};
    const fact_cashless = calc.fact_cashless || (wolt + kaspi + kaspi_pizzburg);
    const fact_total = calc.fact_total || (fact_cashless + cash_bills + cash_coins);
    const fact_adjusted = calc.fact_adjusted || 0;
    const poster_trade = calc.poster_trade || (posterData ? posterData.trade_total / 100 : 0);
    const poster_bonus = calc.poster_bonus || (posterData ? posterData.bonus / 100 : 0);
    const poster_total = calc.poster_total || (poster_trade - poster_bonus);
    const poster_card = calc.poster_card || (posterData ? posterData.poster_card / 100 : 0);
    const day_result = calc.day_result || 0;
    const shift_left = calc.shift_left || (cash_to_leave + cash_coins);
    const cashless_diff = calc.cashless_diff || (fact_cashless - poster_card);
    const collection = calc.collection || (cash_bills - cash_to_leave + expenses - cashless_diff);

    const dayLabel = day_result > 0 ? '–∏–∑–ª–∏—à–µ–∫' : day_result < 0 ? '–Ω–µ–¥–æ—Å—Ç–∞—á–∞' : '—Ä–æ–≤–Ω–æ';
    const daySign = day_result > 0 ? '+' : '';
    const dayEmoji = day_result > 0 ? 'üìà' : day_result < 0 ? 'üìâ' : '‚úÖ';

    const sep = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
    const subsep = '   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';

    let lines = [
        'üìã {{ account_name }} ‚Äî –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã ' + dateDisplay,
        sep,
        'üí≥ –ë–µ–∑–Ω–∞–ª —Ç–µ—Ä–º–∏–Ω–∞–ª—ã:',
        '   Wolt: ' + fmtR(wolt) + '‚Ç∏',
        '   Kaspi: ' + fmtR(kaspi) + '‚Ç∏',
    ];
    if (kaspi_pizzburg > 0) {
        lines.push('   Kaspi Pizzburg (–∫—É—Ä—å–µ—Ä—ã): +' + fmtR(kaspi_pizzburg) + '‚Ç∏');
    }
    lines = lines.concat([
        subsep,
        '   –ò—Ç–æ–≥–æ –±–µ–∑–Ω–∞–ª: ' + fmtR(fact_cashless) + '‚Ç∏',
        '',
        'üíµ –ù–∞–ª–∏—á–Ω—ã–µ:',
        '   –ë—É–º–∞–∂–Ω—ã–µ: ' + fmtR(cash_bills) + '‚Ç∏',
        '   –ú–µ–ª–æ—á—å: ' + fmtR(cash_coins) + '‚Ç∏',
        sep,
        'üìä –°–≤–µ—Ä–∫–∞:',
        '   –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π: ' + fmtR(fact_total) + '‚Ç∏',
        '   –°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–æ: ' + fmtR(shift_start) + '‚Ç∏',
    ]);
    if (expenses > 0) lines.push('   –†–∞—Å—Ö–æ–¥—ã: ' + fmtR(expenses) + '‚Ç∏');
    lines = lines.concat([
        subsep,
        '   –ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç: ' + fmtR(fact_adjusted) + '‚Ç∏',
        '',
        '   Poster —Ç–æ—Ä–≥–æ–≤–ª—è: ' + fmtR(poster_trade) + '‚Ç∏',
        '   Poster –±–æ–Ω—É—Å—ã: -' + fmtR(poster_bonus) + '‚Ç∏',
        subsep,
        '   –ò—Ç–æ–≥–æ Poster: ' + fmtR(poster_total) + '‚Ç∏',
        '',
        sep,
        dayEmoji + ' –ò–¢–û–ì–û –î–ï–ù–¨: ' + daySign + fmtR(day_result) + '‚Ç∏ (' + dayLabel + ')',
        sep,
        '',
        'üí∞ –ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è: ' + fmtR(collection) + '‚Ç∏',
        'üîÑ –°–º–µ–Ω–∞ –æ—Å—Ç–∞–≤–∏–ª–∏: ' + fmtR(shift_left) + '‚Ç∏',
    ]);
    if (Math.abs(cashless_diff) >= 1) {
        lines.push('');
        lines.push('‚ÑπÔ∏è –†–∞–∑–Ω–∏—Ü–∞ –±–µ–∑–Ω–∞–ª: ' + (cashless_diff > 0 ? '+' : '') + fmtR(cashless_diff) + '‚Ç∏ (—É—á—Ç–µ–Ω–æ –≤ –∏–Ω–∫–∞—Å—Å–∞—Ü–∏–∏)');
    }

    document.getElementById('report-text').textContent = lines.join('\n');
    document.getElementById('report-container').style.display = 'block';
}

function copyToClipboard(text) {
    return navigator.clipboard.writeText(text).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    });
}

function showTransferStatus(msg, isSuccess) {
    const el = document.getElementById('transfer-status');
    el.textContent = msg;
    el.style.background = isSuccess ? '#34c75920' : '#ff950020';
    el.style.color = isSuccess ? '#34c759' : '#ff9500';
    el.classList.remove('hidden');
}

function updateCopyBtn() {
    const btn = document.getElementById('copy-btn');
    if (transfersCreated) {
        btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)';
    }
}

async function copyReportAndTransfer() {
    const btn = document.getElementById('copy-btn');
    const text = document.getElementById('report-text').textContent;

    // 1. Copy report
    await copyToClipboard(text);

    // 2. If transfers not yet created and not readonly ‚Äî create them
    if (!transfersCreated && !isReadonly) {
        btn.textContent = '–°–æ–∑–¥–∞—é –ø–µ—Ä–µ–≤–æ–¥—ã...';
        btn.disabled = true;
        try {
            const res = await fetch(API_BASE + '/transfers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({date: currentDate})
            });
            const data = await res.json();
            if (data.success) {
                transfersCreated = true;
                if (data.already_created) {
                    showTransferStatus('–ü–µ—Ä–µ–≤–æ–¥—ã —É–∂–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —Ä–∞–Ω–µ–µ', true);
                } else if (data.created_count > 0) {
                    const names = data.transfers.map(t => t.name + ': ' + t.amount.toLocaleString('ru-RU') + '‚Ç∏').join(', ');
                    showTransferStatus('‚úÖ ' + data.created_count + ' –ø–µ—Ä–µ–≤–æ–¥(–∞) —Å–æ–∑–¥–∞–Ω–æ: ' + names, true);
                } else {
                    showTransferStatus('–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (—Å—É–º–º—ã = 0)', true);
                }
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)';
                setTimeout(() => { btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)'; }, 2000);
            } else {
                showTransferStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), false);
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
            }
        } catch (e) {
            showTransferStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message, false);
            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => { btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
        }
        btn.disabled = false;
    } else {
        // Just copy ‚Äî transfers already done
        btn.textContent = transfersCreated ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => updateCopyBtn() || (btn.textContent = transfersCreated ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'), 1500);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    currentDate = getTodayStr();
    document.getElementById('current-date').textContent = fmtDateFull(currentDate);

    if (IS_OWNER) {
        // Owner: show both steps, no blocking
        document.getElementById('salary-step').classList.remove('hidden');
        document.getElementById('shift-closing-step').classList.remove('hidden');
        document.querySelector('.sc-step-indicator').classList.add('hidden');
        document.getElementById('btnSalaryNext').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—ã';
        loadSalaryDataForDate(currentDate);
        loadHistoryDates();
        loadDateData(currentDate);
    } else {
        // Admin: strict step-by-step flow
        loadLastEmployees();
        checkSalaryStatus();
    }
});
</script>
</body>
</html>
