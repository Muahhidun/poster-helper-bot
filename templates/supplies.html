{% extends "base.html" %}

{% block title %}–ü–æ—Å—Ç–∞–≤–∫–∏ - PizzBurg{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫</h1>
        <button type="button" class="btn btn-primary" id="add-supply-btn">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É
        </button>
    </div>

    <div class="supplies-list" id="supplies-list">
        {% for draft in drafts %}
        <div class="supply-card" data-id="{{ draft.id }}">
            <div class="supply-header">
                <div class="supply-info">
                    <div class="supplier-row">
                        <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</label>
                        <div class="supplier-search-wrapper">
                            <input type="text" class="supplier-input" value="{{ draft.supplier_name or '' }}"
                                   data-id="{{ draft.id }}" data-supplier-id="{{ draft.supplier_id or '' }}"
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞...">
                            <div class="supplier-results"></div>
                        </div>
                        <button type="button" class="btn btn-sm btn-repeat-supply" data-id="{{ draft.id }}"
                                style="display:none" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ—Å—Ç–∞–≤–∫—É">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                    <div class="meta-row">
                        <span class="amount calculated-total">{{ "{:,.0f}".format(draft.total_sum or 0) }}‚Ç∏</span>
                        {% if draft.linked_expense_amount %}
                        <span class="expense-amount" title="–°—É–º–º–∞ –∏–∑ —Ä–∞—Å—Ö–æ–¥–∞">/ {{ "{:,.0f}".format(draft.linked_expense_amount) }}‚Ç∏</span>
                        {% endif %}
                        <span class="date">{{ draft.invoice_date or '–°–µ–≥–æ–¥–Ω—è' }}</span>
                        <select class="source-select" data-id="{{ draft.id }}">
                            <option value="cash" {% if draft.source != 'kaspi' %}selected{% endif %}>–ù–∞–ª–∏—á–∫–∞</option>
                            <option value="kaspi" {% if draft.source == 'kaspi' %}selected{% endif %}>Kaspi Pay</option>
                        </select>
                        {% if draft.linked_expense_draft_id %}
                        <span class="badge bg-success">üîó –†–∞—Å—Ö–æ–¥ #{{ draft.linked_expense_draft_id }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="supply-actions">
                    <button type="button" class="btn btn-sm btn-success btn-process" data-id="{{ draft.id }}"
                            title="–°–æ–∑–¥–∞—Ç—å –≤ Poster">
                        ‚úÖ –°–æ–∑–¥–∞—Ç—å
                    </button>
                    <button type="button" class="btn btn-sm btn-danger btn-delete-supply" data-id="{{ draft.id }}">
                        üóëÔ∏è
                    </button>
                </div>
            </div>

            <div class="supply-items">
                <div class="items-header">
                    <span>–¢–æ–≤–∞—Ä—ã</span>
                    <div class="add-item-search">
                        <input type="text" class="item-search-input" data-draft-id="{{ draft.id }}"
                               placeholder="üîç –ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞...">
                        <div class="search-results"></div>
                    </div>
                </div>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                            <th>–û—Ç–¥–µ–ª</th>
                            <th>–ö–æ–ª-–≤–æ</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–°—É–º–º–∞</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody class="items-tbody" data-draft-id="{{ draft.id }}">
                        <!-- Items will be loaded dynamically -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>–ò—Ç–æ–≥–æ:</strong></td>
                            <td class="items-total">0‚Ç∏</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not drafts %}
    <div class="empty-state">
        <p>–ù–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –ø–æ—Å—Ç–∞–≤–æ–∫</p>
        <p>–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É" –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ —Ä–∞—Å—Ö–æ–¥ –∫–∞–∫ –ø–æ—Å—Ç–∞–≤–∫—É –≤–æ –≤–∫–ª–∞–¥–∫–µ –†–∞—Å—Ö–æ–¥—ã.</p>
    </div>
    {% endif %}

    <div class="summary" {% if not drafts %}style="display:none"{% endif %}>
        <p>–í—Å–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤: <span id="total-drafts">{{ drafts|length }}</span></p>
        {% set total = namespace(sum=0) %}
        {% for draft in drafts %}
            {% set total.sum = total.sum + (draft.total_sum or 0) %}
        {% endfor %}
        <p><strong>–û–±—â–∞—è —Å—É–º–º–∞: <span id="total-sum">{{ "{:,.0f}".format(total.sum) }}</span>‚Ç∏</strong></p>
    </div>
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

h1 { margin: 0; }

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.btn-primary { background: #007bff; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn:hover { opacity: 0.9; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.alert {
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.supply-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.supply-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
}

.supply-info { flex: 1; }

.supplier-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.supplier-row label {
    font-weight: 600;
    color: #666;
}

.supplier-search-wrapper {
    position: relative;
    flex: 1;
    max-width: 300px;
}

.supplier-input {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.supplier-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.supplier-result-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.supplier-result-item:hover, .supplier-result-item.active {
    background: #e3f2fd;
}

.btn-repeat-supply {
    background: #17a2b8;
    color: white;
    white-space: nowrap;
    margin-left: 10px;
}

.btn-repeat-supply:hover {
    background: #138496;
}

.meta-row {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.amount {
    font-weight: 600;
    font-family: monospace;
    font-size: 1.1em;
    color: #28a745;
}

.expense-amount {
    font-weight: 500;
    font-family: monospace;
    font-size: 0.95em;
    color: #6c757d;
}

.calculated-total.match {
    color: #28a745;
}

.calculated-total.mismatch {
    color: #dc3545;
}

.date { color: #666; }

.source-select {
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
}

.bg-success { background: #28a745; color: white; }

.supply-actions {
    display: flex;
    gap: 8px;
}

.supply-items {
    padding: 15px;
}

.items-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.items-header span {
    font-weight: 600;
    color: #333;
}

.add-item-search {
    position: relative;
    width: 300px;
}

.item-search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.search-result-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.search-result-item:hover, .search-result-item.active {
    background: #e3f2fd;
}

.search-result-item .account-tag {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 3px;
    background: #e0e0e0;
    color: #666;
}

.items-table {
    width: 100%;
    border-collapse: collapse;
}

.items-table th, .items-table td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.items-table th {
    font-weight: 600;
    color: #666;
    font-size: 12px;
}

.items-table tbody tr:hover {
    background: #f9f9f9;
}

.item-input {
    width: 80px;
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
    text-align: right;
    font-family: monospace;
}

.item-input.qty { width: 70px; }
.item-input.price { width: 80px; }
.item-input.sum { width: 90px; font-weight: 600; }

.ingredient-name {
    font-weight: 500;
}

.account-badge {
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 3px;
    background: #e0e0e0;
    color: #666;
    margin-left: 5px;
}

.btn-delete-item {
    padding: 3px 8px;
    border: none;
    background: none;
    cursor: pointer;
    color: #dc3545;
}

.btn-delete-item:hover {
    background: #fee;
    border-radius: 3px;
}

.text-right { text-align: right; }

.items-total {
    font-weight: 600;
    font-family: monospace;
}

.summary {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 5px;
    margin-top: 20px;
}

.summary p { margin: 5px 0; }

.empty-state {
    text-align: center;
    padding: 50px;
    color: #666;
}

/* Saved animation */
.saved {
    animation: flash-green 0.3s;
}

@keyframes flash-green {
    0% { background-color: #d4edda; }
    100% { background-color: transparent; }
}
</style>

<script>
// Ingredients data from server
const ingredients = {{ items|tojson|safe if items else '[]' }};
const posterAccounts = {{ poster_accounts|tojson|safe if poster_accounts else '[]' }};
const suppliers = {{ suppliers|tojson|safe if suppliers else '[]' }};

// Supply draft items (loaded from server)
const supplyItems = {};  // { draftId: [items] }

// Last supply items by supplier (for autofill)
const lastSupplyByDraft = {};  // { draftId: { supplierId, supplierName, items: [] } }

// Initial load of items for each draft
{% for draft in drafts %}
supplyItems[{{ draft.id }}] = {{ (draft['items'] or [])|tojson|safe }};
{% endfor %}

let searchTimeout = null;

// Evaluate simple math expressions like "2.5*12" or "100/4"
function evaluateExpression(str) {
    if (!str || typeof str !== 'string') return parseFloat(str) || 0;

    // Replace comma with dot for decimal
    str = str.replace(',', '.');

    // Check if it's a simple expression (contains operators)
    if (/^[\d.]+[*\/+\-][\d.]+$/.test(str.trim())) {
        try {
            // Safe eval for simple math expressions
            const result = Function('"use strict"; return (' + str + ')')();
            return Math.round(result * 1000) / 1000; // Round to 3 decimal places
        } catch (e) {
            return parseFloat(str) || 0;
        }
    }

    return parseFloat(str) || 0;
}

document.addEventListener('DOMContentLoaded', function() {
    // Render initial items
    Object.keys(supplyItems).forEach(draftId => {
        renderItems(parseInt(draftId));
    });

    // Add new supply button
    document.getElementById('add-supply-btn').addEventListener('click', async function() {
        try {
            const response = await fetch('/supplies/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
            const result = await response.json();
            if (result.success) {
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.error || 'Unknown'));
            }
        } catch (e) {
            console.error('Error:', e);
        }
    });

    // Supplier autocomplete
    document.querySelectorAll('.supplier-input').forEach(input => {
        const resultsDiv = input.nextElementSibling;
        const repeatBtn = input.closest('.supplier-row').querySelector('.btn-repeat-supply');
        let selectedIndex = -1;
        let supplierSearchTimeout = null;

        // Check if draft already has supplier with last supply data
        const draftId = input.dataset.id;
        const existingSupplierId = input.dataset.supplierId;
        if (existingSupplierId && input.value) {
            loadLastSupplyForDraft(draftId, parseInt(existingSupplierId), input.value);
        }

        input.addEventListener('input', function() {
            clearTimeout(supplierSearchTimeout);
            const query = this.value.toLowerCase().trim();
            selectedIndex = -1;

            // Clear supplier ID when typing
            this.dataset.supplierId = '';
            repeatBtn.style.display = 'none';

            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }

            supplierSearchTimeout = setTimeout(() => {
                const matches = suppliers.filter(s =>
                    s.name.toLowerCase().includes(query)
                ).slice(0, 10);

                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<div class="supplier-result-item" style="color:#999">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                } else {
                    resultsDiv.innerHTML = matches.map((s, i) => `
                        <div class="supplier-result-item" data-index="${i}"
                             data-id="${s.id}" data-name="${s.name}">
                            ${s.name}
                        </div>
                    `).join('');
                }
                resultsDiv.style.display = 'block';
            }, 100);
        });

        // Keyboard navigation
        input.addEventListener('keydown', function(e) {
            const items = resultsDiv.querySelectorAll('.supplier-result-item[data-id]');

            if (e.key === 'ArrowDown') {
                if (items.length === 0) return;
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSupplierSelection(items);
            } else if (e.key === 'ArrowUp') {
                if (items.length === 0) return;
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSupplierSelection(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                // Select first item if dropdown is open with results
                if (resultsDiv.style.display !== 'none' && items.length > 0) {
                    e.preventDefault();
                    const itemToSelect = selectedIndex >= 0 ? items[selectedIndex] : items[0];
                    selectSupplier(itemToSelect, input, true);
                } else if (e.key === 'Enter' && resultsDiv.style.display === 'none' && this.value) {
                    // Just save the manual input on Enter
                    saveSupplierName(input);
                }
                // Tab without dropdown - let browser handle natural focus
            } else if (e.key === 'Escape') {
                resultsDiv.style.display = 'none';
            }
        });

        function updateSupplierSelection(items) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === selectedIndex);
            });
        }

        // Click selection
        resultsDiv.addEventListener('click', function(e) {
            const item = e.target.closest('.supplier-result-item[data-id]');
            if (item) selectSupplier(item, input);
        });

        // Close on outside click
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });

        // Save on blur (manual input)
        input.addEventListener('blur', function() {
            setTimeout(() => {
                if (resultsDiv.style.display === 'none' && this.value) {
                    saveSupplierName(this);
                }
            }, 200);
        });

        async function selectSupplier(item, inputEl, focusNext = false) {
            const draftId = inputEl.dataset.id;
            const supplierId = parseInt(item.dataset.id);
            const supplierName = item.dataset.name;

            inputEl.value = supplierName;
            inputEl.dataset.supplierId = supplierId;
            resultsDiv.style.display = 'none';

            // Save to server
            await updateSupplyDraft(draftId, { supplier_name: supplierName, supplier_id: supplierId });
            inputEl.classList.add('saved');
            setTimeout(() => inputEl.classList.remove('saved'), 300);

            // Load last supply from this supplier
            loadLastSupplyForDraft(draftId, supplierId, supplierName);

            // Focus next field (ingredient search) if requested
            if (focusNext) {
                const card = inputEl.closest('.supply-card');
                const searchInput = card.querySelector('.item-search-input');
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 50);
                }
            }
        }

        async function saveSupplierName(inputEl) {
            const draftId = inputEl.dataset.id;
            await updateSupplyDraft(draftId, { supplier_name: inputEl.value });
            inputEl.classList.add('saved');
            setTimeout(() => inputEl.classList.remove('saved'), 300);
        }
    });

    // Load last supply data for a draft
    async function loadLastSupplyForDraft(draftId, supplierId, supplierName) {
        const repeatBtn = document.querySelector(`.btn-repeat-supply[data-id="${draftId}"]`);

        try {
            const response = await fetch(`/api/supplies/last/${supplierId}`);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                lastSupplyByDraft[draftId] = {
                    supplierId: supplierId,
                    supplierName: supplierName,
                    items: data.items
                };
                repeatBtn.textContent = `üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å (${data.items.length})`;
                repeatBtn.style.display = 'inline-block';
            } else {
                delete lastSupplyByDraft[draftId];
                repeatBtn.style.display = 'none';
            }
        } catch (e) {
            console.error('Error loading last supply:', e);
            repeatBtn.style.display = 'none';
        }
    }

    // Repeat last supply button
    document.querySelectorAll('.btn-repeat-supply').forEach(btn => {
        btn.addEventListener('click', async function() {
            const draftId = this.dataset.id;
            const lastSupply = lastSupplyByDraft[draftId];

            if (!lastSupply || !lastSupply.items.length) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ—Å—Ç–∞–≤–∫–µ');
                return;
            }

            if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å ${lastSupply.items.length} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç ${lastSupply.supplierName}?`)) {
                return;
            }

            this.disabled = true;
            this.textContent = '‚è≥...';

            // Add each item from last supply
            for (const lastItem of lastSupply.items) {
                // Find matching ingredient
                const ing = ingredients.find(i => i.id === lastItem.id && i.name === lastItem.name);
                if (!ing) continue;

                // Add item to server
                const response = await fetch(`/supplies/add-item/${draftId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        poster_ingredient_id: ing.id,
                        poster_ingredient_name: ing.name,
                        name: ing.name,
                        quantity: lastItem.quantity || 1,
                        price: lastItem.price || 0,
                        poster_account_id: ing.poster_account_id || null
                    })
                });

                const result = await response.json();
                if (result.success) {
                    if (!supplyItems[draftId]) supplyItems[draftId] = [];
                    supplyItems[draftId].push({
                        id: result.item_id,
                        item_name: ing.name,
                        poster_ingredient_id: ing.id,
                        poster_ingredient_name: ing.name,
                        poster_account_id: ing.poster_account_id,
                        poster_account_name: ing.poster_account_name || '',
                        quantity: lastItem.quantity || 1,
                        price_per_unit: lastItem.price || 0,
                        total: (lastItem.quantity || 1) * (lastItem.price || 0)
                    });
                }
            }

            // Re-render items
            renderItems(parseInt(draftId));
            updateTotals();

            this.disabled = false;
            this.textContent = `üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å (${lastSupply.items.length})`;
        });
    });

    // Source select change
    document.querySelectorAll('.source-select').forEach(select => {
        select.addEventListener('change', async function() {
            const draftId = this.dataset.id;
            await updateSupplyDraft(draftId, { source: this.value });
        });
    });

    // Delete supply button
    document.querySelectorAll('.btn-delete-supply').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ—Å—Ç–∞–≤–∫–∏?')) return;
            const draftId = this.dataset.id;
            const response = await fetch(`/supplies/delete/${draftId}`, { method: 'POST' });
            if (response.ok) {
                this.closest('.supply-card').remove();
                updateTotals();
            }
        });
    });

    // Process supply button
    document.querySelectorAll('.btn-process').forEach(btn => {
        btn.addEventListener('click', async function() {
            const draftId = this.dataset.id;
            const items = supplyItems[draftId] || [];

            if (items.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä');
                return;
            }

            const unmatched = items.filter(i => !i.poster_ingredient_id);
            if (unmatched.length > 0) {
                alert(`–ù–µ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º (${unmatched.length} –∏–∑ ${items.length})`);
                return;
            }

            if (!confirm('–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É –≤ Poster?')) return;

            this.disabled = true;
            this.textContent = '‚è≥...';

            try {
                const response = await fetch(`/supplies/process/${draftId}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    const supplies = result.supplies || [{ supply_id: result.supply_id }];
                    const msg = supplies.map(s =>
                        `‚úÖ ${s.account_name || 'Poster'}: #${s.supply_id} (${s.items_count} —Ç–æ–≤–∞—Ä–æ–≤, ${s.total}‚Ç∏)`
                    ).join('\n');
                    alert('–ü–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–∑–¥–∞–Ω—ã!\n\n' + msg);
                    this.closest('.supply-card').remove();
                    updateTotals();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                    this.disabled = false;
                    this.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å';
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
                this.disabled = false;
                this.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å';
            }
        });
    });

    // Ingredient search
    document.querySelectorAll('.item-search-input').forEach(input => {
        const resultsDiv = input.nextElementSibling;
        let selectedIndex = -1;

        input.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase().trim();
            selectedIndex = -1;

            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                const matches = ingredients.filter(ing =>
                    ing.name.toLowerCase().includes(query)
                ).slice(0, 15);

                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item" style="color:#999">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                } else {
                    resultsDiv.innerHTML = matches.map((ing, i) => `
                        <div class="search-result-item" data-index="${i}"
                             data-id="${ing.id}"
                             data-name="${ing.name}"
                             data-account-id="${ing.poster_account_id || ''}"
                             data-account-name="${ing.poster_account_name || ''}">
                            <span>${ing.name}</span>
                            ${ing.poster_account_name ? `<span class="account-tag">${ing.poster_account_name}</span>` : ''}
                        </div>
                    `).join('');
                }
                resultsDiv.style.display = 'block';
            }, 100);
        });

        // Keyboard navigation
        input.addEventListener('keydown', function(e) {
            const items = resultsDiv.querySelectorAll('.search-result-item[data-id]');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    selectIngredient(items[selectedIndex], input);
                } else if (items.length === 1) {
                    selectIngredient(items[0], input);
                }
            } else if (e.key === 'Escape') {
                resultsDiv.style.display = 'none';
            }
        });

        function updateSelection(items) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === selectedIndex);
            });
        }

        // Click selection
        resultsDiv.addEventListener('click', function(e) {
            const item = e.target.closest('.search-result-item[data-id]');
            if (item) selectIngredient(item, input);
        });

        // Close on outside click
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });

        async function selectIngredient(item, inputEl) {
            const draftId = inputEl.dataset.draftId;
            const ingredientId = parseInt(item.dataset.id);
            const ingredientName = item.dataset.name;
            const accountId = item.dataset.accountId ? parseInt(item.dataset.accountId) : null;
            const accountName = item.dataset.accountName || '';

            // Check if we have last supply data for this ingredient (autofill)
            let autoQty = 0;
            let autoPrice = 0;
            const lastSupply = lastSupplyByDraft[draftId];
            if (lastSupply && lastSupply.items) {
                const lastItem = lastSupply.items.find(i => i.id === ingredientId || i.name === ingredientName);
                if (lastItem) {
                    autoQty = lastItem.quantity || 1;
                    autoPrice = lastItem.price || 0;
                }
            }

            // Add item to server
            const response = await fetch(`/supplies/add-item/${draftId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    poster_ingredient_id: ingredientId,
                    poster_ingredient_name: ingredientName,
                    name: ingredientName,
                    quantity: autoQty,
                    price: autoPrice,
                    poster_account_id: accountId
                })
            });

            const result = await response.json();
            if (result.success) {
                // Add to local array
                if (!supplyItems[draftId]) supplyItems[draftId] = [];
                supplyItems[draftId].push({
                    id: result.item_id,
                    item_name: ingredientName,
                    poster_ingredient_id: ingredientId,
                    poster_ingredient_name: ingredientName,
                    poster_account_id: accountId,
                    poster_account_name: accountName,
                    quantity: autoQty,
                    price_per_unit: autoPrice,
                    total: autoQty * autoPrice,
                    lastPrice: autoPrice > 0 ? autoPrice : null  // Store for hint
                });

                // Re-render items
                renderItems(parseInt(draftId));
                updateTotals();

                // Focus on quantity input of new item
                setTimeout(() => {
                    const tbody = document.querySelector(`.items-tbody[data-draft-id="${draftId}"]`);
                    const lastRow = tbody.querySelector('tr:last-child');
                    if (lastRow) {
                        const qtyInput = lastRow.querySelector('.item-input.qty');
                        if (qtyInput) qtyInput.focus();
                    }
                }, 50);
            }

            // Clear search
            inputEl.value = '';
            resultsDiv.style.display = 'none';
        }
    });
});

function renderItems(draftId) {
    const tbody = document.querySelector(`.items-tbody[data-draft-id="${draftId}"]`);
    if (!tbody) return;

    const items = supplyItems[draftId] || [];

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="color:#999;text-align:center">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤. –ù–∞–π–¥–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –≤ –ø–æ–∏—Å–∫–µ –≤—ã—à–µ.</td></tr>';
        updateItemsTotal(draftId, 0);
        return;
    }

    tbody.innerHTML = items.map((item, i) => `
        <tr data-item-id="${item.id}">
            <td>
                <span class="ingredient-name">${item.poster_ingredient_name || item.item_name}</span>
            </td>
            <td>
                ${item.poster_account_name ? `<span class="account-badge">${item.poster_account_name}</span>` : '-'}
            </td>
            <td>
                <input type="text" class="item-input qty" value="${item.quantity || 0}"
                       data-item-id="${item.id}" data-draft-id="${draftId}" placeholder="0">
            </td>
            <td>
                <input type="text" class="item-input price" value="${item.price_per_unit || 0}"
                       data-item-id="${item.id}" data-draft-id="${draftId}" placeholder="0">
            </td>
            <td>
                <input type="text" class="item-input sum" value="${(item.quantity || 0) * (item.price_per_unit || 0)}"
                       data-item-id="${item.id}" data-draft-id="${draftId}" placeholder="0">
            </td>
            <td>
                <button type="button" class="btn-delete-item" data-item-id="${item.id}" data-draft-id="${draftId}">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');

    // Attach event listeners for all three fields (qty, price, sum)
    tbody.querySelectorAll('.item-input.qty, .item-input.price, .item-input.sum').forEach(input => {
        // Focus - select all if value is 0
        input.addEventListener('focus', function() {
            if (this.value === '0' || this.value === '') {
                setTimeout(() => this.select(), 10);
            }
        });

        input.addEventListener('change', async function() {
            const itemId = parseInt(this.dataset.itemId);
            const draftId = parseInt(this.dataset.draftId);
            const row = this.closest('tr');
            const changedField = this.classList.contains('qty') ? 'qty' :
                                 this.classList.contains('price') ? 'price' : 'sum';

            // Evaluate expression if present (e.g., "2.5*12" -> 30)
            const rawValue = this.value;
            const evalValue = evaluateExpression(rawValue);
            this.value = evalValue;

            // Get all values
            let qty = parseFloat(row.querySelector('.qty').value) || 0;
            let price = parseFloat(row.querySelector('.price').value) || 0;
            let sum = parseFloat(row.querySelector('.sum').value) || 0;

            // Smart calculation - if 2 fields are filled, calculate the third
            if (changedField === 'qty' || changedField === 'price') {
                // Standard: qty * price = sum
                if (qty > 0 && price > 0) {
                    sum = qty * price;
                    row.querySelector('.sum').value = Math.round(sum);
                }
            } else if (changedField === 'sum') {
                // User entered sum directly
                if (qty > 0 && sum > 0) {
                    // Calculate price from qty and sum
                    price = sum / qty;
                    row.querySelector('.price').value = Math.round(price * 100) / 100;
                } else if (price > 0 && sum > 0) {
                    // Calculate qty from price and sum
                    qty = sum / price;
                    row.querySelector('.qty').value = Math.round(qty * 1000) / 1000;
                }
            }

            // Update local data
            const item = supplyItems[draftId].find(i => i.id === itemId);
            if (item) {
                item.quantity = qty;
                item.price_per_unit = price;
                item.total = sum;
            }

            // Update server
            await fetch(`/supplies/update-item/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ quantity: qty, price_per_unit: price })
            });

            // Update totals
            updateItemsTotal(draftId);
            updateTotals();
        });

        // Smart field navigation with Enter
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const row = this.closest('tr');
                if (this.classList.contains('qty')) {
                    row.querySelector('.price').focus();
                } else if (this.classList.contains('price')) {
                    row.querySelector('.sum').focus();
                } else if (this.classList.contains('sum')) {
                    // Move to next row qty or search
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        nextRow.querySelector('.qty').focus();
                    } else {
                        // Focus search input
                        const card = row.closest('.supply-card');
                        card.querySelector('.item-search-input').focus();
                    }
                }
            }
        });
    });

    tbody.querySelectorAll('.btn-delete-item').forEach(btn => {
        btn.addEventListener('click', async function() {
            const itemId = parseInt(this.dataset.itemId);
            const draftId = parseInt(this.dataset.draftId);

            await fetch(`/supplies/delete-item/${itemId}`, { method: 'POST' });

            // Remove from local array
            supplyItems[draftId] = supplyItems[draftId].filter(i => i.id !== itemId);

            // Re-render
            renderItems(draftId);
            updateTotals();
        });
    });

    // Update total
    updateItemsTotal(draftId);
}

function updateItemsTotal(draftId, forceTotal) {
    const items = supplyItems[draftId] || [];
    const total = forceTotal !== undefined ? forceTotal : items.reduce((sum, i) => sum + (i.quantity || 0) * (i.price_per_unit || 0), 0);

    const card = document.querySelector(`.supply-card[data-id="${draftId}"]`);
    if (card) {
        card.querySelector('.items-total').textContent = total.toLocaleString('ru-RU') + '‚Ç∏';
        card.querySelector('.amount').textContent = total.toLocaleString('ru-RU') + '‚Ç∏';
    }
}

async function updateSupplyDraft(draftId, fields) {
    await fetch(`/supplies/update/${draftId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(fields)
    });
}

function updateTotals() {
    const cards = document.querySelectorAll('.supply-card');
    document.getElementById('total-drafts').textContent = cards.length;

    let totalSum = 0;
    Object.values(supplyItems).forEach(items => {
        items.forEach(item => {
            totalSum += (item.quantity || 0) * (item.price_per_unit || 0);
        });
    });
    document.getElementById('total-sum').textContent = totalSum.toLocaleString('ru-RU');
}
</script>
{% endblock %}
