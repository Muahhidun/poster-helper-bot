{% extends "base.html" %}

{% block title %}–ü–æ—Å—Ç–∞–≤–∫–∏ - PizzBurg{% endblock %}

{% block content %}
<div class="container">
    <h1>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫</h1>

    {% if pending_supplies %}
    <div class="alert alert-info">
        <strong>üìã –û–∂–∏–¥–∞—é—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö:</strong> {{ pending_supplies|length }} –ø–æ–∑–∏—Ü–∏–π –∏–∑ –ª–∏—Å—Ç–∞ –∫–∞—Å—Å–∏—Ä–∞
        <ul class="mb-0 mt-2">
            {% for item in pending_supplies[:5] %}
            <li>{{ "{:,.0f}".format(item.amount) }}‚Ç∏ ‚Äî {{ item.description[:40] }}{% if item.description|length > 40 %}...{% endif %}</li>
            {% endfor %}
            {% if pending_supplies|length > 5 %}
            <li>... –∏ –µ—â—ë {{ pending_supplies|length - 5 }} –ø–æ–∑–∏—Ü–∏–π</li>
            {% endif %}
        </ul>
    </div>
    {% endif %}

    {% if drafts %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for draft in drafts %}
                <tr class="draft-row">
                    <td>#{{ draft.id }}</td>
                    <td>{{ draft.supplier_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                    <td>{{ draft.invoice_date or '-' }}</td>
                    <td>-</td>
                    <td class="amount">{{ "{:,.0f}".format(draft.total_sum or 0) }}‚Ç∏</td>
                    <td>
                        {% if draft.linked_expense_draft_id %}
                        <span class="badge bg-success">üîó –°–≤—è–∑–∞–Ω–æ</span>
                        {% else %}
                        <span class="badge bg-secondary">–ù–æ–≤—ã–π</span>
                        {% endif %}
                    </td>
                    <td class="actions">
                        <a href="{{ url_for('view_supply', draft_id=draft.id) }}" class="btn btn-sm btn-primary">
                            üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                        <button type="button" class="btn btn-sm btn-danger btn-delete" data-id="{{ draft.id }}">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="summary">
        <p>–í—Å–µ–≥–æ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤: {{ drafts|length }}</p>
        <p><strong>–û–±—â–∞—è —Å—É–º–º–∞: {{ "{:,.0f}".format(drafts|sum(attribute='total_sum')) }}‚Ç∏</strong></p>
    </div>
    {% else %}
    <div class="empty-state">
        <p>–ù–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –ø–æ—Å—Ç–∞–≤–æ–∫</p>
        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –≤ –±–æ—Ç–∞ (—Ä–µ–∂–∏–º "üì¶ –ü–æ—Å—Ç–∞–≤–∫–∏"), —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫.</p>
    </div>
    {% endif %}
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    margin-bottom: 20px;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.table th, .table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.table th {
    background: #f5f5f5;
    font-weight: 600;
}

.draft-row:hover {
    background: #f9f9f9;
}

.amount {
    font-weight: 600;
    font-family: monospace;
}

.actions {
    white-space: nowrap;
}

.btn {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.bg-success {
    background: #28a745;
    color: white;
}

.bg-secondary {
    background: #6c757d;
    color: white;
}

.summary {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 5px;
}

.summary p {
    margin: 5px 0;
}

.empty-state {
    text-align: center;
    padding: 50px;
    color: #666;
}

.alert {
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.alert-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Delete supply draft
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ—Å—Ç–∞–≤–∫–∏?')) return;

            const id = this.dataset.id;
            try {
                const response = await fetch(`/supplies/delete/${id}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    this.closest('tr').remove();
                }
            } catch (e) {
                console.error('Error:', e);
            }
        });
    });
});
</script>
{% endblock %}
