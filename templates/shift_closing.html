{% extends "base.html" %}

{% block title %}Закрытие смены - PizzBurg{% endblock %}

{% block content %}
<div class="shift-closing-container">
    <h1>Закрытие смены</h1>

    <div class="date-header">
        <span id="current-date"></span>
        <span id="accounts-info" class="accounts-badge"></span>
    </div>

    <div class="info-banner" id="loading-banner">
        Загрузка данных Poster...
    </div>

    <!-- Фактические данные (ввод) -->
    <div class="section-card">
        <h3 class="section-title">Фактические данные</h3>

        <!-- Безнал терминалы -->
        <div class="input-group-label">Безнал (терминалы)</div>
        <div class="two-cols">
            <div class="input-field">
                <label for="wolt">Wolt</label>
                <div class="input-wrapper">
                    <input type="text" id="wolt" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                    <span class="currency">T</span>
                </div>
            </div>
            <div class="input-field">
                <label for="halyk">Halyk</label>
                <div class="input-wrapper">
                    <input type="text" id="halyk" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                    <span class="currency">T</span>
                </div>
            </div>
        </div>

        <div class="input-field">
            <label for="kaspi">Kaspi терминал</label>
            <div class="input-wrapper">
                <input type="text" id="kaspi" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                <span class="currency">T</span>
            </div>
        </div>

        <div class="input-field minus-field">
            <label for="kaspi_cafe">- Kaspi от PizzBurg-Cafe</label>
            <div class="input-wrapper">
                <input type="text" id="kaspi_cafe" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()" class="minus-input">
                <span class="currency">T</span>
            </div>
        </div>

        <div class="separator"></div>

        <!-- Наличка -->
        <div class="input-group-label">Наличные</div>
        <div class="two-cols">
            <div class="input-field">
                <label for="cash_bills">Бумажные</label>
                <div class="input-wrapper">
                    <input type="text" id="cash_bills" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                    <span class="currency">T</span>
                </div>
            </div>
            <div class="input-field">
                <label for="cash_coins">Мелочь</label>
                <div class="input-wrapper">
                    <input type="text" id="cash_coins" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                    <span class="currency">T</span>
                </div>
            </div>
        </div>

        <!-- = Фактический -->
        <div class="subtotal-row" id="fact_total_row" style="display:none">
            <span class="subtotal-label">= Фактический:</span>
            <span class="subtotal-value" id="fact_total_value">0 T</span>
        </div>

        <div class="separator"></div>

        <!-- Смена, внесения, расходы -->
        <div class="input-field">
            <label for="shift_start">Смена (остаток на начало)</label>
            <div class="input-wrapper">
                <input type="text" id="shift_start" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                <span class="currency">T</span>
            </div>
        </div>

        <div class="input-field">
            <label for="deposits">Внесения</label>
            <div class="input-wrapper">
                <input type="text" id="deposits" inputmode="numeric" placeholder="0" value="0" oninput="debouncedCalculate()">
                <span class="currency">T</span>
            </div>
        </div>

        <div class="input-field">
            <label for="expenses">Расходы с кассы</label>
            <div class="input-wrapper">
                <input type="text" id="expenses" inputmode="numeric" placeholder="0" oninput="debouncedCalculate()">
                <span class="currency">T</span>
            </div>
        </div>

        <!-- Итого фактический -->
        <div class="subtotal-row highlight" id="fact_adjusted_row" style="display:none">
            <span class="subtotal-label">Итого фактич.:</span>
            <span class="subtotal-value" id="fact_adjusted_value">0 T</span>
        </div>
    </div>

    <!-- Данные Poster (readonly) -->
    <div class="section-card">
        <h3 class="section-title">Данные Poster</h3>

        <div class="poster-row">
            <span class="poster-label">Итого безнал:</span>
            <span class="poster-value" id="poster_cashless">-- T</span>
        </div>

        <div class="poster-row">
            <span class="poster-label">Картой (Poster):</span>
            <span class="poster-value" id="poster_card_display">-- T</span>
        </div>

        <div class="poster-row diff-cashless" id="cashless_diff_row" style="display:none">
            <span class="poster-label">Разница безнал:</span>
            <span class="poster-value" id="cashless_diff_value">0 T</span>
        </div>

        <div class="separator"></div>

        <div class="poster-row">
            <span class="poster-label">Poster (торговля):</span>
            <span class="poster-value" id="poster_trade_display">-- T</span>
        </div>

        <div class="poster-row">
            <span class="poster-label">Бонусы:</span>
            <span class="poster-value bonus" id="poster_bonus_display">-- T</span>
        </div>

        <div class="subtotal-row highlight" id="poster_total_row" style="display:none">
            <span class="subtotal-label">Итого Poster:</span>
            <span class="subtotal-value" id="poster_total_value">-- T</span>
        </div>
    </div>

    <!-- ИТОГО ДЕНЬ -->
    <div class="day-result" id="day_result_block">
        <div class="day-result-label">ИТОГО ДЕНЬ</div>
        <div class="day-result-value" id="day_result_value">-- T</div>
        <div class="day-result-status" id="day_result_status"></div>
    </div>

    <!-- Инкассация -->
    <div class="section-card">
        <div class="input-field">
            <label for="cash_to_leave">Оставить на смену (бумажные)</label>
            <div class="input-wrapper">
                <input type="text" id="cash_to_leave" inputmode="numeric" placeholder="15000" value="15000" oninput="debouncedCalculate()">
                <span class="currency">T</span>
            </div>
        </div>

        <div class="poster-row" id="shift_left_row" style="display:none">
            <span class="poster-label">Смена оставили:</span>
            <span class="poster-value" id="shift_left_value">0 T</span>
        </div>
        <div class="shift-left-hint" id="shift_left_hint" style="display:none"></div>

        <div class="collection-block" id="collection_block" style="display:none">
            <span class="collection-label">Инкассация:</span>
            <span class="collection-value" id="collection_value">0 T</span>
        </div>
    </div>

    <!-- Кол-во заказов -->
    <div class="orders-info" id="orders_info" style="display:none"></div>

    <!-- Обновить -->
    <div class="actions-section">
        <button type="button" class="btn btn-primary" onclick="loadPosterData()">
            Обновить данные Poster
        </button>
    </div>

    <!-- Отчёт по расходам -->
    <div class="section-card">
        <div class="expense-report-header">
            <h3 class="section-title" style="margin-bottom:0">Отчёт по расходам</h3>
            <button type="button" class="btn btn-secondary btn-sm" onclick="loadExpenseReport()">
                Сформировать
            </button>
        </div>
        <div id="expense-report-container" style="display: none;">
            <div class="report-actions">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyReport()">
                    Скопировать
                </button>
            </div>
            <pre id="expense-report-text" class="expense-report-text"></pre>
        </div>
    </div>
</div>

<style>
.shift-closing-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
}

h1 {
    margin-bottom: 16px;
    text-align: center;
    font-size: 22px;
}

.date-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
}

.accounts-badge {
    font-size: 13px;
    color: #666;
    font-weight: normal;
}

.info-banner {
    background: #e3f2fd;
    color: #1565c0;
    padding: 10px 16px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 16px;
    font-size: 14px;
}

.info-banner.hidden { display: none; }
.info-banner.error { background: #f8d7da; color: #721c24; }

/* Section card */
.section-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 14px;
}

.input-group-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #9ca3af;
    margin-bottom: 8px;
    font-weight: 600;
}

/* Two-column grid */
.two-cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 10px;
}

/* Input field */
.input-field {
    margin-bottom: 10px;
}

.input-field label {
    display: block;
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 4px;
}

.input-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
}

.input-wrapper input {
    flex: 1;
    padding: 10px 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 17px;
    text-align: right;
    font-family: 'Courier New', monospace;
    font-weight: 600;
    background: #fff;
}

.input-wrapper input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

.input-wrapper .currency {
    font-size: 15px;
    color: #9ca3af;
    font-weight: 600;
    min-width: 14px;
}

/* Minus field (Kaspi cafe) */
.minus-field label {
    color: #ef4444;
}

.minus-input {
    border-color: #fca5a5 !important;
}

.minus-input:focus {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239,68,68,0.1) !important;
}

/* Separator */
.separator {
    height: 1px;
    background: #e5e7eb;
    margin: 14px 0;
}

/* Subtotal row */
.subtotal-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 8px;
    background: #f0f9ff;
    margin-top: 10px;
}

.subtotal-row.highlight {
    background: #eff6ff;
}

.subtotal-label {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
}

.subtotal-value {
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #2563eb;
}

/* Poster rows (readonly data) */
.poster-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-radius: 6px;
    background: #f9fafb;
    margin-bottom: 8px;
}

.poster-label {
    font-size: 14px;
    color: #6b7280;
}

.poster-value {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    color: #374151;
}

.poster-value.bonus {
    color: #ef4444;
}

/* Cashless diff */
.diff-cashless {
    transition: background-color 0.2s;
}
.diff-cashless.positive { background: #dcfce7; }
.diff-cashless.positive .poster-value { color: #16a34a; }
.diff-cashless.negative { background: #fee2e2; }
.diff-cashless.negative .poster-value { color: #dc2626; }

/* Day Result Block */
.day-result {
    text-align: center;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 16px;
    background: #f8f9fa;
    transition: background-color 0.3s;
}

.day-result.positive { background: #dcfce7; }
.day-result.negative { background: #fee2e2; }
.day-result.zero { background: #dbeafe; }

.day-result-label {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.day-result-value {
    font-size: 42px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    color: #374151;
    transition: color 0.3s;
}

.day-result.positive .day-result-value { color: #16a34a; }
.day-result.negative .day-result-value { color: #dc2626; }
.day-result.zero .day-result-value { color: #2563eb; }

.day-result-status {
    font-size: 16px;
    margin-top: 8px;
    color: #6b7280;
}
.day-result.positive .day-result-status { color: #16a34a; }
.day-result.negative .day-result-status { color: #dc2626; }
.day-result.zero .day-result-status { color: #2563eb; }

/* Collection block */
.collection-block {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    border-radius: 8px;
    background: #1f2937;
    margin-top: 12px;
}

.collection-label {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
}

.collection-value {
    font-family: 'Courier New', monospace;
    font-size: 22px;
    font-weight: 700;
    color: #fff;
}

.shift-left-hint {
    text-align: center;
    font-size: 12px;
    color: #9ca3af;
    margin-top: 4px;
}

/* Orders info */
.orders-info {
    text-align: center;
    font-size: 13px;
    color: #9ca3af;
    margin-bottom: 16px;
}

/* Actions */
.actions-section {
    text-align: center;
    margin-bottom: 20px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s;
}

.btn-primary { background: #3b82f6; color: white; }
.btn-primary:hover { background: #2563eb; }
.btn-secondary { background: #6b7280; color: white; }
.btn-secondary:hover { background: #4b5563; }
.btn-sm { padding: 6px 14px; font-size: 13px; }
.btn-outline-secondary {
    background: transparent;
    border: 1px solid #6b7280;
    color: #6b7280;
}
.btn-outline-secondary:hover { background: #6b7280; color: white; }

/* Expense report */
.expense-report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.report-actions {
    margin-bottom: 8px;
    text-align: right;
}

.expense-report-text {
    background: #1a1a2e;
    color: #eee;
    padding: 16px;
    border-radius: 8px;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 500px;
    overflow-y: auto;
}

/* Calculating indicator */
.calculating-indicator {
    position: fixed;
    bottom: 16px;
    left: 16px;
    right: 16px;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    background: #3b82f6;
    color: white;
    font-weight: 600;
    font-size: 14px;
    z-index: 50;
}

/* Loading state */
.loading { opacity: 0.6; pointer-events: none; }

@media (max-width: 480px) {
    .shift-closing-container { padding: 12px; }
    h1 { font-size: 20px; }
    .day-result-value { font-size: 36px; }
    .input-wrapper input { font-size: 16px; padding: 8px 10px; }
}
</style>

<script>
// Poster data (from API, in tiyins)
let posterData = null;
let debounceTimer = null;

// Format number with spaces
function formatMoney(num) {
    return Math.round(num).toLocaleString('ru-RU');
}

// Parse input value
function parseInput(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const value = el.value.replace(/\s/g, '').replace(/,/g, '.');
    return parseFloat(value) || 0;
}

// Debounced calculate (300ms)
function debouncedCalculate() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculate, 300);
}

// Load Poster data
async function loadPosterData() {
    const banner = document.getElementById('loading-banner');
    banner.textContent = 'Загрузка данных Poster...';
    banner.classList.remove('hidden', 'error');

    try {
        document.querySelector('.shift-closing-container').classList.add('loading');

        const response = await fetch('/api/shift-closing/poster-data');
        const data = await response.json();

        if (data.success) {
            posterData = data;

            // Set shift_start from Poster if available
            if (data.shift_start && data.shift_start > 0) {
                document.getElementById('shift_start').value = String(data.shift_start / 100);
            }

            // Display Poster data
            document.getElementById('poster_trade_display').textContent =
                formatMoney(data.trade_total / 100) + ' T';
            document.getElementById('poster_bonus_display').textContent =
                '-' + formatMoney(data.bonus / 100) + ' T';
            document.getElementById('poster_card_display').textContent =
                formatMoney(data.poster_card / 100) + ' T';

            // Show accounts info
            const accountsInfo = document.getElementById('accounts-info');
            accountsInfo.textContent = data.accounts_count + ' завед.';

            // Show orders info
            const ordersInfo = document.getElementById('orders_info');
            ordersInfo.textContent = 'Закрытых заказов: ' + data.transactions_count;
            ordersInfo.style.display = 'block';

            banner.textContent = 'Данные загружены';
            setTimeout(() => banner.classList.add('hidden'), 2000);

            calculate();
        } else {
            banner.textContent = 'Ошибка: ' + (data.error || 'Unknown error');
            banner.classList.add('error');
        }
    } catch (e) {
        console.error('Error loading Poster data:', e);
        banner.textContent = 'Не удалось загрузить данные';
        banner.classList.add('error');
    } finally {
        document.querySelector('.shift-closing-container').classList.remove('loading');
    }
}

// Calculate via backend API
async function calculate() {
    if (!posterData) return;

    try {
        const body = {
            wolt: parseInput('wolt'),
            halyk: parseInput('halyk'),
            kaspi: parseInput('kaspi'),
            kaspi_cafe: parseInput('kaspi_cafe'),
            cash_bills: parseInput('cash_bills'),
            cash_coins: parseInput('cash_coins'),
            shift_start: parseInput('shift_start'),
            deposits: parseInput('deposits'),
            expenses: parseInput('expenses'),
            cash_to_leave: parseInput('cash_to_leave'),
            poster_trade: posterData.trade_total,
            poster_bonus: posterData.bonus,
            poster_card: posterData.poster_card,
        };

        const response = await fetch('/api/shift-closing/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await response.json();

        if (data.success) {
            const c = data.calculations;
            updateDisplay(c);
        }
    } catch (err) {
        console.error('Calculation error:', err);
    }
}

function updateDisplay(c) {
    // = Фактический
    const factTotalRow = document.getElementById('fact_total_row');
    factTotalRow.style.display = 'flex';
    document.getElementById('fact_total_value').textContent = formatMoney(c.fact_total) + ' T';

    // Итого фактич.
    const factAdjRow = document.getElementById('fact_adjusted_row');
    factAdjRow.style.display = 'flex';
    document.getElementById('fact_adjusted_value').textContent = formatMoney(c.fact_adjusted) + ' T';

    // Poster - Итого безнал
    document.getElementById('poster_cashless').textContent = formatMoney(c.fact_cashless) + ' T';

    // Cashless diff
    const cashlessDiffRow = document.getElementById('cashless_diff_row');
    const cashlessDiff = c.cashless_diff;
    if (Math.abs(cashlessDiff) >= 1) {
        cashlessDiffRow.style.display = 'flex';
        cashlessDiffRow.classList.remove('positive', 'negative');
        cashlessDiffRow.classList.add(cashlessDiff > 0 ? 'positive' : 'negative');
        document.getElementById('cashless_diff_value').textContent =
            (cashlessDiff > 0 ? '+' : '') + formatMoney(cashlessDiff) + ' T';
    } else {
        cashlessDiffRow.style.display = 'none';
    }

    // Итого Poster
    const posterTotalRow = document.getElementById('poster_total_row');
    posterTotalRow.style.display = 'flex';
    document.getElementById('poster_total_value').textContent = formatMoney(c.poster_total) + ' T';

    // ИТОГО ДЕНЬ
    const dayResult = c.day_result;
    const block = document.getElementById('day_result_block');
    const valueEl = document.getElementById('day_result_value');
    const statusEl = document.getElementById('day_result_status');

    block.classList.remove('positive', 'negative', 'zero');

    if (dayResult > 0) {
        block.classList.add('positive');
        valueEl.textContent = '+' + formatMoney(dayResult) + ' T';
        statusEl.textContent = '(излишек)';
    } else if (dayResult < 0) {
        block.classList.add('negative');
        valueEl.textContent = formatMoney(dayResult) + ' T';
        statusEl.textContent = '(недостача)';
    } else {
        block.classList.add('zero');
        valueEl.textContent = '0 T';
        statusEl.textContent = '(идеально!)';
    }

    // Смена оставили
    const shiftLeftRow = document.getElementById('shift_left_row');
    shiftLeftRow.style.display = 'flex';
    document.getElementById('shift_left_value').textContent = formatMoney(c.shift_left) + ' T';

    // Hint
    const hint = document.getElementById('shift_left_hint');
    hint.style.display = 'block';
    hint.textContent = '(' + formatMoney(parseInput('cash_to_leave')) + ' бумажные + ' +
        formatMoney(parseInput('cash_coins')) + ' мелочь)';

    // Инкассация
    const collBlock = document.getElementById('collection_block');
    collBlock.style.display = 'flex';
    document.getElementById('collection_value').textContent = formatMoney(c.collection) + ' T';
}

// Load expense report
async function loadExpenseReport() {
    const container = document.getElementById('expense-report-container');
    const textEl = document.getElementById('expense-report-text');

    try {
        const response = await fetch('/api/expense-report');
        const data = await response.json();

        if (data.success) {
            textEl.textContent = data.report;
            container.style.display = 'block';
        } else {
            alert('Ошибка: ' + (data.error || 'Не удалось загрузить отчёт'));
        }
    } catch (err) {
        console.error('Error loading expense report:', err);
        alert('Ошибка загрузки отчёта');
    }
}

// Copy report to clipboard
function copyReport() {
    const text = document.getElementById('expense-report-text').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Скопировано!');
    }).catch(() => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Скопировано!');
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const today = new Date();
    const dateStr = today.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    document.getElementById('current-date').textContent = dateStr;

    // Load Poster data automatically
    loadPosterData();
});
</script>
{% endblock %}
