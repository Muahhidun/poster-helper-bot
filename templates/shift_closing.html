{% extends "base.html" %}

{% block title %}Закрытие смены{% endblock %}

{% block content %}
<div class="sc">
    <div class="sc-header">
        <span id="current-date" class="sc-date"></span>
        <span id="orders_info" class="sc-orders"></span>
    </div>

    <div class="sc-banner" id="loading-banner">Загрузка...</div>

    <!-- Безнал -->
    <div class="sc-card">
        <div class="sc-card-title">Безнал</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>Wolt</label>
                <input type="text" id="wolt" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
            </div>
            <div class="sc-field">
                <label>Halyk</label>
                <input type="text" id="halyk" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
            </div>
        </div>
        <div class="sc-field">
            <label>Kaspi</label>
            <input type="text" id="kaspi" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
        </div>
        <div class="sc-field sc-minus">
            <label>- Kaspi Cafe</label>
            <input type="text" id="kaspi_cafe" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
        </div>
    </div>

    <!-- Наличные -->
    <div class="sc-card">
        <div class="sc-card-title">Наличные</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>Бумажные</label>
                <input type="text" id="cash_bills" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
            </div>
            <div class="sc-field">
                <label>Мелочь</label>
                <input type="text" id="cash_coins" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
            </div>
        </div>
    </div>

    <!-- Промежуточный итог -->
    <div class="sc-subtotal" id="fact_total_row" style="display:none">
        <span>Фактический</span>
        <span id="fact_total_value" class="sc-subtotal-num">0</span>
    </div>

    <!-- Смена / Расходы -->
    <div class="sc-card">
        <div class="sc-card-title">Корректировки</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>Смена (начало)</label>
                <input type="text" id="shift_start" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
            </div>
            <div class="sc-field">
                <label>Расходы с кассы</label>
                <input type="text" id="expenses" inputmode="decimal" placeholder="0" oninput="debouncedCalculate()">
            </div>
        </div>
    </div>

    <!-- Итого фактический -->
    <div class="sc-subtotal accent" id="fact_adjusted_row" style="display:none">
        <span>Итого фактич.</span>
        <span id="fact_adjusted_value" class="sc-subtotal-num">0</span>
    </div>

    <!-- Poster -->
    <div class="sc-card sc-card-poster">
        <div class="sc-card-title">Poster</div>
        <div class="sc-info-row">
            <span>Безнал факт</span>
            <span id="poster_cashless" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row">
            <span>Безнал Poster</span>
            <span id="poster_card_display" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row sc-diff" id="cashless_diff_row" style="display:none">
            <span>Разница безнал</span>
            <span id="cashless_diff_value" class="sc-info-val">0</span>
        </div>
        <div class="sc-info-sep"></div>
        <div class="sc-info-row">
            <span>Торговля</span>
            <span id="poster_trade_display" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row">
            <span>Бонусы</span>
            <span id="poster_bonus_display" class="sc-info-val sc-red">--</span>
        </div>
        <div class="sc-subtotal accent inside" id="poster_total_row" style="display:none">
            <span>Итого Poster</span>
            <span id="poster_total_value" class="sc-subtotal-num">--</span>
        </div>
    </div>

    <!-- ИТОГО ДЕНЬ -->
    <div class="sc-day-result" id="day_result_block">
        <div class="sc-day-label">ИТОГО ДЕНЬ</div>
        <div class="sc-day-value" id="day_result_value">--</div>
        <div class="sc-day-status" id="day_result_status"></div>
    </div>

    <!-- Инкассация -->
    <div class="sc-card">
        <div class="sc-card-title">Инкассация</div>
        <div class="sc-field">
            <label>Оставить на смену</label>
            <input type="text" id="cash_to_leave" inputmode="decimal" placeholder="15000" value="15000" oninput="debouncedCalculate()">
        </div>
        <div class="sc-info-row" id="shift_left_row" style="display:none">
            <span>Смена оставили</span>
            <span id="shift_left_value" class="sc-info-val">0</span>
        </div>
        <div class="sc-hint" id="shift_left_hint" style="display:none"></div>
        <div class="sc-collection" id="collection_block" style="display:none">
            <span>Инкассация</span>
            <span id="collection_value">0</span>
        </div>
    </div>

    <!-- Действия -->
    <div class="sc-actions">
        <button type="button" class="sc-btn" onclick="loadPosterData()">Обновить Poster</button>
        <button type="button" class="sc-btn sc-btn-sec" onclick="loadExpenseReport()">Отчёт расходов</button>
    </div>

    <!-- Отчёт -->
    <div id="expense-report-container" style="display:none" class="sc-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="sc-card-title" style="margin:0">Отчёт</div>
            <button type="button" class="sc-btn sc-btn-sm" onclick="copyReport()">Скопировать</button>
        </div>
        <pre id="expense-report-text" class="sc-report"></pre>
    </div>
</div>

<style>
/* ===== Mobile-first shift closing ===== */
*{box-sizing:border-box}

.sc {
    max-width: 480px;
    margin: 0 auto;
    padding: 8px 10px 24px;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    -webkit-text-size-adjust: 100%;
}

/* Header */
.sc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 4px;
}
.sc-date {
    font-size: 17px;
    font-weight: 700;
    color: #1c1c1e;
}
.sc-orders {
    font-size: 13px;
    color: #8e8e93;
}

/* Banner */
.sc-banner {
    background: #007aff20;
    color: #007aff;
    padding: 8px 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 10px;
}
.sc-banner.hidden { display: none; }
.sc-banner.error { background: #ff3b3020; color: #ff3b30; }

/* Card */
.sc-card {
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.sc-card-title {
    font-size: 13px;
    font-weight: 600;
    color: #8e8e93;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 10px;
}

/* Field */
.sc-field {
    margin-bottom: 8px;
}
.sc-field:last-child { margin-bottom: 0; }
.sc-field label {
    display: block;
    font-size: 13px;
    color: #6c6c70;
    margin-bottom: 3px;
    font-weight: 500;
}
.sc-field input {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d1d1d6;
    border-radius: 10px;
    font-size: 17px;
    text-align: right;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    color: #1c1c1e;
    background: #fff;
    -webkit-appearance: none;
    appearance: none;
    transition: border-color 0.15s;
}
.sc-field input:focus {
    outline: none;
    border-color: #007aff;
    box-shadow: 0 0 0 3px rgba(0,122,255,0.12);
}
.sc-field input::placeholder { color: #c7c7cc; }

/* Minus field */
.sc-minus label { color: #ff3b30; }
.sc-minus input {
    border-color: #ffb4ab;
    color: #ff3b30;
}
.sc-minus input:focus {
    border-color: #ff3b30;
    box-shadow: 0 0 0 3px rgba(255,59,48,0.12);
}

/* Two-col pair */
.sc-row-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
}
.sc-row-pair .sc-field { margin-bottom: 0; }

/* Subtotal */
.sc-subtotal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 10px;
    background: #f2f2f7;
    margin-bottom: 8px;
    font-size: 15px;
    font-weight: 600;
    color: #3a3a3c;
}
.sc-subtotal.accent {
    background: #007aff12;
}
.sc-subtotal.accent .sc-subtotal-num {
    color: #007aff;
}
.sc-subtotal.inside {
    margin: 8px -4px -4px;
    border-radius: 8px;
}
.sc-subtotal-num {
    font-variant-numeric: tabular-nums;
    font-size: 17px;
    font-weight: 700;
}

/* Poster info rows */
.sc-card-poster {
    background: #f9f9fb;
}
.sc-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
    color: #6c6c70;
}
.sc-info-val {
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    color: #1c1c1e;
    font-size: 15px;
}
.sc-info-val.sc-red { color: #ff3b30; }
.sc-info-sep {
    height: 1px;
    background: #e5e5ea;
    margin: 6px 0;
}

/* Diff row */
.sc-diff { border-radius: 6px; padding: 6px 8px; }
.sc-diff.positive { background: #34c75920; }
.sc-diff.positive .sc-info-val { color: #30d158; }
.sc-diff.negative { background: #ff3b3015; }
.sc-diff.negative .sc-info-val { color: #ff3b30; }

/* Day result */
.sc-day-result {
    text-align: center;
    padding: 20px 12px;
    border-radius: 14px;
    margin-bottom: 8px;
    background: #f2f2f7;
    transition: background 0.2s;
}
.sc-day-result.positive { background: #34c75920; }
.sc-day-result.negative { background: #ff3b3018; }
.sc-day-result.zero { background: #007aff15; }
.sc-day-label {
    font-size: 11px;
    color: #8e8e93;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 4px;
}
.sc-day-value {
    font-size: 38px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    color: #3a3a3c;
    line-height: 1.1;
}
.sc-day-result.positive .sc-day-value { color: #30d158; }
.sc-day-result.negative .sc-day-value { color: #ff3b30; }
.sc-day-result.zero .sc-day-value { color: #007aff; }
.sc-day-status {
    font-size: 14px;
    margin-top: 4px;
    color: #8e8e93;
}
.sc-day-result.positive .sc-day-status { color: #30d158; }
.sc-day-result.negative .sc-day-status { color: #ff3b30; }
.sc-day-result.zero .sc-day-status { color: #007aff; }

/* Collection */
.sc-collection {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-radius: 10px;
    background: #1c1c1e;
    margin-top: 10px;
    font-size: 16px;
    font-weight: 700;
    color: #fff;
}
.sc-collection span:last-child {
    font-size: 20px;
    font-variant-numeric: tabular-nums;
}

.sc-hint {
    text-align: center;
    font-size: 11px;
    color: #aeaeb2;
    margin-top: 2px;
}

/* Buttons */
.sc-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}
.sc-btn {
    flex: 1;
    padding: 10px 0;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    background: #007aff;
    color: #fff;
    -webkit-appearance: none;
    transition: opacity 0.15s;
}
.sc-btn:active { opacity: 0.7; }
.sc-btn-sec {
    background: #e5e5ea;
    color: #1c1c1e;
}
.sc-btn-sm {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    background: #e5e5ea;
    color: #1c1c1e;
}

/* Report */
.sc-report {
    background: #1c1c1e;
    color: #e5e5ea;
    padding: 12px;
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 400px;
    overflow-y: auto;
    margin: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}

/* Loading */
.loading { opacity: 0.5; pointer-events: none; }

/* Tiny screens (iPhone SE) */
@media (max-width: 374px) {
    .sc { padding: 6px 8px 20px; }
    .sc-field input { font-size: 16px; padding: 9px 10px; }
    .sc-day-value { font-size: 32px; }
    .sc-collection span:last-child { font-size: 18px; }
}
</style>

<script>
let posterData = null;
let debounceTimer = null;

function fmt(n) {
    return Math.round(n).toLocaleString('ru-RU');
}

function pi(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    return parseFloat(el.value.replace(/\s/g, '').replace(/,/g, '.')) || 0;
}

function debouncedCalculate() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculate, 250);
}

async function loadPosterData() {
    const b = document.getElementById('loading-banner');
    b.textContent = 'Загрузка Poster...';
    b.classList.remove('hidden', 'error');

    try {
        document.querySelector('.sc').classList.add('loading');
        const r = await fetch('/api/shift-closing/poster-data');
        const d = await r.json();

        if (d.success) {
            posterData = d;

            // Auto-fill shift_start from Poster (cash drawer opening balance)
            if (d.shift_start && d.shift_start !== 0)
                document.getElementById('shift_start').value = String(Math.round(d.shift_start / 100));

            // Display Poster data (all in tiyins, convert to tenge)
            document.getElementById('poster_trade_display').textContent = fmt(d.trade_total / 100);
            document.getElementById('poster_bonus_display').textContent = '-' + fmt(d.bonus / 100);
            document.getElementById('poster_card_display').textContent = fmt(d.poster_card / 100);

            const oi = document.getElementById('orders_info');
            oi.textContent = d.transactions_count + ' заказов';

            b.textContent = 'Готово';
            setTimeout(() => b.classList.add('hidden'), 1500);
            calculate();
        } else {
            b.textContent = d.error || 'Ошибка';
            b.classList.add('error');
        }
    } catch (e) {
        b.textContent = 'Ошибка загрузки';
        b.classList.add('error');
    } finally {
        document.querySelector('.sc').classList.remove('loading');
    }
}

async function calculate() {
    if (!posterData) return;

    try {
        const body = {
            wolt: pi('wolt'), halyk: pi('halyk'),
            kaspi: pi('kaspi'), kaspi_cafe: pi('kaspi_cafe'),
            cash_bills: pi('cash_bills'), cash_coins: pi('cash_coins'),
            shift_start: pi('shift_start'),
            expenses: pi('expenses'), cash_to_leave: pi('cash_to_leave'),
            poster_trade: posterData.trade_total,
            poster_bonus: posterData.bonus,
            poster_card: posterData.poster_card,
        };

        const r = await fetch('/api/shift-closing/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const d = await r.json();
        if (d.success) show(d.calculations);
    } catch (e) {}
}

function show(c) {
    // Factual
    document.getElementById('fact_total_row').style.display = 'flex';
    document.getElementById('fact_total_value').textContent = fmt(c.fact_total);

    document.getElementById('fact_adjusted_row').style.display = 'flex';
    document.getElementById('fact_adjusted_value').textContent = fmt(c.fact_adjusted);

    // Poster cashless
    document.getElementById('poster_cashless').textContent = fmt(c.fact_cashless);

    // Cashless diff
    const cdr = document.getElementById('cashless_diff_row');
    if (Math.abs(c.cashless_diff) >= 1) {
        cdr.style.display = 'flex';
        cdr.classList.remove('positive', 'negative');
        cdr.classList.add(c.cashless_diff > 0 ? 'positive' : 'negative');
        document.getElementById('cashless_diff_value').textContent =
            (c.cashless_diff > 0 ? '+' : '') + fmt(c.cashless_diff);
    } else {
        cdr.style.display = 'none';
    }

    // Poster total
    document.getElementById('poster_total_row').style.display = 'flex';
    document.getElementById('poster_total_value').textContent = fmt(c.poster_total);

    // Day result
    const dr = c.day_result;
    const bl = document.getElementById('day_result_block');
    const vl = document.getElementById('day_result_value');
    const st = document.getElementById('day_result_status');
    bl.classList.remove('positive', 'negative', 'zero');

    if (dr > 0) {
        bl.classList.add('positive');
        vl.textContent = '+' + fmt(dr);
        st.textContent = 'излишек';
    } else if (dr < 0) {
        bl.classList.add('negative');
        vl.textContent = fmt(dr);
        st.textContent = 'недостача';
    } else {
        bl.classList.add('zero');
        vl.textContent = '0';
        st.textContent = 'идеально';
    }

    // Shift left
    document.getElementById('shift_left_row').style.display = 'flex';
    document.getElementById('shift_left_value').textContent = fmt(c.shift_left);

    const h = document.getElementById('shift_left_hint');
    h.style.display = 'block';
    h.textContent = fmt(pi('cash_to_leave')) + ' + ' + fmt(pi('cash_coins')) + ' мелочь';

    // Collection
    document.getElementById('collection_block').style.display = 'flex';
    document.getElementById('collection_value').textContent = fmt(c.collection);
}

async function loadExpenseReport() {
    try {
        const r = await fetch('/api/expense-report');
        const d = await r.json();
        if (d.success) {
            document.getElementById('expense-report-text').textContent = d.report;
            document.getElementById('expense-report-container').style.display = 'block';
        }
    } catch (e) {}
}

function copyReport() {
    const t = document.getElementById('expense-report-text').textContent;
    navigator.clipboard.writeText(t).then(() => {
        const btn = event.target;
        btn.textContent = 'Готово';
        setTimeout(() => btn.textContent = 'Скопировать', 1500);
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('current-date').textContent =
        new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    loadPosterData();
});
</script>
{% endblock %}
