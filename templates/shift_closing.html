{% extends "base.html" %}

{% block title %}–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã - PizzBurg{% endblock %}

{% block content %}
<div class="shift-closing-container">
    <h1>–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã</h1>

    <div class="date-header">
        <span id="current-date"></span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadPosterData()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Poster
        </button>
    </div>

    <div class="form-grid">
        <!-- Left Column - Manual Input -->
        <div class="form-section">
            <h3>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</h3>

            <!-- –ë–µ–∑–Ω–∞–ª —Ç–µ—Ä–º–∏–Ω–∞–ª—ã -->
            <div class="input-group-header">–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã</div>

            <div class="input-row two-col">
                <div class="input-field">
                    <label>Wolt</label>
                    <input type="text" id="wolt" inputmode="numeric" placeholder="0" oninput="calculate()">
                </div>
                <div class="input-field">
                    <label>Halyk</label>
                    <input type="text" id="halyk" inputmode="numeric" placeholder="0" oninput="calculate()">
                </div>
            </div>

            <div class="input-field">
                <label>Kaspi —Ç–µ—Ä–º–∏–Ω–∞–ª</label>
                <input type="text" id="kaspi" inputmode="numeric" placeholder="0" oninput="calculate()">
            </div>

            <div class="input-field minus">
                <label>- Kaspi –æ—Ç PizzBurg-Cafe</label>
                <input type="text" id="kaspi_cafe" inputmode="numeric" placeholder="0" oninput="calculate()">
            </div>

            <!-- –ò—Ç–æ–≥–æ –±–µ–∑–Ω–∞–ª -->
            <div class="calculated-row">
                <span>–ò—Ç–æ–≥–æ –±–µ–∑–Ω–∞–ª:</span>
                <span id="fact_cashless" class="value">0</span>
                <span class="currency">‚Ç∏</span>
            </div>

            <!-- –ù–∞–ª–∏—á–∫–∞ -->
            <div class="input-group-header">–ù–∞–ª–∏—á–Ω—ã–µ</div>

            <div class="input-row two-col">
                <div class="input-field">
                    <label>–ë—É–º–∞–∂–Ω—ã–µ</label>
                    <input type="text" id="cash_bills" inputmode="numeric" placeholder="0" oninput="calculate()">
                </div>
                <div class="input-field">
                    <label>–ú–µ–ª–æ—á—å</label>
                    <input type="text" id="cash_coins" inputmode="numeric" placeholder="0" oninput="calculate()">
                </div>
            </div>

            <!-- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π -->
            <div class="calculated-row highlight">
                <span>= –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π:</span>
                <span id="fact_total" class="value">0</span>
                <span class="currency">‚Ç∏</span>
            </div>

            <!-- –°–º–µ–Ω–∞ –∏ —Ä–∞—Å—Ö–æ–¥—ã -->
            <div class="input-group-header">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</div>

            <div class="input-field">
                <label>–°–º–µ–Ω–∞ (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ)</label>
                <input type="text" id="shift_start" inputmode="numeric" placeholder="0" oninput="calculate()">
            </div>

            <div class="input-field">
                <label>–í–Ω–µ—Å–µ–Ω–∏–µ</label>
                <input type="text" id="deposits" inputmode="numeric" value="0" oninput="calculate()">
            </div>

            <div class="input-field">
                <label>–†–∞—Å—Ö–æ–¥ —Å –∫–∞—Å—Å—ã</label>
                <input type="text" id="expenses" inputmode="numeric" placeholder="0" oninput="calculate()">
            </div>

            <!-- –ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π -->
            <div class="calculated-row highlight">
                <span>–ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á.:</span>
                <span id="fact_adjusted" class="value">0</span>
                <span class="currency">‚Ç∏</span>
            </div>
        </div>

        <!-- Right Column - Poster Data & Results -->
        <div class="form-section">
            <h3>–î–∞–Ω–Ω—ã–µ Poster</h3>

            <div class="poster-data">
                <div class="poster-row">
                    <span>–ö–∞—Ä—Ç–æ–π (Poster):</span>
                    <span id="poster_card" class="value">‚Äî</span>
                    <span class="currency">‚Ç∏</span>
                </div>

                <div class="poster-row diff" id="cashless_diff_row" style="display: none;">
                    <span>–†–∞–∑–Ω–∏—Ü–∞ –±–µ–∑–Ω–∞–ª:</span>
                    <span id="cashless_diff" class="value">0</span>
                    <span class="currency">‚Ç∏</span>
                </div>
            </div>

            <div class="input-group-header">–¢–æ—Ä–≥–æ–≤–ª—è –ø–æ Poster</div>

            <div class="poster-data">
                <div class="poster-row">
                    <span>Poster (—Ç–æ—Ä–≥–æ–≤–ª—è):</span>
                    <span id="poster_trade" class="value">‚Äî</span>
                    <span class="currency">‚Ç∏</span>
                </div>

                <div class="poster-row minus">
                    <span>–ë–æ–Ω—É—Å—ã:</span>
                    <span id="poster_bonus" class="value">‚Äî</span>
                    <span class="currency">‚Ç∏</span>
                </div>

                <div class="calculated-row highlight">
                    <span>–ò—Ç–æ–≥–æ Poster:</span>
                    <span id="poster_total" class="value">0</span>
                    <span class="currency">‚Ç∏</span>
                </div>
            </div>

            <div class="poster-info">
                <span>–ó–∞–∫—Ä—ã—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤: <strong id="transactions_count">‚Äî</strong></span>
            </div>
        </div>
    </div>

    <!-- Day Result - Big Block -->
    <div class="day-result" id="day_result_block">
        <div class="day-result-label">–ò–¢–û–ì–û –î–ï–ù–¨</div>
        <div class="day-result-value" id="day_result">0 ‚Ç∏</div>
        <div class="day-result-status" id="day_result_status"></div>
    </div>

    <!-- Bottom Section -->
    <div class="bottom-section">
        <div class="input-row">
            <div class="input-field">
                <label>–û—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–º–µ–Ω—É (–±—É–º–∞–∂–Ω—ã–µ)</label>
                <input type="text" id="cash_to_leave" inputmode="numeric" value="15000" oninput="calculate()">
            </div>
        </div>

        <div class="results-row">
            <div class="result-item">
                <span class="result-label">–°–º–µ–Ω–∞ –æ—Å—Ç–∞–≤–∏–ª–∏:</span>
                <span class="result-value" id="shift_left">0 ‚Ç∏</span>
                <span class="result-detail" id="shift_left_detail"></span>
            </div>

            <div class="result-item primary">
                <span class="result-label">–ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è:</span>
                <span class="result-value" id="collection">0 ‚Ç∏</span>
            </div>
        </div>
    </div>
</div>

<style>
.shift-closing-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    margin-bottom: 20px;
    text-align: center;
}

.date-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}

.form-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
}

.form-section h3 {
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
    color: #333;
}

.input-group-header {
    font-size: 12px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    margin: 20px 0 10px 0;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.input-group-header:first-of-type {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
}

.input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.input-row.two-col .input-field {
    flex: 1;
}

.input-field {
    margin-bottom: 10px;
}

.input-field label {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 4px;
}

.input-field.minus label {
    color: #dc3545;
}

.input-field input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    text-align: right;
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.input-field input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.input-field.minus input {
    border-color: #f8d7da;
    background: #fff5f5;
}

.calculated-row {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    margin: 15px 0;
    font-weight: 600;
}

.calculated-row.highlight {
    background: #e3f2fd;
    color: #1565c0;
}

.calculated-row span:first-child {
    flex: 1;
}

.calculated-row .value {
    font-family: 'Courier New', monospace;
    font-size: 18px;
    margin-right: 5px;
}

.calculated-row .currency {
    color: #666;
}

.poster-data {
    margin-bottom: 15px;
}

.poster-row {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
}

.poster-row span:first-child {
    flex: 1;
    color: #666;
}

.poster-row .value {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    margin-right: 5px;
}

.poster-row.minus .value {
    color: #dc3545;
}

.poster-row.minus .value::before {
    content: '-';
}

.poster-row.diff {
    background: #fff3cd;
}

.poster-row.diff.positive {
    background: #d4edda;
}

.poster-row.diff.negative {
    background: #f8d7da;
}

.poster-info {
    text-align: center;
    color: #666;
    font-size: 14px;
    margin-top: 15px;
}

/* Day Result Block */
.day-result {
    text-align: center;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 20px;
    background: #f8f9fa;
    transition: background-color 0.3s;
}

.day-result.positive {
    background: #d4edda;
}

.day-result.negative {
    background: #f8d7da;
}

.day-result.zero {
    background: #e3f2fd;
}

.day-result-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.day-result-value {
    font-size: 48px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    color: #333;
    transition: color 0.3s;
}

.day-result.positive .day-result-value {
    color: #28a745;
}

.day-result.negative .day-result-value {
    color: #dc3545;
}

.day-result.zero .day-result-value {
    color: #007bff;
}

.day-result-status {
    font-size: 18px;
    margin-top: 10px;
}

/* Bottom Section */
.bottom-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
}

.results-row {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

@media (max-width: 768px) {
    .results-row {
        flex-direction: column;
    }
}

.result-item {
    flex: 1;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.result-item.primary {
    background: #007bff;
    color: white;
}

.result-label {
    display: block;
    font-size: 14px;
    margin-bottom: 8px;
}

.result-item.primary .result-label {
    color: rgba(255,255,255,0.8);
}

.result-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
}

.result-detail {
    display: block;
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

/* Loading state */
.loading {
    opacity: 0.6;
    pointer-events: none;
}
</style>

<script>
// Poster data storage
let posterData = {
    trade_total: 0,
    bonus: 0,
    poster_card: 0,
    shift_start: 0,
    transactions_count: 0
};

// Format number with spaces
function formatMoney(num) {
    return Math.round(num).toLocaleString('ru-RU');
}

// Parse input value
function parseInput(id) {
    const value = document.getElementById(id).value.replace(/\s/g, '').replace(/,/g, '.');
    return parseFloat(value) || 0;
}

// Load Poster data
async function loadPosterData() {
    try {
        document.querySelector('.shift-closing-container').classList.add('loading');

        const response = await fetch('/api/shift-closing/poster-data');
        const data = await response.json();

        if (data.success) {
            posterData = data;

            // Update display (convert from tiyins to tenge)
            document.getElementById('poster_trade').textContent = formatMoney(data.trade_total / 100);
            document.getElementById('poster_bonus').textContent = formatMoney(data.bonus / 100);
            document.getElementById('poster_card').textContent = formatMoney(data.poster_card / 100);
            document.getElementById('transactions_count').textContent = data.transactions_count;

            // Set shift start if available
            if (data.shift_start > 0) {
                document.getElementById('shift_start').value = Math.round(data.shift_start / 100);
            }

            calculate();
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Error loading Poster data:', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Poster');
    } finally {
        document.querySelector('.shift-closing-container').classList.remove('loading');
    }
}

// Calculate all values
function calculate() {
    // Get input values
    const wolt = parseInput('wolt');
    const halyk = parseInput('halyk');
    const kaspi = parseInput('kaspi');
    const kaspi_cafe = parseInput('kaspi_cafe');
    const cash_bills = parseInput('cash_bills');
    const cash_coins = parseInput('cash_coins');
    const shift_start = parseInput('shift_start');
    const deposits = parseInput('deposits');
    const expenses = parseInput('expenses');
    const cash_to_leave = parseInput('cash_to_leave');

    // Poster data (in tiyins, convert to tenge)
    const poster_trade = posterData.trade_total / 100;
    const poster_bonus = posterData.bonus / 100;
    const poster_card = posterData.poster_card / 100;

    // Calculations
    // 1. –ò—Ç–æ–≥–æ –±–µ–∑–Ω–∞–ª —Ñ–∞–∫—Ç
    const fact_cashless = wolt + halyk + (kaspi - kaspi_cafe);
    document.getElementById('fact_cashless').textContent = formatMoney(fact_cashless);

    // 2. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π
    const fact_total = fact_cashless + cash_bills + cash_coins;
    document.getElementById('fact_total').textContent = formatMoney(fact_total);

    // 3. –ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π
    const fact_adjusted = fact_total - shift_start - deposits + expenses;
    document.getElementById('fact_adjusted').textContent = formatMoney(fact_adjusted);

    // 4. –ò—Ç–æ–≥–æ Poster
    const poster_total = poster_trade - poster_bonus;
    document.getElementById('poster_total').textContent = formatMoney(poster_total);

    // 5. –ò–¢–û–ì–û –î–ï–ù–¨
    const day_result = fact_adjusted - poster_total;
    const dayResultBlock = document.getElementById('day_result_block');
    const dayResultValue = document.getElementById('day_result');
    const dayResultStatus = document.getElementById('day_result_status');

    dayResultBlock.classList.remove('positive', 'negative', 'zero');

    if (day_result > 0) {
        dayResultBlock.classList.add('positive');
        dayResultValue.textContent = '+' + formatMoney(day_result) + ' ‚Ç∏';
        dayResultStatus.textContent = '(–∏–∑–ª–∏—à–µ–∫)';
    } else if (day_result < 0) {
        dayResultBlock.classList.add('negative');
        dayResultValue.textContent = formatMoney(day_result) + ' ‚Ç∏';
        dayResultStatus.textContent = '(–Ω–µ–¥–æ—Å—Ç–∞—á–∞)';
    } else {
        dayResultBlock.classList.add('zero');
        dayResultValue.textContent = '0 ‚Ç∏';
        dayResultStatus.textContent = '(–∏–¥–µ–∞–ª—å–Ω–æ!)';
    }

    // 6. –†–∞–∑–Ω–∏—Ü–∞ –±–µ–∑–Ω–∞–ª–∞
    const cashless_diff = fact_cashless - poster_card;
    const diffRow = document.getElementById('cashless_diff_row');
    const diffValue = document.getElementById('cashless_diff');

    if (Math.abs(cashless_diff) >= 1 && poster_card > 0) {
        diffRow.style.display = 'flex';
        diffRow.classList.remove('positive', 'negative');
        diffRow.classList.add(cashless_diff > 0 ? 'positive' : 'negative');
        diffValue.textContent = (cashless_diff > 0 ? '+' : '') + formatMoney(cashless_diff);
    } else {
        diffRow.style.display = 'none';
    }

    // 7. –°–º–µ–Ω–∞ –æ—Å—Ç–∞–≤–∏–ª–∏
    const shift_left = cash_to_leave + cash_coins;
    document.getElementById('shift_left').textContent = formatMoney(shift_left) + ' ‚Ç∏';
    document.getElementById('shift_left_detail').textContent =
        `(${formatMoney(cash_to_leave)} –±—É–º–∞–∂–Ω—ã–µ + ${formatMoney(cash_coins)} –º–µ–ª–æ—á—å)`;

    // 8. –ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è
    const collection = cash_bills - cash_to_leave + expenses;
    document.getElementById('collection').textContent = formatMoney(collection) + ' ‚Ç∏';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const today = new Date();
    const dateStr = today.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    document.getElementById('current-date').textContent = dateStr;

    // Load Poster data automatically
    loadPosterData();

    // Initial calculation
    calculate();
});
</script>
{% endblock %}
