{% extends "base.html" %}

{% block title %}Закрытие смены - PizzBurg{% endblock %}

{% block content %}
<div class="shift-closing-container">
    <h1>Закрытие смены</h1>

    <div class="date-header">
        <span id="current-date"></span>
        <span id="accounts-info" class="accounts-badge"></span>
    </div>

    <div class="info-banner" id="loading-banner">
        Загрузка данных Poster...
    </div>

    <!-- Main reconciliation grid -->
    <div class="reconciliation-grid">
        <!-- Halyk -->
        <div class="reconciliation-card">
            <div class="card-header">
                <span class="card-title">Halyk</span>
            </div>
            <div class="card-body">
                <div class="input-row">
                    <label>Факт:</label>
                    <div class="input-wrapper">
                        <input type="text" id="halyk_fact" inputmode="numeric" placeholder="0" oninput="calculate()">
                        <span class="currency">₸</span>
                    </div>
                </div>
                <div class="result-row">
                    <span class="result-label">Poster:</span>
                    <span class="result-value" id="halyk_poster">—</span>
                </div>
                <div class="diff-row" id="halyk_diff_row">
                    <span class="diff-label">Разница:</span>
                    <span class="diff-value" id="halyk_diff">0 ₸</span>
                </div>
            </div>
        </div>

        <!-- Kaspi -->
        <div class="reconciliation-card">
            <div class="card-header">
                <span class="card-title">Kaspi</span>
            </div>
            <div class="card-body">
                <div class="input-row">
                    <label>Факт:</label>
                    <div class="input-wrapper">
                        <input type="text" id="kaspi_fact" inputmode="numeric" placeholder="0" oninput="calculate()">
                        <span class="currency">₸</span>
                    </div>
                </div>
                <div class="result-row">
                    <span class="result-label">Poster:</span>
                    <span class="result-value" id="kaspi_poster">—</span>
                </div>
                <div class="diff-row" id="kaspi_diff_row">
                    <span class="diff-label">Разница:</span>
                    <span class="diff-value" id="kaspi_diff">0 ₸</span>
                </div>
            </div>
        </div>

        <!-- Cash -->
        <div class="reconciliation-card">
            <div class="card-header">
                <span class="card-title">Наличные</span>
            </div>
            <div class="card-body">
                <div class="input-row">
                    <label>Факт:</label>
                    <div class="input-wrapper">
                        <input type="text" id="cash_fact" inputmode="numeric" placeholder="0" oninput="calculate()">
                        <span class="currency">₸</span>
                    </div>
                </div>
                <div class="result-row">
                    <span class="result-label">Poster:</span>
                    <span class="result-value" id="cash_poster">—</span>
                </div>
                <div class="diff-row" id="cash_diff_row">
                    <span class="diff-label">Разница:</span>
                    <span class="diff-value" id="cash_diff">0 ₸</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Total summary -->
    <div class="total-section">
        <div class="total-row">
            <span class="total-label">ИТОГО Факт:</span>
            <span class="total-value" id="total_fact">0 ₸</span>
        </div>
        <div class="total-row">
            <span class="total-label">ИТОГО Poster:</span>
            <span class="total-value" id="total_poster">0 ₸</span>
        </div>
        <div class="total-row main" id="total_diff_row">
            <span class="total-label">РАЗНИЦА:</span>
            <span class="total-value" id="total_diff">0 ₸</span>
        </div>
    </div>

    <!-- Day Result - Big Block -->
    <div class="day-result" id="day_result_block">
        <div class="day-result-label">ИТОГО ДЕНЬ</div>
        <div class="day-result-value" id="day_result">0 ₸</div>
        <div class="day-result-status" id="day_result_status"></div>
    </div>

    <!-- Refresh button -->
    <div class="actions-section">
        <button type="button" class="btn btn-primary" onclick="loadPosterData()">
            Обновить данные Poster
        </button>
    </div>

    <!-- Expense Report Section -->
    <div class="expense-report-section">
        <div class="expense-report-header">
            <h3>Отчёт по расходам</h3>
            <button type="button" class="btn btn-secondary" onclick="loadExpenseReport()">
                Сформировать отчёт
            </button>
        </div>
        <div id="expense-report-container" style="display: none;">
            <div class="report-actions">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyReport()">
                    Скопировать
                </button>
            </div>
            <pre id="expense-report-text" class="expense-report-text"></pre>
        </div>
    </div>
</div>

<style>
.shift-closing-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    margin-bottom: 20px;
    text-align: center;
}

.date-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
}

.accounts-badge {
    font-size: 14px;
    color: #666;
    font-weight: normal;
}

.info-banner {
    background: #e3f2fd;
    color: #1565c0;
    padding: 12px 16px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
}

.info-banner.hidden {
    display: none;
}

.info-banner.error {
    background: #f8d7da;
    color: #721c24;
}

/* Reconciliation Grid */
.reconciliation-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.reconciliation-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.card-header {
    background: #f8f9fa;
    padding: 12px 16px;
    border-bottom: 1px solid #e0e0e0;
}

.card-title {
    font-weight: 600;
    font-size: 16px;
    color: #333;
}

.card-body {
    padding: 16px;
}

.input-row {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.input-row label {
    width: 60px;
    font-size: 14px;
    color: #666;
}

.input-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
}

.input-wrapper input {
    flex: 1;
    padding: 12px 14px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 18px;
    text-align: right;
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.input-wrapper input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.input-wrapper .currency {
    font-size: 16px;
    color: #666;
    font-weight: 600;
}

.result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
}

.result-label {
    font-size: 14px;
    color: #888;
}

.result-value {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    color: #666;
}

.diff-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    margin-top: 10px;
    border-radius: 6px;
    background: #f8f9fa;
    transition: background-color 0.2s;
}

.diff-row.positive {
    background: #d4edda;
}

.diff-row.negative {
    background: #f8d7da;
}

.diff-row.zero {
    background: #e3f2fd;
}

.diff-label {
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.diff-value {
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #333;
}

.diff-row.positive .diff-value {
    color: #28a745;
}

.diff-row.negative .diff-value {
    color: #dc3545;
}

.diff-row.zero .diff-value {
    color: #007bff;
}

/* Total Section */
.total-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 20px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.total-row:last-child {
    border-bottom: none;
}

.total-row.main {
    padding-top: 15px;
    margin-top: 5px;
    border-top: 2px solid #333;
    border-bottom: none;
}

.total-label {
    font-size: 15px;
    color: #666;
}

.total-row.main .total-label {
    font-weight: 700;
    color: #333;
    font-size: 16px;
}

.total-value {
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: 600;
}

.total-row.main .total-value {
    font-size: 22px;
    font-weight: 700;
}

.total-row.main.positive .total-value {
    color: #28a745;
}

.total-row.main.negative .total-value {
    color: #dc3545;
}

.total-row.main.zero .total-value {
    color: #007bff;
}

/* Day Result Block */
.day-result {
    text-align: center;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 20px;
    background: #f8f9fa;
    transition: background-color 0.3s;
}

.day-result.positive {
    background: #d4edda;
}

.day-result.negative {
    background: #f8d7da;
}

.day-result.zero {
    background: #e3f2fd;
}

.day-result-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.day-result-value {
    font-size: 48px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    color: #333;
    transition: color 0.3s;
}

.day-result.positive .day-result-value {
    color: #28a745;
}

.day-result.negative .day-result-value {
    color: #dc3545;
}

.day-result.zero .day-result-value {
    color: #007bff;
}

.day-result-status {
    font-size: 18px;
    margin-top: 10px;
}

/* Actions */
.actions-section {
    text-align: center;
    margin-bottom: 30px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
}

.btn-outline-secondary {
    background: transparent;
    border: 1px solid #6c757d;
    color: #6c757d;
}

.btn-outline-secondary:hover {
    background: #6c757d;
    color: white;
}

/* Expense Report Section */
.expense-report-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
}

.expense-report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.expense-report-header h3 {
    margin: 0;
    color: #333;
}

.report-actions {
    margin-bottom: 10px;
    text-align: right;
}

.expense-report-text {
    background: #1a1a2e;
    color: #eee;
    padding: 20px;
    border-radius: 8px;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 600px;
    overflow-y: auto;
}

/* Loading state */
.loading {
    opacity: 0.6;
    pointer-events: none;
}
</style>

<script>
// Poster data storage
let posterData = {
    poster_cash: 0,
    poster_card: 0,
    loaded: false
};

// Format number with spaces
function formatMoney(num) {
    return Math.round(num).toLocaleString('ru-RU');
}

// Parse input value
function parseInput(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const value = el.value.replace(/\s/g, '').replace(/,/g, '.');
    return parseFloat(value) || 0;
}

// Set diff row state
function setDiffState(rowId, value) {
    const row = document.getElementById(rowId);
    row.classList.remove('positive', 'negative', 'zero');
    if (value > 0) {
        row.classList.add('positive');
    } else if (value < 0) {
        row.classList.add('negative');
    } else {
        row.classList.add('zero');
    }
}

// Load Poster data
async function loadPosterData() {
    const banner = document.getElementById('loading-banner');
    banner.textContent = 'Загрузка данных Poster...';
    banner.classList.remove('hidden', 'error');

    try {
        document.querySelector('.shift-closing-container').classList.add('loading');

        const response = await fetch('/api/shift-closing/poster-data');
        const data = await response.json();

        if (data.success) {
            posterData = {
                // Poster stores in tiyins, convert to tenge
                poster_cash: data.poster_cash / 100,
                poster_card: data.poster_card / 100,
                loaded: true
            };

            // Update Poster values display
            document.getElementById('cash_poster').textContent = formatMoney(posterData.poster_cash) + ' ₸';

            // For Halyk/Kaspi - Poster doesn't distinguish, so we show total card
            // Note: user needs to enter their own Halyk and Kaspi facts
            // Poster card = total of all card payments (Halyk + Kaspi combined)
            document.getElementById('halyk_poster').textContent = '(см. итого)';
            document.getElementById('kaspi_poster').textContent = '(см. итого)';

            // Show accounts info
            const accountsInfo = document.getElementById('accounts-info');
            accountsInfo.textContent = `${data.accounts_count} заведений, ${data.transactions_count} заказов`;

            banner.textContent = `Данные загружены: ${data.accounts_count} заведений`;
            setTimeout(() => banner.classList.add('hidden'), 2000);

            calculate();
        } else {
            banner.textContent = 'Ошибка: ' + (data.error || 'Unknown error');
            banner.classList.add('error');
        }
    } catch (e) {
        console.error('Error loading Poster data:', e);
        banner.textContent = 'Не удалось загрузить данные';
        banner.classList.add('error');
    } finally {
        document.querySelector('.shift-closing-container').classList.remove('loading');
    }
}

// Calculate all values
function calculate() {
    // Get input values
    const halyk_fact = parseInput('halyk_fact');
    const kaspi_fact = parseInput('kaspi_fact');
    const cash_fact = parseInput('cash_fact');

    // Total factual
    const total_fact = halyk_fact + kaspi_fact + cash_fact;

    // Total from Poster
    const total_poster = posterData.poster_card + posterData.poster_cash;

    // Card total from Poster (Halyk + Kaspi combined in Poster)
    const poster_card_total = posterData.poster_card;

    // For individual diffs, we compare:
    // - Halyk: fact vs portion of poster_card (but Poster doesn't split)
    // - Kaspi: fact vs portion of poster_card (but Poster doesn't split)
    // - Cash: fact vs poster_cash

    // Since Poster doesn't distinguish Halyk/Kaspi, we compare totals
    const fact_card_total = halyk_fact + kaspi_fact;
    const card_diff = fact_card_total - poster_card_total;

    // Cash diff
    const cash_diff = cash_fact - posterData.poster_cash;

    // Total diff
    const total_diff = total_fact - total_poster;

    // Update displays

    // Halyk - show combined card diff
    document.getElementById('halyk_diff').textContent =
        (card_diff >= 0 ? '+' : '') + formatMoney(card_diff) + ' ₸ (карты)';
    setDiffState('halyk_diff_row', card_diff);

    // Kaspi - hide individual diff since it's combined
    document.getElementById('kaspi_diff').textContent = '—';
    document.getElementById('kaspi_diff_row').classList.remove('positive', 'negative');
    document.getElementById('kaspi_diff_row').classList.add('zero');

    // Cash
    document.getElementById('cash_diff').textContent =
        (cash_diff >= 0 ? '+' : '') + formatMoney(cash_diff) + ' ₸';
    setDiffState('cash_diff_row', cash_diff);

    // Totals
    document.getElementById('total_fact').textContent = formatMoney(total_fact) + ' ₸';
    document.getElementById('total_poster').textContent = formatMoney(total_poster) + ' ₸';
    document.getElementById('total_diff').textContent =
        (total_diff >= 0 ? '+' : '') + formatMoney(total_diff) + ' ₸';

    // Total diff row state
    const totalDiffRow = document.getElementById('total_diff_row');
    totalDiffRow.classList.remove('positive', 'negative', 'zero');
    if (total_diff > 0) {
        totalDiffRow.classList.add('positive');
    } else if (total_diff < 0) {
        totalDiffRow.classList.add('negative');
    } else {
        totalDiffRow.classList.add('zero');
    }

    // Day result block
    const dayResultBlock = document.getElementById('day_result_block');
    const dayResultValue = document.getElementById('day_result');
    const dayResultStatus = document.getElementById('day_result_status');

    dayResultBlock.classList.remove('positive', 'negative', 'zero');

    if (total_diff > 0) {
        dayResultBlock.classList.add('positive');
        dayResultValue.textContent = '+' + formatMoney(total_diff) + ' ₸';
        dayResultStatus.textContent = '(излишек)';
    } else if (total_diff < 0) {
        dayResultBlock.classList.add('negative');
        dayResultValue.textContent = formatMoney(total_diff) + ' ₸';
        dayResultStatus.textContent = '(недостача)';
    } else {
        dayResultBlock.classList.add('zero');
        dayResultValue.textContent = '0 ₸';
        dayResultStatus.textContent = posterData.loaded ? '(идеально!)' : '';
    }
}

// Load expense report
async function loadExpenseReport() {
    const container = document.getElementById('expense-report-container');
    const textEl = document.getElementById('expense-report-text');

    try {
        const response = await fetch('/api/expense-report');
        const data = await response.json();

        if (data.success) {
            textEl.textContent = data.report;
            container.style.display = 'block';
        } else {
            alert('Ошибка: ' + (data.error || 'Не удалось загрузить отчёт'));
        }
    } catch (err) {
        console.error('Error loading expense report:', err);
        alert('Ошибка загрузки отчёта');
    }
}

// Copy report to clipboard
function copyReport() {
    const text = document.getElementById('expense-report-text').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Скопировано!');
    }).catch(err => {
        console.error('Copy failed:', err);
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Скопировано!');
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const today = new Date();
    const dateStr = today.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
    document.getElementById('current-date').textContent = dateStr;

    // Load Poster data automatically
    loadPosterData();

    // Initial calculation
    calculate();
});
</script>
{% endblock %}
