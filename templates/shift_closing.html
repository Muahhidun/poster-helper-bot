{% extends "base.html" %}

{% block title %}–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã{% endblock %}

{% block content %}
<div class="sc">
    <!-- Staff status badges (shown between header and cards) -->
    <div class="sc-staff-bar hidden" id="staff-status-bar">
        <span class="sc-staff-badge" id="cashier-badge"></span>
        <span class="sc-staff-badge" id="cafe-badge"></span>
    </div>

    <!-- Date selector -->
    <div class="sc-dates" id="dates-bar">
        <button class="sc-date-btn active" id="btn-today" onclick="selectDate(getTodayStr())">
            <span class="sc-date-btn-date" id="btn-today-label"></span>
            <span class="sc-date-btn-sub">—Å–µ–≥–æ–¥–Ω—è</span>
        </button>
    </div>

    <div class="sc-header">
        <span id="current-date" class="sc-date"></span>
        <span id="orders_info" class="sc-orders"></span>
    </div>

    <!-- Readonly banner -->
    <div class="sc-banner sc-banner-readonly hidden" id="readonly-banner">
        –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        <button type="button" class="sc-btn-sm" style="margin-left:8px" onclick="enableEdit()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="sc-banner" id="loading-banner">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- Cashier data indicator -->
    <div class="sc-source-banner hidden" id="cashier-source-banner">
        –î–∞–Ω–Ω—ã–µ –æ—Ç –∫–∞—Å—Å–∏—Ä–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã
    </div>

    <!-- –ë–µ–∑–Ω–∞–ª -->
    <div class="sc-card">
        <div class="sc-card-title">–ë–µ–∑–Ω–∞–ª</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>Wolt</label>
                <input type="text" id="wolt" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
            <div class="sc-field">
                <label>Halyk</label>
                <input type="text" id="halyk" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
        </div>
        <div class="sc-field">
            <label>Kaspi</label>
            <input type="text" id="kaspi" inputmode="decimal" placeholder="0" oninput="onInput()">
        </div>
        <div class="sc-field sc-minus">
            <label>- Kaspi Cafe</label>
            <input type="text" id="kaspi_cafe" inputmode="decimal" placeholder="0" oninput="onInput()">
        </div>
    </div>

    <!-- –ù–∞–ª–∏—á–Ω—ã–µ -->
    <div class="sc-card">
        <div class="sc-card-title">–ù–∞–ª–∏—á–Ω—ã–µ</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>–ë—É–º–∞–∂–Ω—ã–µ</label>
                <input type="text" id="cash_bills" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
            <div class="sc-field">
                <label>–ú–µ–ª–æ—á—å</label>
                <input type="text" id="cash_coins" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥ -->
    <div class="sc-subtotal" id="fact_total_row" style="display:none">
        <span>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π</span>
        <span id="fact_total_value" class="sc-subtotal-num">0</span>
    </div>

    <!-- –°–º–µ–Ω–∞ / –†–∞—Å—Ö–æ–¥—ã -->
    <div class="sc-card">
        <div class="sc-card-title">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</div>
        <div class="sc-row-pair">
            <div class="sc-field">
                <label>–°–º–µ–Ω–∞ (–Ω–∞—á–∞–ª–æ)</label>
                <input type="text" id="shift_start" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
            <div class="sc-field">
                <label>–†–∞—Å—Ö–æ–¥—ã —Å –∫–∞—Å—Å—ã</label>
                <input type="text" id="expenses" inputmode="decimal" placeholder="0" oninput="onInput()">
            </div>
        </div>
    </div>

    <!-- –ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π -->
    <div class="sc-subtotal accent" id="fact_adjusted_row" style="display:none">
        <span>–ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç–∏—á.</span>
        <span id="fact_adjusted_value" class="sc-subtotal-num">0</span>
    </div>

    <!-- Poster -->
    <div class="sc-card sc-card-poster">
        <div class="sc-card-title">Poster</div>
        <div class="sc-info-row">
            <span>–ë–µ–∑–Ω–∞–ª —Ñ–∞–∫—Ç</span>
            <span id="poster_cashless" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row">
            <span>–ë–µ–∑–Ω–∞–ª Poster</span>
            <span id="poster_card_display" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row sc-diff" id="cashless_diff_row" style="display:none">
            <span>–†–∞–∑–Ω–∏—Ü–∞ –±–µ–∑–Ω–∞–ª</span>
            <span id="cashless_diff_value" class="sc-info-val">0</span>
        </div>
        <div class="sc-info-sep"></div>
        <div class="sc-info-row">
            <span>–¢–æ—Ä–≥–æ–≤–ª—è</span>
            <span id="poster_trade_display" class="sc-info-val">--</span>
        </div>
        <div class="sc-info-row">
            <span>–ë–æ–Ω—É—Å—ã</span>
            <span id="poster_bonus_display" class="sc-info-val sc-red">--</span>
        </div>
        <div class="sc-subtotal accent inside" id="poster_total_row" style="display:none">
            <span>–ò—Ç–æ–≥–æ Poster</span>
            <span id="poster_total_value" class="sc-subtotal-num">--</span>
        </div>
    </div>

    <!-- –ò–¢–û–ì–û –î–ï–ù–¨ -->
    <div class="sc-day-result" id="day_result_block">
        <div class="sc-day-label">–ò–¢–û–ì–û –î–ï–ù–¨</div>
        <div class="sc-day-value" id="day_result_value">--</div>
        <div class="sc-day-status" id="day_result_status"></div>
    </div>

    <!-- –ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è -->
    <div class="sc-card">
        <div class="sc-card-title">–ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è</div>
        <div class="sc-field">
            <label>–û—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Å–º–µ–Ω—É</label>
            <input type="text" id="cash_to_leave" inputmode="decimal" placeholder="15000" value="15000" oninput="onInput()">
        </div>
        <div class="sc-info-row" id="shift_left_row" style="display:none">
            <span>–°–º–µ–Ω–∞ –æ—Å—Ç–∞–≤–∏–ª–∏</span>
            <span id="shift_left_value" class="sc-info-val">0</span>
        </div>
        <div class="sc-hint" id="shift_left_hint" style="display:none"></div>
        <div class="sc-collection" id="collection_block" style="display:none">
            <span>–ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è</span>
            <span id="collection_value">0</span>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="sc-actions">
        <button type="button" class="sc-btn" onclick="loadPosterData()">–û–±–Ω–æ–≤–∏—Ç—å Poster</button>
        <button type="button" class="sc-btn sc-btn-sec" id="report-btn" onclick="loadShiftReport()">–û—Ç—á—ë—Ç —Å–º–µ–Ω—ã</button>
    </div>

    <!-- Saving indicator -->
    <div class="sc-save-status hidden" id="save-status">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>

    <!-- –û—Ç—á—ë—Ç -->
    <div id="report-container" style="display:none" class="sc-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="sc-card-title" style="margin:0">–û—Ç—á—ë—Ç –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã</div>
            <button type="button" class="sc-btn sc-btn-sm" id="copy-btn" onclick="copyReportAndTransfer()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <pre id="report-text" class="sc-report"></pre>
        <div id="transfer-status" class="hidden" style="margin-top:8px;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:500;text-align:center"></div>
    </div>
</div>

<style>
/* ===== Mobile-first shift closing ===== */
*{box-sizing:border-box}

.sc {
    max-width: 480px;
    margin: 0 auto;
    padding: 8px 10px 24px;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    -webkit-text-size-adjust: 100%;
}

/* Staff status bar */
.sc-staff-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
    justify-content: flex-end;
}
.sc-staff-badge {
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 10px;
    white-space: nowrap;
}
.sc-staff-badge.waiting { background: #ff950020; color: #ff9500; }
.sc-staff-badge.done { background: #34c75920; color: #34c759; }

/* Source banner */
.sc-source-banner {
    background: #34c75915;
    color: #30a14e;
    padding: 6px 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 8px;
}
.sc-source-banner.hidden { display: none !important; }

/* Source label on field */
.sc-field-source {
    font-size: 10px;
    font-weight: 600;
    color: #30a14e;
    margin-left: 6px;
}

/* Date selector bar */
.sc-dates {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding: 6px 0 10px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}
.sc-dates::-webkit-scrollbar { display: none; }
.sc-date-btn {
    flex-shrink: 0;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1.5px solid #d1d1d6;
    background: #fff;
    cursor: pointer;
    text-align: center;
    min-width: 70px;
    transition: all 0.15s;
}
.sc-date-btn.active {
    background: #007aff;
    border-color: #007aff;
    color: #fff;
}
.sc-date-btn.active .sc-date-btn-sub { color: rgba(255,255,255,0.7); }
.sc-date-btn-date {
    display: block;
    font-size: 13px;
    font-weight: 600;
}
.sc-date-btn-sub {
    display: block;
    font-size: 10px;
    color: #8e8e93;
    margin-top: 1px;
}
.sc-date-btn.has-data::after {
    content: '';
    display: block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: #34c759;
    margin: 2px auto 0;
}
.sc-date-btn.active.has-data::after {
    background: rgba(255,255,255,0.7);
}

/* Header */
.sc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    margin-bottom: 4px;
}
.sc-date {
    font-size: 17px;
    font-weight: 700;
    color: #1c1c1e;
}
.sc-orders {
    font-size: 13px;
    color: #8e8e93;
}

/* Banner */
.sc-banner {
    background: #007aff20;
    color: #007aff;
    padding: 8px 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 10px;
}
.sc-banner.hidden, .hidden { display: none !important; }
.sc-banner.error { background: #ff3b3020; color: #ff3b30; }
.sc-banner-readonly {
    background: #ff950020;
    color: #ff9500;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Save status */
.sc-save-status {
    text-align: center;
    font-size: 12px;
    color: #30d158;
    padding: 4px;
    margin-bottom: 6px;
    transition: opacity 0.3s;
}

/* Card */
.sc-card {
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.sc-card-title {
    font-size: 13px;
    font-weight: 600;
    color: #8e8e93;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 10px;
}

/* Field */
.sc-field {
    margin-bottom: 8px;
}
.sc-field:last-child { margin-bottom: 0; }
.sc-field label {
    display: block;
    font-size: 13px;
    color: #6c6c70;
    margin-bottom: 3px;
    font-weight: 500;
}
.sc-field input {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d1d1d6;
    border-radius: 10px;
    font-size: 17px;
    text-align: right;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    color: #1c1c1e;
    background: #fff;
    -webkit-appearance: none;
    appearance: none;
    transition: border-color 0.15s;
}
.sc-field input:focus {
    outline: none;
    border-color: #007aff;
    box-shadow: 0 0 0 3px rgba(0,122,255,0.12);
}
.sc-field input::placeholder { color: #c7c7cc; }
.sc-field input[readonly] {
    background: #f2f2f7;
    color: #8e8e93;
}

/* Minus field */
.sc-minus label { color: #ff3b30; }
.sc-minus input {
    border-color: #ffb4ab;
    color: #ff3b30;
}
.sc-minus input:focus {
    border-color: #ff3b30;
    box-shadow: 0 0 0 3px rgba(255,59,48,0.12);
}

/* Two-col pair */
.sc-row-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
}
.sc-row-pair .sc-field { margin-bottom: 0; }

/* Subtotal */
.sc-subtotal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 10px;
    background: #f2f2f7;
    margin-bottom: 8px;
    font-size: 15px;
    font-weight: 600;
    color: #3a3a3c;
}
.sc-subtotal.accent {
    background: #007aff12;
}
.sc-subtotal.accent .sc-subtotal-num {
    color: #007aff;
}
.sc-subtotal.inside {
    margin: 8px -4px -4px;
    border-radius: 8px;
}
.sc-subtotal-num {
    font-variant-numeric: tabular-nums;
    font-size: 17px;
    font-weight: 700;
}

/* Poster info rows */
.sc-card-poster {
    background: #f9f9fb;
}
.sc-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
    color: #6c6c70;
}
.sc-info-val {
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    color: #1c1c1e;
    font-size: 15px;
}
.sc-info-val.sc-red { color: #ff3b30; }
.sc-info-sep {
    height: 1px;
    background: #e5e5ea;
    margin: 6px 0;
}

/* Diff row */
.sc-diff { border-radius: 6px; padding: 6px 8px; }
.sc-diff.positive { background: #34c75920; }
.sc-diff.positive .sc-info-val { color: #30d158; }
.sc-diff.negative { background: #ff3b3015; }
.sc-diff.negative .sc-info-val { color: #ff3b30; }

/* Day result */
.sc-day-result {
    text-align: center;
    padding: 20px 12px;
    border-radius: 14px;
    margin-bottom: 8px;
    background: #f2f2f7;
    transition: background 0.2s;
}
.sc-day-result.positive { background: #34c75920; }
.sc-day-result.negative { background: #ff3b3018; }
.sc-day-result.zero { background: #007aff15; }
.sc-day-label {
    font-size: 11px;
    color: #8e8e93;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 4px;
}
.sc-day-value {
    font-size: 38px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    color: #3a3a3c;
    line-height: 1.1;
}
.sc-day-result.positive .sc-day-value { color: #30d158; }
.sc-day-result.negative .sc-day-value { color: #ff3b30; }
.sc-day-result.zero .sc-day-value { color: #007aff; }
.sc-day-status {
    font-size: 14px;
    margin-top: 4px;
    color: #8e8e93;
}
.sc-day-result.positive .sc-day-status { color: #30d158; }
.sc-day-result.negative .sc-day-status { color: #ff3b30; }
.sc-day-result.zero .sc-day-status { color: #007aff; }

/* Collection */
.sc-collection {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-radius: 10px;
    background: #1c1c1e;
    margin-top: 10px;
    font-size: 16px;
    font-weight: 700;
    color: #fff;
}
.sc-collection span:last-child {
    font-size: 20px;
    font-variant-numeric: tabular-nums;
}

.sc-hint {
    text-align: center;
    font-size: 11px;
    color: #aeaeb2;
    margin-top: 2px;
}

/* Buttons */
.sc-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}
.sc-btn {
    flex: 1;
    padding: 10px 0;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    background: #007aff;
    color: #fff;
    -webkit-appearance: none;
    transition: opacity 0.15s;
}
.sc-btn:active { opacity: 0.7; }
.sc-btn-sec {
    background: #e5e5ea;
    color: #1c1c1e;
}
.sc-btn-sm {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    background: #e5e5ea;
    color: #1c1c1e;
}

/* Report */
.sc-report {
    background: #1c1c1e;
    color: #e5e5ea;
    padding: 12px;
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 400px;
    overflow-y: auto;
    margin: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}

/* Loading */
.loading { opacity: 0.5; pointer-events: none; }

/* Tiny screens (iPhone SE) */
@media (max-width: 374px) {
    .sc { padding: 6px 8px 20px; }
    .sc-field input { font-size: 16px; padding: 9px 10px; }
    .sc-day-value { font-size: 32px; }
    .sc-collection span:last-child { font-size: 18px; }
}
</style>

<script>
let posterData = null;
let debounceTimer = null;
let saveTimer = null;
let lastCalc = null;
let currentDate = '';
let isReadonly = false;
let transfersCreated = false;
const INPUT_IDS = ['wolt','halyk','kaspi','kaspi_cafe','cash_bills','cash_coins','shift_start','expenses','cash_to_leave'];
// User-input fields only (excludes shift_start ‚Äî always from Poster API)
const USER_INPUT_IDS = ['wolt','halyk','kaspi','kaspi_cafe','cash_bills','cash_coins','expenses','cash_to_leave'];

function fmt(n) {
    return Math.round(n).toLocaleString('ru-RU');
}

function pi(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    return parseFloat(el.value.replace(/\s/g, '').replace(/,/g, '.')) || 0;
}

// Get today in KZ timezone (UTC+5) as YYYY-MM-DD
function getTodayStr() {
    // "Business day" logic: before 6:00 AM KZ time, the business day is still yesterday
    const now = new Date();
    const kz = new Date(now.getTime() + (5 * 60 - now.getTimezoneOffset()) * 60000);
    const kzHour = kz.getUTCHours();
    if (kzHour < 6) {
        // Before 6 AM ‚Äî business day is yesterday
        kz.setUTCDate(kz.getUTCDate() - 1);
    }
    return kz.toISOString().slice(0, 10);
}

// Get previous date string (YYYY-MM-DD) for a given date
function getPrevDateStr(s) {
    const p = s.split('-');
    const d = new Date(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2]));
    d.setDate(d.getDate() - 1);
    return d.toISOString().slice(0, 10);
}

// Format YYYY-MM-DD to DD.MM
function fmtDateShort(s) {
    const p = s.split('-');
    return p[2] + '.' + p[1];
}

// Format YYYY-MM-DD to DD.MM.YYYY
function fmtDateFull(s) {
    const p = s.split('-');
    return p[2] + '.' + p[1] + '.' + p[0];
}

// Format YYYY-MM-DD to YYYYMMDD for Poster API
function toPosterDate(s) {
    return s.replace(/-/g, '');
}

// ========= localStorage persistence =========
function lsKey(date) { return 'sc_' + date; }

function saveToLS() {
    const data = {};
    // Only save user-input fields, NOT shift_start (it comes from Poster API)
    USER_INPUT_IDS.forEach(id => { data[id] = document.getElementById(id).value; });
    try { localStorage.setItem(lsKey(currentDate), JSON.stringify(data)); } catch(e) {}
}

function loadFromLS(date) {
    try {
        const raw = localStorage.getItem(lsKey(date));
        if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
}

// ========= Input handler =========
function onInput() {
    if (isReadonly) return;
    saveToLS();
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculate, 250);
}

// ========= Date selector =========
function selectDate(date) {
    if (date === currentDate) return;
    currentDate = date;

    // Update header
    document.getElementById('current-date').textContent = fmtDateFull(date);

    // Highlight active button
    document.querySelectorAll('.sc-date-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.date === date);
    });

    // Reset display
    posterData = null;
    lastCalc = null;
    resetDisplay();

    // Hide report
    document.getElementById('report-container').style.display = 'none';

    // Reset polling state when switching dates
    stopPolling();
    userHasEdited = false;

    // Load data for this date, then start polling if today
    loadDateData(date).then(function() {
        if (date === getTodayStr()) startPolling();
    });
}

function resetDisplay() {
    ['fact_total_row','fact_adjusted_row','cashless_diff_row','poster_total_row',
     'shift_left_row','shift_left_hint','collection_block'].forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    document.getElementById('day_result_value').textContent = '--';
    document.getElementById('day_result_status').textContent = '';
    document.getElementById('day_result_block').classList.remove('positive','negative','zero');
    ['poster_cashless','poster_card_display','poster_trade_display'].forEach(id => {
        document.getElementById(id).textContent = '--';
    });
    document.getElementById('poster_bonus_display').textContent = '--';
    document.getElementById('orders_info').textContent = '';
    // Reset staff badges and cashier banner
    document.getElementById('cashier-source-banner').classList.add('hidden');
    document.getElementById('staff-status-bar').classList.add('hidden');
    document.getElementById('cashier-badge').textContent = '';
    document.getElementById('cashier-badge').className = 'sc-staff-badge';
    document.getElementById('cafe-badge').textContent = '';
    document.getElementById('cafe-badge').className = 'sc-staff-badge';
}

async function loadDateData(date) {
    const banner = document.getElementById('loading-banner');
    const readonlyBanner = document.getElementById('readonly-banner');

    banner.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    banner.classList.remove('hidden', 'error');
    readonlyBanner.classList.add('hidden');

    // Reset transfers state
    transfersCreated = false;
    document.getElementById('transfer-status').classList.add('hidden');
    document.getElementById('copy-btn').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';

    // Clear all inputs
    INPUT_IDS.forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('cash_to_leave').value = '15000';

    const isToday = date === getTodayStr();

    // 1. Try to load saved shift closing from backend
    try {
        const r = await fetch('/api/shift-closing/history?date=' + date);
        const d = await r.json();
        if (d.success && d.closing) {
            const c = d.closing;
            // Restore ONLY user-input fields from saved data
            // shift_start is NEVER loaded from DB ‚Äî always from Poster getCashShifts API
            USER_INPUT_IDS.forEach(id => {
                if (c[id]) document.getElementById(id).value = c[id];
            });
            if (c.deposits) document.getElementById('deposits') && (document.getElementById('deposits').value = c.deposits);

            // Check if transfers already created
            if (c.transfers_created) {
                transfersCreated = true;
                updateCopyBtn();
            }

            setReadonly(!isToday);
            saveToLS();
        } else {
            // No saved data ‚Äî try localStorage
            const ls = loadFromLS(date);
            if (ls) {
                USER_INPUT_IDS.forEach(id => {
                    if (ls[id]) document.getElementById(id).value = ls[id];
                });
            }
            setReadonly(false);
        }
    } catch(e) {
        // Network error ‚Äî try localStorage (user-input fields only)
        const ls = loadFromLS(date);
        if (ls) {
            USER_INPUT_IDS.forEach(id => {
                if (ls[id]) document.getElementById(id).value = ls[id];
            });
        }
        setReadonly(false);
    }

    // 2. Load Poster data
    try {
        document.querySelector('.sc').classList.add('loading');
        const r = await fetch('/api/shift-closing/poster-data?date=' + toPosterDate(date));
        const d = await r.json();

        if (d.success) {
            posterData = d;

            // ALWAYS set shift_start from Poster getCashShifts (previous day's "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å")
            // This is the ONLY source of truth ‚Äî it's the actual shift closing balance from Poster
            if (d.poster_prev_shift_left != null && d.poster_prev_shift_left !== 0) {
                document.getElementById('shift_start').value = String(Math.round(d.poster_prev_shift_left / 100));
                console.log('[SHIFT] shift_start=' + Math.round(d.poster_prev_shift_left / 100) + ' (Poster getCashShifts)');
            }
            // If Poster has no cash shift data, field stays empty for manual input

            // Auto-fill kaspi_cafe from Cafe's saved kaspi_pizzburg (if available and field is empty)
            if (d.cafe_kaspi_pizzburg && !pi('kaspi_cafe')) {
                document.getElementById('kaspi_cafe').value = String(Math.round(d.cafe_kaspi_pizzburg));
                console.log('[SHIFT] kaspi_cafe auto-filled from Cafe: ' + Math.round(d.cafe_kaspi_pizzburg));
            }

            // Auto-fill cashier data (if submitted and fields are empty)
            applyCashierData(d);

            // Update staff badges
            updateStaffBadges(d);

            // Display Poster data
            document.getElementById('poster_trade_display').textContent = fmt(d.trade_total / 100);
            document.getElementById('poster_bonus_display').textContent = '-' + fmt(d.bonus / 100);
            document.getElementById('poster_card_display').textContent = fmt(d.poster_card / 100);
            document.getElementById('orders_info').textContent = d.transactions_count + ' –∑–∞–∫–∞–∑–æ–≤';

            banner.textContent = '–ì–æ—Ç–æ–≤–æ';
            setTimeout(() => banner.classList.add('hidden'), 1200);
            calculate();
        } else {
            banner.textContent = d.error || '–û—à–∏–±–∫–∞ Poster';
            banner.classList.add('error');
        }
    } catch(e) {
        banner.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Poster';
        banner.classList.add('error');
    } finally {
        document.querySelector('.sc').classList.remove('loading');
    }
}

function setReadonly(val) {
    isReadonly = val;
    const banner = document.getElementById('readonly-banner');
    if (val) {
        banner.classList.remove('hidden');
        INPUT_IDS.forEach(id => document.getElementById(id).setAttribute('readonly', ''));
    } else {
        banner.classList.add('hidden');
        INPUT_IDS.forEach(id => document.getElementById(id).removeAttribute('readonly'));
    }
}

function enableEdit() {
    setReadonly(false);
}

// ========= Poster data reload =========
async function loadPosterData() {
    const banner = document.getElementById('loading-banner');
    banner.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ Poster...';
    banner.classList.remove('hidden', 'error');

    try {
        document.querySelector('.sc').classList.add('loading');
        const isToday = currentDate === getTodayStr();
        const dateParam = isToday ? '' : '?date=' + toPosterDate(currentDate);
        const r = await fetch('/api/shift-closing/poster-data' + dateParam);
        const d = await r.json();

        if (d.success) {
            posterData = d;
            document.getElementById('poster_trade_display').textContent = fmt(d.trade_total / 100);
            document.getElementById('poster_bonus_display').textContent = '-' + fmt(d.bonus / 100);
            document.getElementById('poster_card_display').textContent = fmt(d.poster_card / 100);
            document.getElementById('orders_info').textContent = d.transactions_count + ' –∑–∞–∫–∞–∑–æ–≤';

            // Refresh kaspi_cafe from Cafe's kaspi_pizzburg
            if (d.cafe_kaspi_pizzburg !== undefined) {
                const cafeVal = Math.round(d.cafe_kaspi_pizzburg);
                document.getElementById('kaspi_cafe').value = String(cafeVal);
                console.log('[SHIFT] kaspi_cafe refreshed from Cafe: ' + cafeVal);
            }

            // Refresh cashier data
            applyCashierData(d);

            // Update staff badges
            updateStaffBadges(d);

            banner.textContent = '–ì–æ—Ç–æ–≤–æ';
            setTimeout(() => banner.classList.add('hidden'), 1200);
            calculate();
        } else {
            banner.textContent = d.error || '–û—à–∏–±–∫–∞';
            banner.classList.add('error');
        }
    } catch(e) {
        banner.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        banner.classList.add('error');
    } finally {
        document.querySelector('.sc').classList.remove('loading');
    }
}

// ========= Calculate =========
async function calculate() {
    if (!posterData) return;

    try {
        const body = {
            wolt: pi('wolt'), halyk: pi('halyk'),
            kaspi: pi('kaspi'), kaspi_cafe: pi('kaspi_cafe'),
            cash_bills: pi('cash_bills'), cash_coins: pi('cash_coins'),
            shift_start: pi('shift_start'),
            expenses: pi('expenses'), cash_to_leave: pi('cash_to_leave'),
            poster_trade: posterData.trade_total,
            poster_bonus: posterData.bonus,
            poster_card: posterData.poster_card,
        };

        const r = await fetch('/api/shift-closing/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const d = await r.json();
        if (d.success) {
            lastCalc = d.calculations;
            showCalc(d.calculations);
            scheduleSave(d.calculations);
        }
    } catch(e) {}
}

function showCalc(c) {
    // Factual
    document.getElementById('fact_total_row').style.display = 'flex';
    document.getElementById('fact_total_value').textContent = fmt(c.fact_total);

    document.getElementById('fact_adjusted_row').style.display = 'flex';
    document.getElementById('fact_adjusted_value').textContent = fmt(c.fact_adjusted);

    // Poster cashless
    document.getElementById('poster_cashless').textContent = fmt(c.fact_cashless);

    // Cashless diff
    const cdr = document.getElementById('cashless_diff_row');
    if (Math.abs(c.cashless_diff) >= 1) {
        cdr.style.display = 'flex';
        cdr.classList.remove('positive', 'negative');
        cdr.classList.add(c.cashless_diff > 0 ? 'positive' : 'negative');
        document.getElementById('cashless_diff_value').textContent =
            (c.cashless_diff > 0 ? '+' : '') + fmt(c.cashless_diff);
    } else {
        cdr.style.display = 'none';
    }

    // Poster total
    document.getElementById('poster_total_row').style.display = 'flex';
    document.getElementById('poster_total_value').textContent = fmt(c.poster_total);

    // Day result
    const dr = c.day_result;
    const bl = document.getElementById('day_result_block');
    const vl = document.getElementById('day_result_value');
    const st = document.getElementById('day_result_status');
    bl.classList.remove('positive', 'negative', 'zero');

    if (dr > 0) {
        bl.classList.add('positive');
        vl.textContent = '+' + fmt(dr);
        st.textContent = '–∏–∑–ª–∏—à–µ–∫';
    } else if (dr < 0) {
        bl.classList.add('negative');
        vl.textContent = fmt(dr);
        st.textContent = '–Ω–µ–¥–æ—Å—Ç–∞—á–∞';
    } else {
        bl.classList.add('zero');
        vl.textContent = '0';
        st.textContent = '–∏–¥–µ–∞–ª—å–Ω–æ';
    }

    // Shift left
    document.getElementById('shift_left_row').style.display = 'flex';
    document.getElementById('shift_left_value').textContent = fmt(c.shift_left);

    const h = document.getElementById('shift_left_hint');
    h.style.display = 'block';
    h.textContent = fmt(pi('cash_to_leave')) + ' + ' + fmt(pi('cash_coins')) + ' –º–µ–ª–æ—á—å';

    // Collection
    document.getElementById('collection_block').style.display = 'flex';
    document.getElementById('collection_value').textContent = fmt(c.collection);
}

// ========= Auto-save to backend =========
function scheduleSave(calc) {
    if (isReadonly) return;

    // Only save if there's meaningful input
    const hasInput = pi('cash_bills') > 0 || pi('wolt') > 0 || pi('kaspi') > 0 || pi('halyk') > 0;
    if (!hasInput) return;

    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => doSave(calc), 1500);
}

async function doSave(calc) {
    // Save only user-input fields + calculated results
    // API-derived fields (shift_start, poster_*) are NOT saved ‚Äî always fetched from Poster API
    const data = {
        date: currentDate,
        // User input fields:
        wolt: pi('wolt'), halyk: pi('halyk'),
        kaspi: pi('kaspi'), kaspi_cafe: pi('kaspi_cafe'),
        cash_bills: pi('cash_bills'), cash_coins: pi('cash_coins'),
        expenses: pi('expenses'), cash_to_leave: pi('cash_to_leave'),
        deposits: 0,
        // Calculated results (for reports/history):
        fact_cashless: calc.fact_cashless, fact_total: calc.fact_total,
        fact_adjusted: calc.fact_adjusted, poster_total: calc.poster_total,
        day_result: calc.day_result, shift_left: calc.shift_left,
        collection: calc.collection, cashless_diff: calc.cashless_diff,
        transactions_count: posterData ? posterData.transactions_count : 0,
    };

    try {
        const r = await fetch('/api/shift-closing/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        const d = await r.json();
        if (d.success) {
            const ss = document.getElementById('save-status');
            ss.classList.remove('hidden');
            setTimeout(() => ss.classList.add('hidden'), 2000);

            // Refresh history dates
            loadHistoryDates();
        }
    } catch(e) {}
}

// ========= History dates =========
async function loadHistoryDates() {
    try {
        const r = await fetch('/api/shift-closing/dates');
        const d = await r.json();
        if (d.success && d.dates) {
            renderDateButtons(d.dates);
        }
    } catch(e) {}
}

function renderDateButtons(dates) {
    const bar = document.getElementById('dates-bar');
    const today = getTodayStr();

    // Always show today + last 7 days
    const allDates = [today];
    for (let i = 1; i <= 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        // Format as YYYY-MM-DD in KZ timezone
        const kz = new Date(d.getTime() + (5 * 60 - d.getTimezoneOffset()) * 60000);
        const ds = kz.toISOString().slice(0, 10);
        if (allDates.indexOf(ds) === -1) allDates.push(ds);
    }
    // Also add any saved dates not already included
    dates.forEach(d => { if (allDates.indexOf(d) === -1) allDates.push(d); });
    // Sort: today first, rest descending
    allDates.sort((a, b) => { if (a === today) return -1; if (b === today) return 1; return b.localeCompare(a); });

    // Compute yesterday's date string
    const yd = new Date();
    yd.setDate(yd.getDate() - 1);
    const ykz = new Date(yd.getTime() + (5 * 60 - yd.getTimezoneOffset()) * 60000);
    const yesterday = ykz.toISOString().slice(0, 10);

    // Track which dates have saved data
    const savedSet = new Set(dates);

    bar.innerHTML = '';
    allDates.forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'sc-date-btn' + (d === currentDate ? ' active' : '');
        btn.dataset.date = d;
        btn.onclick = () => selectDate(d);

        const dateSpan = document.createElement('span');
        dateSpan.className = 'sc-date-btn-date';
        dateSpan.textContent = fmtDateShort(d);

        btn.appendChild(dateSpan);

        if (d === today) {
            const sub = document.createElement('span');
            sub.className = 'sc-date-btn-sub';
            sub.textContent = '—Å–µ–≥–æ–¥–Ω—è';
            btn.appendChild(sub);
        } else if (d === yesterday) {
            const sub = document.createElement('span');
            sub.className = 'sc-date-btn-sub';
            sub.textContent = '–≤—á–µ—Ä–∞';
            btn.appendChild(sub);
        }

        // Show a dot indicator if this date has saved data
        if (savedSet.has(d)) {
            btn.classList.add('has-data');
        }

        bar.appendChild(btn);
    });
}

// ========= Shift closing report =========
function loadShiftReport() {
    // Generate report from current form data (no need to fetch from server)
    const fmtR = n => Math.round(n).toLocaleString('ru-RU').replace(/\u00A0/g, ' ');
    const dateDisplay = fmtDateFull(currentDate);

    const wolt = pi('wolt'), halyk = pi('halyk');
    const kaspi = pi('kaspi'), kaspi_cafe = pi('kaspi_cafe');
    const cash_bills = pi('cash_bills'), cash_coins = pi('cash_coins');
    const shift_start = pi('shift_start');
    const expenses = pi('expenses'), cash_to_leave = pi('cash_to_leave');
    const deposits = pi('deposits') || 0;

    const calc = lastCalc || {};
    const fact_cashless = calc.fact_cashless || (wolt + halyk + (kaspi - kaspi_cafe));
    const fact_total = calc.fact_total || (fact_cashless + cash_bills + cash_coins);
    const fact_adjusted = calc.fact_adjusted || 0;
    const poster_trade = calc.poster_trade || (posterData ? posterData.trade_total / 100 : 0);
    const poster_bonus = calc.poster_bonus || (posterData ? posterData.bonus / 100 : 0);
    const poster_total = calc.poster_total || (poster_trade - poster_bonus);
    const poster_card = calc.poster_card || (posterData ? posterData.poster_card / 100 : 0);
    const day_result = calc.day_result || 0;
    const shift_left = calc.shift_left || (cash_to_leave + cash_coins);
    const collection = calc.collection || (cash_bills - cash_to_leave + expenses);
    const cashless_diff = calc.cashless_diff || (fact_cashless - poster_card);

    const dayLabel = day_result > 0 ? '–∏–∑–ª–∏—à–µ–∫' : day_result < 0 ? '–Ω–µ–¥–æ—Å—Ç–∞—á–∞' : '—Ä–æ–≤–Ω–æ';
    const daySign = day_result > 0 ? '+' : '';
    const dayEmoji = day_result > 0 ? 'üìà' : day_result < 0 ? 'üìâ' : '‚úÖ';

    const sep = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
    const subsep = '   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';

    let lines = [
        'üìã –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã ' + dateDisplay,
        sep,
        'üí≥ –ë–µ–∑–Ω–∞–ª —Ç–µ—Ä–º–∏–Ω–∞–ª—ã:',
        '   Wolt: ' + fmtR(wolt) + '‚Ç∏',
        '   Halyk: ' + fmtR(halyk) + '‚Ç∏',
        '   Kaspi: ' + fmtR(kaspi) + '‚Ç∏',
    ];

    if (kaspi_cafe > 0) {
        lines.push('   Kaspi Cafe: -' + fmtR(kaspi_cafe) + '‚Ç∏');
    }

    lines = lines.concat([
        subsep,
        '   –ò—Ç–æ–≥–æ –±–µ–∑–Ω–∞–ª: ' + fmtR(fact_cashless) + '‚Ç∏',
        '',
        'üíµ –ù–∞–ª–∏—á–Ω—ã–µ:',
        '   –ë—É–º–∞–∂–Ω—ã–µ: ' + fmtR(cash_bills) + '‚Ç∏',
        '   –ú–µ–ª–æ—á—å: ' + fmtR(cash_coins) + '‚Ç∏',
        sep,
        'üìä –°–≤–µ—Ä–∫–∞:',
        '   –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π: ' + fmtR(fact_total) + '‚Ç∏',
        '   –°–º–µ–Ω–∞ –Ω–∞—á–∞–ª–æ: ' + fmtR(shift_start) + '‚Ç∏',
    ]);

    if (deposits > 0) {
        lines.push('   –í–Ω–µ—Å–µ–Ω–∏—è: ' + fmtR(deposits) + '‚Ç∏');
    }
    if (expenses > 0) {
        lines.push('   –†–∞—Å—Ö–æ–¥—ã: ' + fmtR(expenses) + '‚Ç∏');
    }

    lines = lines.concat([
        subsep,
        '   –ò—Ç–æ–≥–æ —Ñ–∞–∫—Ç: ' + fmtR(fact_adjusted) + '‚Ç∏',
        '',
        '   Poster —Ç–æ—Ä–≥–æ–≤–ª—è: ' + fmtR(poster_trade) + '‚Ç∏',
        '   Poster –±–æ–Ω—É—Å—ã: -' + fmtR(poster_bonus) + '‚Ç∏',
        subsep,
        '   –ò—Ç–æ–≥–æ Poster: ' + fmtR(poster_total) + '‚Ç∏',
        '',
        sep,
        dayEmoji + ' –ò–¢–û–ì–û –î–ï–ù–¨: ' + daySign + fmtR(day_result) + '‚Ç∏ (' + dayLabel + ')',
        sep,
        '',
        'üí∞ –ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è: ' + fmtR(collection) + '‚Ç∏',
        'üîÑ –°–º–µ–Ω–∞ –æ—Å—Ç–∞–≤–∏–ª–∏: ' + fmtR(shift_left) + '‚Ç∏',
    ]);

    if (Math.abs(cashless_diff) >= 1) {
        const diffSign = cashless_diff > 0 ? '+' : '';
        lines.push('');
        lines.push('‚ö†Ô∏è –†–∞–∑–Ω–∏—Ü–∞ –±–µ–∑–Ω–∞–ª: ' + diffSign + fmtR(cashless_diff) + '‚Ç∏');
    }

    const report = lines.join('\n');
    document.getElementById('report-text').textContent = report;
    document.getElementById('report-container').style.display = 'block';
}

function copyToClipboard(text) {
    return navigator.clipboard.writeText(text).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    });
}

function showTransferStatus(msg, isSuccess) {
    const el = document.getElementById('transfer-status');
    el.textContent = msg;
    el.style.background = isSuccess ? '#34c75920' : '#ff950020';
    el.style.color = isSuccess ? '#34c759' : '#ff9500';
    el.classList.remove('hidden');
}

function updateCopyBtn() {
    const btn = document.getElementById('copy-btn');
    if (transfersCreated) {
        btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)';
    } else {
        btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
    }
}

async function copyReportAndTransfer() {
    const btn = document.getElementById('copy-btn');
    const text = document.getElementById('report-text').textContent;

    // 1. Copy report
    await copyToClipboard(text);

    // 2. If transfers not yet created and not readonly ‚Äî create them
    if (!transfersCreated && !isReadonly) {
        btn.textContent = '–°–æ–∑–¥–∞—é –ø–µ—Ä–µ–≤–æ–¥—ã...';
        btn.disabled = true;
        try {
            const res = await fetch('/api/shift-closing/transfers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({date: currentDate})
            });
            const data = await res.json();
            if (data.success) {
                transfersCreated = true;
                if (data.already_created) {
                    showTransferStatus('–ü–µ—Ä–µ–≤–æ–¥—ã —É–∂–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —Ä–∞–Ω–µ–µ', true);
                } else if (data.created_count > 0) {
                    const names = data.transfers.map(t => t.name + ': ' + t.amount.toLocaleString('ru-RU') + '‚Ç∏').join(', ');
                    showTransferStatus('‚úÖ ' + data.created_count + ' –ø–µ—Ä–µ–≤–æ–¥(–∞) —Å–æ–∑–¥–∞–Ω–æ: ' + names, true);
                } else {
                    showTransferStatus('–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (—Å—É–º–º—ã = 0)', true);
                }
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)';
                setTimeout(() => { btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)'; }, 2000);
            } else {
                showTransferStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'), false);
                btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
            }
        } catch (e) {
            showTransferStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message, false);
            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => { btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
        }
        btn.disabled = false;
    } else {
        // Just copy ‚Äî transfers already done or readonly
        btn.textContent = transfersCreated ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! (–ø–µ—Ä–µ–≤–æ–¥—ã ‚úì)' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => updateCopyBtn(), 1500);
    }
}

// ========= Cashier data auto-fill =========
function applyCashierData(d) {
    const banner = document.getElementById('cashier-source-banner');
    if (!d.cashier_data_submitted) {
        banner.classList.add('hidden');
        return;
    }

    const mapping = {
        'wolt': 'cashier_wolt',
        'halyk': 'cashier_halyk',
        'cash_bills': 'cashier_cash_bills',
        'cash_coins': 'cashier_cash_coins',
        'expenses': 'cashier_expenses'
    };

    let filled = false;
    for (const [fieldId, dataKey] of Object.entries(mapping)) {
        const val = d[dataKey];
        if (val && !pi(fieldId)) {
            document.getElementById(fieldId).value = String(Math.round(val));
            filled = true;
        }
    }

    if (filled) {
        banner.classList.remove('hidden');
        console.log('[SHIFT] Cashier data auto-filled: wolt=' + d.cashier_wolt +
            ', halyk=' + d.cashier_halyk + ', bills=' + d.cashier_cash_bills +
            ', coins=' + d.cashier_cash_coins + ', expenses=' + d.cashier_expenses);
    }
}

function updateStaffBadges(d) {
    const bar = document.getElementById('staff-status-bar');
    bar.classList.remove('hidden');

    // Cashier badge
    const cb = document.getElementById('cashier-badge');
    if (d.cashier_data_submitted) {
        cb.textContent = '–ö–∞—Å—Å–∏—Ä \u2713';
        cb.className = 'sc-staff-badge done';
    } else {
        cb.textContent = '–ö–∞—Å—Å–∏—Ä \u2026';
        cb.className = 'sc-staff-badge waiting';
    }

    // Cafe badge
    const cafb = document.getElementById('cafe-badge');
    if (d.cafe_kaspi_pizzburg !== undefined && d.cafe_kaspi_pizzburg !== null) {
        cafb.textContent = '–ö–∞—Ñ–µ \u2713';
        cafb.className = 'sc-staff-badge done';
    } else {
        cafb.textContent = '–ö–∞—Ñ–µ \u2026';
        cafb.className = 'sc-staff-badge waiting';
    }
}

// ========= Auto-polling for cashier data (every 30s) =========
let pollInterval = null;
let userHasEdited = false;

function startPolling() {
    stopPolling();
    // Only poll for today's date
    if (currentDate !== getTodayStr()) return;
    pollInterval = setInterval(pollCashierData, 30000);
    console.log('[POLL] Started polling every 30s');
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
        console.log('[POLL] Stopped polling');
    }
}

async function pollCashierData() {
    // Don't poll if user has started editing or we're on a past date
    if (userHasEdited || currentDate !== getTodayStr()) {
        stopPolling();
        return;
    }

    try {
        const r = await fetch('/api/shift-closing/poster-data?date=' + toPosterDate(currentDate));
        const d = await r.json();
        if (!d.success) return;

        // Update Poster data (always fresh)
        posterData = d;
        document.getElementById('poster_trade_display').textContent = fmt(d.trade_total / 100);
        document.getElementById('poster_bonus_display').textContent = '-' + fmt(d.bonus / 100);
        document.getElementById('poster_card_display').textContent = fmt(d.poster_card / 100);
        document.getElementById('orders_info').textContent = d.transactions_count + ' –∑–∞–∫–∞–∑–æ–≤';

        // Auto-fill cashier data if newly available
        if (d.cashier_data_submitted) {
            applyCashierData(d);
        }

        // Auto-fill cafe kaspi
        if (d.cafe_kaspi_pizzburg !== undefined && !pi('kaspi_cafe')) {
            document.getElementById('kaspi_cafe').value = String(Math.round(d.cafe_kaspi_pizzburg));
        }

        // Update badges
        updateStaffBadges(d);

        // Recalculate
        calculate();

        console.log('[POLL] Updated: orders=' + d.transactions_count +
            ', cashier=' + (d.cashier_data_submitted ? 'yes' : 'no'));
    } catch(e) {
        console.log('[POLL] Error: ' + e.message);
    }
}

// Track user edits to stop polling
function markUserEdited() {
    if (!userHasEdited) {
        userHasEdited = true;
        stopPolling();
        console.log('[POLL] User started editing, polling stopped');
    }
}

// ========= Init =========
document.addEventListener('DOMContentLoaded', function() {
    currentDate = getTodayStr();
    document.getElementById('current-date').textContent = fmtDateFull(currentDate);

    // Track user input to stop polling
    INPUT_IDS.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
            el.addEventListener('focus', markUserEdited);
        }
    });

    // Render date buttons (always shows last 7 days) then load today's data
    loadHistoryDates();
    loadDateData(currentDate).then(function() {
        // Start polling after initial load
        startPolling();
    });
});
</script>
{% endblock %}
