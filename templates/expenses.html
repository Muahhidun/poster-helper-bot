{% extends "base.html" %}

{% block title %}–†–∞—Å—Ö–æ–¥—ã - PizzBurg{% endblock %}

{% block content %}
<div class="container">
    <h1>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h1>

    {% if drafts %}
    <form id="drafts-form" method="POST">
        <div class="drafts-actions">
            <button type="submit" formaction="{{ url_for('process_drafts') }}" class="btn btn-success">
                ‚úÖ –°–æ–∑–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            </button>
            <button type="submit" formaction="{{ url_for('delete_drafts') }}" class="btn btn-danger"
                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            </button>
            <span class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <span id="count">0</span></span>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>–°—É–º–º–∞</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–¢–∏–ø</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for draft in drafts %}
                <tr class="draft-row {% if draft.expense_type == 'supply' %}supply{% else %}transaction{% endif %}">
                    <td>
                        <input type="checkbox" name="draft_ids" value="{{ draft.id }}" class="draft-checkbox">
                    </td>
                    <td class="amount">{{ "{:,.0f}".format(draft.amount) }}‚Ç∏</td>
                    <td class="description">{{ draft.description }}</td>
                    <td class="type">
                        <button type="button" class="btn-type"
                                data-id="{{ draft.id }}"
                                data-type="{{ draft.expense_type }}">
                            {% if draft.expense_type == 'supply' %}
                                üì¶ –ø–æ—Å—Ç–∞–≤–∫–∞
                            {% else %}
                                üí∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
                            {% endif %}
                        </button>
                    </td>
                    <td class="category">{{ draft.category or '-' }}</td>
                    <td class="source">
                        {% if draft.source == 'kaspi' %}
                            üí≥ Kaspi
                        {% else %}
                            üíµ –ù–∞–ª–∏—á–∫–∞
                        {% endif %}
                    </td>
                    <td class="actions">
                        <button type="button" class="btn-delete" data-id="{{ draft.id }}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="summary">
            <p>–í—Å–µ–≥–æ: {{ drafts|length }} –∑–∞–ø–∏—Å–µ–π</p>
            <p>üí∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {{ drafts|selectattr('expense_type', 'equalto', 'transaction')|list|length }}</p>
            <p>üì¶ –ü–æ—Å—Ç–∞–≤–æ–∫: {{ drafts|selectattr('expense_type', 'equalto', 'supply')|list|length }}</p>
            <p><strong>–°—É–º–º–∞: {{ "{:,.0f}".format(drafts|sum(attribute='amount')) }}‚Ç∏</strong></p>
        </div>
    </form>
    {% else %}
    <div class="empty-state">
        <p>–ù–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ Kaspi –≤—ã–ø–∏—Å–∫—É –≤ –±–æ—Ç–∞, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏.</p>
    </div>
    {% endif %}
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    margin-bottom: 20px;
}

.drafts-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.selected-count {
    margin-left: auto;
    color: #666;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.table th, .table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.table th {
    background: #f5f5f5;
    font-weight: 600;
}

.draft-row:hover {
    background: #f9f9f9;
}

.draft-row.supply {
    border-left: 4px solid #17a2b8;
}

.draft-row.transaction {
    border-left: 4px solid #28a745;
}

.amount {
    font-weight: 600;
    font-family: monospace;
}

.description {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-type {
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background: white;
    cursor: pointer;
    font-size: 13px;
}

.btn-type:hover {
    background: #f0f0f0;
}

.btn-delete {
    padding: 5px 10px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
}

.btn-delete:hover {
    background: #fee;
    border-radius: 3px;
}

.summary {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 5px;
}

.summary p {
    margin: 5px 0;
}

.empty-state {
    text-align: center;
    padding: 50px;
    color: #666;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.draft-checkbox');
    const countSpan = document.getElementById('count');

    function updateCount() {
        const checked = document.querySelectorAll('.draft-checkbox:checked').length;
        countSpan.textContent = checked;
    }

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateCount();
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCount);
    });

    // Toggle type buttons
    document.querySelectorAll('.btn-type').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const currentType = this.dataset.type;
            const newType = currentType === 'supply' ? 'transaction' : 'supply';

            try {
                const response = await fetch(`/expenses/toggle-type/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({expense_type: newType})
                });

                if (response.ok) {
                    this.dataset.type = newType;
                    this.innerHTML = newType === 'supply' ? 'üì¶ –ø–æ—Å—Ç–∞–≤–∫–∞' : 'üí∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è';

                    const row = this.closest('tr');
                    row.classList.remove('supply', 'transaction');
                    row.classList.add(newType);
                }
            } catch (e) {
                console.error('Error:', e);
            }
        });
    });

    // Delete single item
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫?')) return;

            const id = this.dataset.id;
            try {
                const response = await fetch(`/expenses/delete/${id}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    this.closest('tr').remove();
                }
            } catch (e) {
                console.error('Error:', e);
            }
        });
    });
});
</script>
{% endblock %}