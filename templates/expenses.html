{% extends "base.html" %}

{% block title %}–†–∞—Å—Ö–æ–¥—ã - PizzBurg{% endblock %}

{% block content %}
<div class="container">
    <h1>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h1>

    {% if drafts %}
    <form id="drafts-form" method="POST">
        <div class="drafts-actions">
            <button type="submit" formaction="{{ url_for('process_drafts') }}" class="btn btn-success">
                ‚úÖ –°–æ–∑–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            </button>
            <button type="submit" formaction="{{ url_for('delete_drafts') }}" class="btn btn-danger"
                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            </button>
            <span class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <span id="count">0</span></span>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>–°—É–º–º–∞</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–¢–∏–ø</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–°—á—ë—Ç —Å–ø–∏—Å–∞–Ω–∏—è</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for draft in drafts %}
                <tr class="draft-row {% if draft.expense_type == 'supply' %}supply{% else %}transaction{% endif %}" data-id="{{ draft.id }}">
                    <td>
                        <input type="checkbox" name="draft_ids" value="{{ draft.id }}" class="draft-checkbox">
                    </td>
                    <td class="amount">
                        <input type="number" class="edit-amount" value="{{ draft.amount|int }}"
                               data-id="{{ draft.id }}" step="1" min="0">
                    </td>
                    <td class="description">
                        <input type="text" class="edit-description" value="{{ draft.description }}"
                               data-id="{{ draft.id }}">
                    </td>
                    <td class="type">
                        <button type="button" class="btn-type"
                                data-id="{{ draft.id }}"
                                data-type="{{ draft.expense_type }}">
                            {% if draft.expense_type == 'supply' %}
                                üì¶ –ø–æ—Å—Ç–∞–≤–∫–∞
                            {% else %}
                                üí∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
                            {% endif %}
                        </button>
                    </td>
                    <td class="category">
                        <div class="autocomplete-wrapper">
                            <input type="text" class="edit-category"
                                   value="{{ draft.category or '' }}"
                                   data-id="{{ draft.id }}"
                                   placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è..."
                                   autocomplete="off">
                            <div class="autocomplete-results"></div>
                        </div>
                    </td>
                    <td class="account">
                        <select class="edit-account" data-id="{{ draft.id }}" data-source="{{ draft.source }}">
                            {% for acc in accounts %}
                            <option value="{{ acc.account_id }}"
                                    data-name="{{ acc.name|lower }}"
                                    {% if draft.account_id == acc.account_id %}selected
                                    {% elif not draft.account_id and draft.source == 'kaspi' and 'kaspi' in acc.name|lower %}selected
                                    {% elif not draft.account_id and draft.source != 'kaspi' and ('–∑–∞–∫—É–ø' in acc.name|lower or '–æ—Å—Ç–∞–≤–∏–ª' in acc.name|lower) %}selected
                                    {% endif %}>
                                {{ acc.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="actions">
                        <button type="button" class="btn-delete" data-id="{{ draft.id }}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="summary">
            <p>–í—Å–µ–≥–æ: {{ drafts|length }} –∑–∞–ø–∏—Å–µ–π</p>
            <p>üí∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {{ drafts|selectattr('expense_type', 'equalto', 'transaction')|list|length }}</p>
            <p>üì¶ –ü–æ—Å—Ç–∞–≤–æ–∫: {{ drafts|selectattr('expense_type', 'equalto', 'supply')|list|length }}</p>
            <p><strong>–°—É–º–º–∞: <span id="total-sum">{{ "{:,.0f}".format(drafts|sum(attribute='amount')) }}</span>‚Ç∏</strong></p>
        </div>
    </form>
    {% else %}
    <div class="empty-state">
        <p>–ù–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ Kaspi –≤—ã–ø–∏—Å–∫—É –≤ –±–æ—Ç–∞, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏.</p>
    </div>
    {% endif %}
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    margin-bottom: 20px;
}

.drafts-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.selected-count {
    margin-left: auto;
    color: #666;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.table th, .table td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.table th {
    background: #f5f5f5;
    font-weight: 600;
    white-space: nowrap;
}

.draft-row:hover {
    background: #f9f9f9;
}

.draft-row.supply {
    border-left: 4px solid #17a2b8;
}

.draft-row.transaction {
    border-left: 4px solid #28a745;
}

/* Editable inputs */
.edit-amount {
    width: 90px;
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
    text-align: right;
    font-family: monospace;
    font-weight: 600;
}

.edit-description {
    width: 180px;
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.edit-category {
    width: 120px;
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
}

.edit-account {
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background: white;
    width: 160px;
}

/* Autocomplete */
.autocomplete-wrapper {
    position: relative;
}

.autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    min-width: 150px;
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
}

.autocomplete-item:hover, .autocomplete-item.active {
    background: #e3f2fd;
}

.autocomplete-item.text-muted {
    color: #999;
    cursor: default;
}

.btn-type {
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
}

.btn-type:hover {
    background: #f0f0f0;
}

.btn-delete {
    padding: 5px 10px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
}

.btn-delete:hover {
    background: #fee;
    border-radius: 3px;
}

.summary {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 5px;
}

.summary p {
    margin: 5px 0;
}

.empty-state {
    text-align: center;
    padding: 50px;
    color: #666;
}

/* Saved indicator */
.saved {
    animation: flash-green 0.3s;
}

@keyframes flash-green {
    0% { background-color: #d4edda; }
    100% { background-color: transparent; }
}

/* Responsive */
@media (max-width: 900px) {
    .edit-description { width: 120px; }
    .edit-account { width: 130px; }
}
</style>

<script>
// Categories for autocomplete - data from Poster API
const categories = {{ categories|tojson|safe if categories else '[]' }};
const accounts = {{ accounts|tojson|safe if accounts else '[]' }};

console.log('Loaded categories:', categories.length);
console.log('Loaded accounts:', accounts.length);

let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.draft-checkbox');
    const countSpan = document.getElementById('count');

    function updateCount() {
        const checked = document.querySelectorAll('.draft-checkbox:checked').length;
        countSpan.textContent = checked;
    }

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateCount();
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCount);
    });

    // Toggle type buttons
    document.querySelectorAll('.btn-type').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const currentType = this.dataset.type;
            const newType = currentType === 'supply' ? 'transaction' : 'supply';

            try {
                const response = await fetch(`/expenses/toggle-type/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({expense_type: newType})
                });

                if (response.ok) {
                    this.dataset.type = newType;
                    this.innerHTML = newType === 'supply' ? 'üì¶ –ø–æ—Å—Ç–∞–≤–∫–∞' : 'üí∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è';

                    const row = this.closest('tr');
                    row.classList.remove('supply', 'transaction');
                    row.classList.add(newType);
                }
            } catch (e) {
                console.error('Error:', e);
            }
        });
    });

    // Amount editing
    document.querySelectorAll('.edit-amount').forEach(input => {
        input.addEventListener('change', async function() {
            const id = this.dataset.id;
            await updateField(id, 'amount', this.value);
            this.classList.add('saved');
            setTimeout(() => this.classList.remove('saved'), 300);
            updateTotalSum();
        });
    });

    // Description editing
    document.querySelectorAll('.edit-description').forEach(input => {
        input.addEventListener('change', async function() {
            const id = this.dataset.id;
            await updateField(id, 'description', this.value);
            this.classList.add('saved');
            setTimeout(() => this.classList.remove('saved'), 300);
        });
    });

    // Category autocomplete
    document.querySelectorAll('.edit-category').forEach(input => {
        const resultsDiv = input.nextElementSibling;
        let selectedIndex = -1;

        input.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase().trim();
            selectedIndex = -1;

            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                // Search in categories - handle both formats
                const matches = categories.filter(c => {
                    const name = c.category_name || c.name || '';
                    return name.toLowerCase().includes(query);
                }).slice(0, 8);

                if (matches.length === 0) {
                    // Allow custom entry
                    resultsDiv.innerHTML = `<div class="autocomplete-item" data-name="${this.value}">‚ûï –î–æ–±–∞–≤–∏—Ç—å "${this.value}"</div>`;
                } else {
                    resultsDiv.innerHTML = matches.map((c, i) => {
                        const name = c.category_name || c.name || '';
                        return `<div class="autocomplete-item" data-name="${name}" data-index="${i}">${name}</div>`;
                    }).join('');
                }
                resultsDiv.style.display = 'block';
            }, 100);
        });

        // Keyboard navigation
        input.addEventListener('keydown', function(e) {
            const items = resultsDiv.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelection(items);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    e.preventDefault();
                    selectCategory(items[selectedIndex], input);
                } else if (items.length === 1) {
                    e.preventDefault();
                    selectCategory(items[0], input);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // Save current value as-is
                    saveCategory(input);
                }
            } else if (e.key === 'Escape') {
                resultsDiv.style.display = 'none';
            }
        });

        function updateSelection(items) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === selectedIndex);
            });
        }

        async function selectCategory(item, inputEl) {
            const name = item.dataset.name;
            inputEl.value = name;
            resultsDiv.style.display = 'none';
            await saveCategory(inputEl);
        }

        async function saveCategory(inputEl) {
            const id = inputEl.dataset.id;
            await updateField(id, 'category', inputEl.value);
            inputEl.classList.add('saved');
            setTimeout(() => inputEl.classList.remove('saved'), 300);
        }

        resultsDiv.addEventListener('click', function(e) {
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                selectCategory(item, input);
            }
        });

        // Save on blur
        input.addEventListener('blur', async function() {
            setTimeout(() => {
                resultsDiv.style.display = 'none';
            }, 200);
        });
    });

    // Account select - auto-save
    document.querySelectorAll('.edit-account').forEach(select => {
        select.addEventListener('change', async function() {
            const id = this.dataset.id;
            await updateField(id, 'account_id', this.value);
            this.classList.add('saved');
            setTimeout(() => this.classList.remove('saved'), 300);
        });
    });

    // Delete single item
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫?')) return;

            const id = this.dataset.id;
            try {
                const response = await fetch(`/expenses/delete/${id}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    this.closest('tr').remove();
                    updateTotalSum();
                }
            } catch (e) {
                console.error('Error:', e);
            }
        });
    });
});

async function updateField(id, field, value) {
    try {
        const data = {};
        data[field] = value;

        await fetch(`/expenses/update/${id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
    } catch (e) {
        console.error('Error updating field:', e);
    }
}

function updateTotalSum() {
    let total = 0;
    document.querySelectorAll('.edit-amount').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('total-sum').textContent = total.toLocaleString('ru-RU');
}
</script>
{% endblock %}
