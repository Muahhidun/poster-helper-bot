{% extends "base.html" %}

{% block title %}–ü–æ—Å—Ç–∞–≤–∫–∞ #{{ draft.id }} - PizzBurg{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <a href="{{ url_for('list_supplies') }}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <h1>–ü–æ—Å—Ç–∞–≤–∫–∞ #{{ draft.id }}</h1>
    </div>

    <div class="supply-info">
        <div class="info-row">
            <span class="label">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</span>
            <span class="value">{{ draft.supplier_name or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
        </div>
        <div class="info-row">
            <span class="label">–î–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π:</span>
            <span class="value">{{ draft.invoice_date or '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span>
        </div>
        <div class="info-row">
            <span class="label">–û–±—â–∞—è —Å—É–º–º–∞:</span>
            <span class="value amount">{{ "{:,.0f}".format(draft.total_sum or 0) }}‚Ç∏</span>
        </div>
        {% if draft.linked_expense_draft_id %}
        <div class="info-row">
            <span class="label">–°–≤—è–∑–∞–Ω–æ —Å —Ä–∞—Å—Ö–æ–¥–æ–º:</span>
            <span class="value"><span class="badge bg-success">üîó #{{ draft.linked_expense_draft_id }}</span></span>
        </div>
        {% endif %}
    </div>

    <h2>–¢–æ–≤–∞—Ä—ã ({{ draft['items']|length }})</h2>

    <div class="items-table">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ (OCR)</th>
                    <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç Poster</th>
                    <th>–ö–æ–ª-–≤–æ</th>
                    <th>–ï–¥.</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–°—É–º–º–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for item in draft['items'] %}
                <tr class="item-row {% if item.poster_ingredient_id %}matched{% else %}unmatched{% endif %}" data-item-id="{{ item.id }}">
                    <td>{{ loop.index }}</td>
                    <td class="item-name">{{ item.item_name }}</td>
                    <td class="ingredient-cell">
                        {% if item.poster_ingredient_id %}
                        <span class="matched-ingredient">‚úÖ {{ item.poster_ingredient_name }}</span>
                        {% else %}
                        <input type="text" class="ingredient-search" placeholder="–ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞..."
                               data-item-id="{{ item.id }}">
                        <div class="search-results" style="display: none;"></div>
                        {% endif %}
                    </td>
                    <td>
                        <input type="number" class="qty-input" value="{{ item.quantity }}" step="0.1" min="0"
                               data-item-id="{{ item.id }}">
                    </td>
                    <td>{{ item.unit }}</td>
                    <td>
                        <input type="number" class="price-input" value="{{ item.price_per_unit }}" step="1" min="0"
                               data-item-id="{{ item.id }}">
                    </td>
                    <td class="item-total">{{ "{:,.0f}".format(item.total or 0) }}‚Ç∏</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6" class="text-right"><strong>–ò—Ç–æ–≥–æ:</strong></td>
                    {% set items_total = namespace(sum=0) %}
                    {% for item in draft['items'] %}
                        {% set items_total.sum = items_total.sum + (item.total or 0) %}
                    {% endfor %}
                    <td class="amount" id="grand-total">{{ "{:,.0f}".format(items_total.sum) }}‚Ç∏</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="actions">
        <button type="button" class="btn btn-success btn-lg" id="process-supply" {% if draft['items']|selectattr('poster_ingredient_id', 'none')|list|length > 0 %}disabled{% endif %}>
            ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É –≤ Poster
        </button>
        <button type="button" class="btn btn-danger" id="delete-supply">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
        </button>
    </div>

    {% if draft['items']|selectattr('poster_ingredient_id', 'none')|list|length > 0 %}
    <div class="alert alert-warning">
        ‚ö†Ô∏è –ü—Ä–∏–≤—è–∂–∏—Ç–µ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º Poster –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Å—Ç–∞–≤–∫–∏.
        <br>
        –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ: {{ draft['items']|selectattr('poster_ingredient_id', 'none')|list|length }} –∏–∑ {{ draft['items']|length }} —Ç–æ–≤–∞—Ä–æ–≤
    </div>
    {% endif %}
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    margin-bottom: 20px;
}

.back-link {
    color: #007bff;
    text-decoration: none;
}

.back-link:hover {
    text-decoration: underline;
}

h1 {
    margin: 10px 0 20px;
}

h2 {
    margin: 30px 0 15px;
    font-size: 1.3em;
}

.supply-info {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.info-row {
    display: flex;
    margin-bottom: 10px;
}

.info-row:last-child {
    margin-bottom: 0;
}

.label {
    font-weight: 600;
    width: 180px;
    color: #666;
}

.value {
    flex: 1;
}

.amount {
    font-weight: 600;
    font-family: monospace;
    font-size: 1.1em;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.table th, .table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.table th {
    background: #f5f5f5;
    font-weight: 600;
}

.item-row.unmatched {
    background: #fff3cd;
}

.item-row.matched {
    background: #d4edda;
}

.item-name {
    max-width: 200px;
}

.ingredient-cell {
    position: relative;
    min-width: 250px;
}

.ingredient-search {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.search-result-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.search-result-item:hover, .search-result-item.active {
    background: #e3f2fd;
}

.search-result-item:last-child {
    border-bottom: none;
}

.text-muted {
    color: #6c757d;
}

.matched-ingredient {
    color: #28a745;
    font-weight: 500;
}

.qty-input, .price-input {
    width: 80px;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-align: right;
}

.text-right {
    text-align: right;
}

.actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.btn-lg {
    padding: 15px 30px;
    font-size: 16px;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:disabled {
    background: #94d3a2;
    cursor: not-allowed;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:hover:not(:disabled) {
    opacity: 0.9;
}

.alert {
    padding: 15px;
    border-radius: 5px;
    margin-top: 20px;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffc107;
    color: #856404;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.bg-success {
    background: #28a745;
    color: white;
}
</style>

<script>
// Items data for search
const items = {{ items|tojson }};
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    // Ingredient search with keyboard navigation
    document.querySelectorAll('.ingredient-search').forEach(input => {
        const itemId = input.dataset.itemId;
        const resultsDiv = input.nextElementSibling;
        let selectedIndex = -1;
        let currentMatches = [];

        input.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase().trim();
            selectedIndex = -1;

            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                currentMatches = items.filter(item =>
                    item.name.toLowerCase().includes(query)
                ).slice(0, 10);

                if (currentMatches.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                } else {
                    resultsDiv.innerHTML = currentMatches.map((item, i) =>
                        `<div class="search-result-item" data-id="${item.id}" data-name="${item.name}" data-index="${i}">
                            ${item.name} <small class="text-muted">(${item.type})</small>
                        </div>`
                    ).join('');
                }

                resultsDiv.style.display = 'block';
            }, 150);
        });

        // Keyboard navigation
        input.addEventListener('keydown', function(e) {
            const resultItems = resultsDiv.querySelectorAll('.search-result-item[data-id]');
            if (resultItems.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, resultItems.length - 1);
                updateSelection(resultItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                updateSelection(resultItems);
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                if (selectedIndex >= 0 && resultItems[selectedIndex]) {
                    e.preventDefault();
                    selectIngredient(resultItems[selectedIndex], input, itemId);
                } else if (resultItems.length === 1) {
                    e.preventDefault();
                    selectIngredient(resultItems[0], input, itemId);
                }
            } else if (e.key === 'Escape') {
                resultsDiv.style.display = 'none';
            }
        });

        function updateSelection(items) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === selectedIndex);
            });
            if (selectedIndex >= 0) {
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        async function selectIngredient(resultItem, inputEl, itemId) {
            const ingredientId = parseInt(resultItem.dataset.id);
            const ingredientName = resultItem.dataset.name;

            // Update on server
            const response = await fetch(`/supplies/update-item/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    poster_ingredient_id: ingredientId,
                    poster_ingredient_name: ingredientName
                })
            });

            if (response.ok) {
                // Update UI
                const cell = inputEl.parentElement;
                cell.innerHTML = `<span class="matched-ingredient">‚úÖ ${ingredientName}</span>`;

                // Update row class
                const row = cell.closest('tr');
                row.classList.remove('unmatched');
                row.classList.add('matched');

                // Move to next unmatched input
                const nextUnmatched = document.querySelector('.item-row.unmatched .ingredient-search');
                if (nextUnmatched) {
                    nextUnmatched.focus();
                }

                // Check if all items are matched
                checkAllMatched();
            }
        }

        // Handle click selection
        resultsDiv.addEventListener('click', function(e) {
            const resultItem = e.target.closest('.search-result-item');
            if (!resultItem || !resultItem.dataset.id) return;
            selectIngredient(resultItem, input, itemId);
        });

        // Hide results on outside click
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    });

    // Quantity/price updates
    document.querySelectorAll('.qty-input, .price-input').forEach(input => {
        input.addEventListener('change', async function() {
            const itemId = this.dataset.itemId;
            const row = this.closest('tr');
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const total = qty * price;

            // Update total in UI
            row.querySelector('.item-total').textContent = total.toLocaleString('ru-RU') + '‚Ç∏';

            // Update on server
            await fetch(`/supplies/update-item/${itemId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    quantity: qty,
                    price_per_unit: price
                })
            });

            // Update grand total
            updateGrandTotal();
        });
    });

    // Process supply
    document.getElementById('process-supply').addEventListener('click', async function() {
        if (this.disabled) return;

        if (!confirm('–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É –≤ Poster?')) return;

        this.disabled = true;
        this.textContent = '‚è≥ –°–æ–∑–¥–∞—é...';

        try {
            const response = await fetch('/supplies/process/{{ draft.id }}', {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                alert('‚úÖ –ü–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ Poster!\nID: ' + result.supply_id);
                window.location.href = '/supplies';
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
                this.disabled = false;
                this.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É –≤ Poster';
            }
        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
            this.disabled = false;
            this.textContent = '‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É –≤ Poster';
        }
    });

    // Delete supply
    document.getElementById('delete-supply').addEventListener('click', async function() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ—Å—Ç–∞–≤–∫–∏?')) return;

        const response = await fetch('/supplies/delete/{{ draft.id }}', {
            method: 'POST'
        });

        if (response.ok) {
            window.location.href = '/supplies';
        }
    });
});

function checkAllMatched() {
    const unmatched = document.querySelectorAll('.item-row.unmatched').length;
    const processBtn = document.getElementById('process-supply');

    if (unmatched === 0) {
        processBtn.disabled = false;
    }
}

function updateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.item-total').forEach(cell => {
        const value = parseFloat(cell.textContent.replace(/[^\d]/g, '')) || 0;
        total += value;
    });
    document.getElementById('grand-total').textContent = total.toLocaleString('ru-RU') + '‚Ç∏';
}
</script>
{% endblock %}
